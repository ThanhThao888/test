<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance Calculators</title>
    <style>
      :root {
        --indigo-50: #eef2ff;
        --indigo-100: #e0e7ff;
        --indigo-500: #6366f1;
        --indigo-600: #4f46e5;
        --indigo-700: #4338ca;
        --blue-50: #eff6ff;
        --blue-100: #dbeafe;
        --blue-500: #3b82f6;
        --blue-600: #2563eb;
        --blue-700: #1d4ed8;
        --cyan-50: #ecfeff;
        --cyan-100: #cffafe;
        --cyan-500: #06b6d4;
        --cyan-600: #0891b2;
        --green-50: #f0fdf4;
        --green-100: #dcfce7;
        --green-500: #10b981;
        --green-600: #059669;
        --emerald-50: #ecfdf5;
        --emerald-100: #d1fae5;
        --emerald-500: #059669;
        --emerald-600: #047857;
        --rose-50: #fff1f2;
        --rose-100: #ffe4e6;
        --rose-500: #f43f5e;
        --rose-600: #e11d48;
        --pink-50: #fdf2f8;
        --pink-100: #fce7f3;
        --pink-500: #ec4899;
        --pink-600: #db2777;
        --orange-50: #fff7ed;
        --orange-100: #ffedd5;
        --orange-500: #f97316;
        --orange-600: #ea580c;
        --red-50: #fef2f2;
        --red-100: #fee2e2;
        --red-500: #ef4444;
        --red-600: #dc2626;
        --purple-50: #faf5ff;
        --purple-100: #f3e8ff;
        --purple-500: #a855f7;
        --purple-600: #9333ea;
        --slate-50: #f8fafc;
        --slate-100: #f1f5f9;
        --slate-200: #e2e8f0;
        --slate-300: #cbd5e1;
        --slate-400: #94a3b8;
        --slate-500: #64748b;
        --slate-600: #475569;
        --slate-700: #334155;
        --slate-800: #1e293b;
        --white: #ffffff;
        --black: #000000;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, var(--slate-50), var(--indigo-100));
        min-height: 100vh;
        padding: 20px;
        color: var(--slate-700);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header */
      .header {
        background: var(--white);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-bottom: 1px solid var(--slate-200);
        padding: 1rem 0;
        margin-bottom: 2rem;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(
          to right,
          var(--indigo-600),
          var(--blue-600)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .tier-selector {
        display: flex;
        background: var(--slate-100);
        border-radius: 0.5rem;
        padding: 0.25rem;
      }

      .tier-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .tier-btn.active {
        background: var(--white);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      /* Tabs */
      .tabs {
        display: flex;
        background: var(--white);
        border-radius: 0.75rem;
        padding: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 2rem;
        overflow-x: auto;
      }

      .tab-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        background: var(--slate-100);
      }

      .tab-btn.active {
        background: var(--indigo-50);
        color: var(--indigo-600);
        font-weight: 600;
      }

      /* Calculator Container */
      .calculator-container {
        background: var(--white);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .calculator-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--slate-700);
      }

      /* Explanation Box */
      .explanation-box {
        background: var(--slate-50);
        border-left: 4px solid var(--indigo-500);
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .explanation-title {
        font-weight: 600;
        color: var(--slate-800);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .explanation-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--indigo-500);
      }

      .explanation-text {
        color: var(--slate-600);
        line-height: 1.5;
        margin-bottom: 0.75rem;
      }

      .explanation-note {
        background: var(--blue-50);
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.75rem;
        font-size: 0.875rem;
        border-left: 3px solid var(--blue-500);
      }

      .explanation-note strong {
        color: var(--blue-700);
      }

      /* Form Grid */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--slate-700);
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--slate-200);
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--indigo-500);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--slate-200);
        border-radius: 0.5rem;
        font-size: 1rem;
        background-color: var(--white);
        transition: all 0.2s;
      }

      .form-select:focus {
        outline: none;
        border-color: var(--indigo-500);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      /* Buttons */
      .btn {
        width: 100%;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        color: var(--white);
      }

      .btn-primary {
        background: linear-gradient(
          to right,
          var(--indigo-600),
          var(--blue-700)
        );
      }

      .btn-primary:hover {
        background: linear-gradient(
          to right,
          var(--indigo-700),
          var(--blue-700)
        );
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-secondary {
        background: linear-gradient(to right, var(--blue-500), var(--cyan-600));
      }

      .btn-secondary:hover {
        background: linear-gradient(to right, var(--blue-600), var(--cyan-600));
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-success {
        background: linear-gradient(
          to right,
          var(--green-500),
          var(--emerald-600)
        );
      }

      .btn-success:hover {
        background: linear-gradient(
          to right,
          var(--green-600),
          var(--emerald-600)
        );
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-danger {
        background: linear-gradient(to right, var(--rose-500), var(--pink-600));
      }

      .btn-danger:hover {
        background: linear-gradient(to right, var(--rose-600), var(--pink-600));
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-warning {
        background: linear-gradient(
          to right,
          var(--orange-500),
          var(--red-600)
        );
      }

      .btn-warning:hover {
        background: linear-gradient(
          to right,
          var(--orange-600),
          var(--red-600)
        );
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      /* Results */
      .results-container {
        margin-top: 2rem;
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .result-card {
        text-align: center;
        padding: 1rem;
        border-radius: 0.5rem;
      }

      .result-label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .result-value {
        font-size: 1.25rem;
        font-weight: 700;
      }

      .result-error {
        font-size: 0.9rem;
        color: var(--red-600);
        font-weight: 500;
      }

      /* Cash Flows */
      .cash-flows-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .cash-flow-input {
        padding: 0.5rem;
        border: 1px solid var(--slate-200);
        border-radius: 0.375rem;
        font-size: 0.875rem;
      }

      /* Options */
      .options-toggle {
        display: flex;
        background: var(--slate-100);
        border-radius: 0.5rem;
        padding: 0.25rem;
        margin-bottom: 1.5rem;
        width: fit-content;
      }

      .option-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .option-btn.active {
        background: var(--white);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      /* Hidden Class */
      .hidden {
        display: none;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 1rem;
        }

        .calculator-container {
          padding: 1.5rem;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Scenario Buttons */
      .scenario-btn {
        padding: 1rem;
        border-radius: 0.5rem;
        border: 2px solid var(--slate-200);
        background: var(--white);
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
        text-align: center;
        font-size: 0.875rem;
      }

      .scenario-btn:hover {
        border-color: var(--indigo-400);
        background: var(--indigo-50);
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .scenario-btn.active {
        border-color: var(--indigo-600);
        background: linear-gradient(135deg, var(--indigo-100), var(--blue-100));
        color: var(--indigo-900);
        box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <div class="logo">Finance Calculators</div>
          <div class="tier-selector">
            <button class="tier-btn active" data-tier="basic">Basic</button>
            <button class="tier-btn" data-tier="intermediate">
              Intermediate
            </button>
            <button class="tier-btn" data-tier="advanced">Advanced</button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabsContainer">
        <!-- Tabs will be populated by JavaScript -->
      </div>

      <!-- Calculator Container -->
      <div class="calculator-container">
        <div id="calculatorContent">
          <!-- Calculator content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // --- Data Structure ---
      const calculators = {
        basic: [
          {
            id: "pv-fv",
            name: "PV/FV Calculator",
            component: "PVFVCalculator",
          },
          {
            id: "compound-interest",
            name: "Compound Interest",
            component: "CompoundInterestCalculator",
          },
          {
            id: "loan-payment",
            name: "Loan Payment",
            component: "LoanPaymentCalculator",
          },
        ],
        intermediate: [
          {
            id: "capm",
            name: "CAPM",
            component: "CAPMCalculator",
          },
          {
            id: "ccpo",
            name: "Credit Card Optimizer",
            component: "CCPOCalculator",
          },
          {
            id: "bond-pricing",
            name: "Bond Pricing",
            component: "BondPricingCalculator",
          },
          {
            id: "npv-irr",
            name: "NPV & IRR",
            component: "NPVIRRCalculator",
          },
          {
            id: "time-money",
            name: "Time vs Money Trade-Off",
            component: "TimeMoneyCalculator",
          },
        ],
        advanced: [
          {
            id: "black-scholes",
            name: "Black-Scholes",
            component: "BlackScholesCalculator",
          },
          {
            id: "wacc",
            name: "WACC",
            component: "WACCCalculator",
          },
          {
            id: "dcf",
            name: "DCF Valuation",
            component: "DCFCalculator",
          },
          {
            id: "lbo",
            name: "LBO Model",
            component: "LBOCalculator",
          },
        ],
      };

      // --- State Management ---
      let activeTier = "basic";
      let activeTab = "pv-fv";

      // --- DOM Elements ---
      const tabsContainer = document.getElementById("tabsContainer");
      const calculatorContent = document.getElementById("calculatorContent");
      const tierButtons = document.querySelectorAll(".tier-btn");

      // --- Initialize App ---
      function initApp() {
        renderTabs();
        renderCalculator();
        setupEventListeners();
      }

      // --- Event Listeners ---
      function setupEventListeners() {
        // Tier selection
        tierButtons.forEach((button) => {
          button.addEventListener("click", () => {
            tierButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
            activeTier = button.dataset.tier;

            // Switch to first calculator of new tier
            const firstCalculator = calculators[activeTier][0];
            if (firstCalculator) {
              activeTab = firstCalculator.id;
            }

            renderTabs();
            renderCalculator();
          });
        });
      }

      // --- Render Tabs ---
      function renderTabs() {
        tabsContainer.innerHTML = "";
        const tierCalculators = calculators[activeTier];

        tierCalculators.forEach((calc) => {
          const tabButton = document.createElement("button");
          tabButton.className = `tab-btn ${
            calc.id === activeTab ? "active" : ""
          }`;
          tabButton.textContent = calc.name;
          tabButton.onclick = () => {
            activeTab = calc.id;
            renderTabs();
            renderCalculator();
          };
          tabsContainer.appendChild(tabButton);
        });
      }

      // --- Render Calculator ---
      function renderCalculator() {
        const calculator = calculators[activeTier].find(
          (c) => c.id === activeTab
        );
        if (!calculator) return;

        switch (calculator.component) {
          case "PVFVCalculator":
            calculatorContent.innerHTML = renderPVFVCalculator();
            setupPVFVCalculator();
            break;
          case "CompoundInterestCalculator":
            calculatorContent.innerHTML = renderCompoundInterestCalculator();
            setupCompoundInterestCalculator();
            break;
          case "LoanPaymentCalculator":
            calculatorContent.innerHTML = renderLoanPaymentCalculator();
            setupLoanPaymentCalculator();
            break;
          case "CAPMCalculator":
            calculatorContent.innerHTML = renderCAPMCalculator();
            setupCAPMCalculator();
            break;
          case "CCPOCalculator":
            calculatorContent.innerHTML = renderCCPOCalculator();
            setupCCPOCalculator();
            break;
          case "TimeMoneyCalculator":
            calculatorContent.innerHTML = renderTimeMoneyCalculator();
            setupTimeMoneyCalculator();
            break;
          case "BondPricingCalculator":
            calculatorContent.innerHTML = renderBondPricingCalculator();
            setupBondPricingCalculator();
            break;
          case "NPVIRRCalculator":
            calculatorContent.innerHTML = renderNPVIRRCalculator();
            setupNPVIRRCalculator();
            break;
          case "BlackScholesCalculator":
            calculatorContent.innerHTML = renderBlackScholesCalculator();
            setupBlackScholesCalculator();
            break;
          case "WACCCalculator":
            calculatorContent.innerHTML = renderWACCCalculator();
            setupWACCCalculator();
            break;
          case "DCFCalculator":
            calculatorContent.innerHTML = renderDCFCalculator();
            setupDCFCalculator();
            break;
          case "LBOCalculator":
            calculatorContent.innerHTML = renderLBOCalculator();
            setupLBOCalculator();
            break;
          default:
            calculatorContent.innerHTML = "<p>Calculator not found</p>";
        }
      }

      // ==================== BASIC CALCULATORS ====================

      // --- PV/FV Calculator ---
      function renderPVFVCalculator() {
        return `
                      <h2 class="calculator-title">Giá trị Hiện tại (Present Value – PV) / Giá trị Tương lai (Future Value – FV)</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Hiểu về PV và FV
                          </div>
                          <p class="explanation-text">
                              <strong>Giá trị hiện tại (PV)</strong> là giá trị của một khoản tiền sẽ nhận được trong tương lai, quy đổi về thời điểm hiện tại dựa trên một mức lãi suất nhất định.
                              <strong>Giá trị tương lai (FV)</strong> là giá trị của một khoản tiền hiện có tại một thời điểm trong tương lai, dựa trên tốc độ tăng trưởng giả định.
                          </p>
                          <p class="explanation-text">
                              Các khái niệm này là nền tảng trong tài chính để đánh giá khoản đầu tư, so sánh các dòng tiền tại những thời điểm khác nhau và đưa ra quyết định tài chính chính xác.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Tiền nhận được hôm nay luôn có giá trị cao hơn cùng một khoản tiền trong tương lai, vì nó có thể được đem đi đầu tư và tạo ra lợi nhuận (time value of money).
                          </div>
                      </div>
                      <div class="options-toggle">
                          <button class="option-btn active" id="pvOption">Calculate PV</button>
                          <button class="option-btn" id="fvOption">Calculate FV</button>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Giá trị Tương lai ($)</label>
                              <input type="number" id="futureValue" class="form-input" placeholder="10000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Lãi suất (%)</label>
                              <input type="number" id="interestRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Số kỳ</label>
                              <input type="number" id="periods" class="form-input" placeholder="10">
                          </div>
                      </div>
                      <button class="btn btn-primary" id="calculatePVFV">Calculate</button>
                      <div id="pvfvResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupPVFVCalculator() {
        const pvOption = document.getElementById("pvOption");
        const fvOption = document.getElementById("fvOption");
        const futureValueInput = document.getElementById("futureValue");
        const interestRateInput = document.getElementById("interestRate");
        const periodsInput = document.getElementById("periods");
        const calculateBtn = document.getElementById("calculatePVFV");
        const resultsDiv = document.getElementById("pvfvResults");

        let isPVCalculation = true;

        pvOption.addEventListener("click", () => {
          pvOption.classList.add("active");
          fvOption.classList.remove("active");
          isPVCalculation = true;
          // Swap labels
          document.querySelectorAll(".form-label")[0].textContent =
            "Giá trị Tương lai ($)";
          futureValueInput.placeholder = "10000";
        });

        fvOption.addEventListener("click", () => {
          fvOption.classList.add("active");
          pvOption.classList.remove("active");
          isPVCalculation = false;
          // Swap labels
          document.querySelectorAll(".form-label")[0].textContent =
            "Present Value ($)";
          futureValueInput.placeholder = "5000";
        });

        calculateBtn.addEventListener("click", () => {
          const r = parseFloat(interestRateInput.value) / 100;
          const n = parseFloat(periodsInput.value);

          if (isNaN(r) || isNaN(n) || r < 0 || n < 0) {
            alert(
              "Vui lòng nhập các số dương hợp lệ cho lãi suất và số kỳ."
            );
            return;
          }

          if (isPVCalculation) {
            const fv = parseFloat(futureValueInput.value);
            if (isNaN(fv)) {
              alert("Vui lòng nhập giá trị tương lai hợp lệ.");
              return;
            }
            const pv = fv / Math.pow(1 + r, n);
            resultsDiv.innerHTML = `
                              <div class="results-grid">
                                  <div class="result-card" style="background-color: var(--indigo-100);">
                                      <div class="result-label">Giá trị Hiện tại</div>
                                      <div class="result-value">$${pv.toFixed(
                                        2
                                      )}</div>
                                  </div>
                                  <div class="result-card" style="background-color: var(--slate-100);">
                                      <div class="result-label">Giá trị Tương lai</div>
                                      <div class="result-value">$${fv.toFixed(
                                        2
                                      )}</div>
                                  </div>
                                  <div class="result-card" style="background-color: var(--slate-100);">
                                      <div class="result-label">Lãi suất</div>
                                      <div class="result-value">${(
                                        r * 100
                                      ).toFixed(2)}%</div>
                                  </div>
                                  <div class="result-card" style="background-color: var(--slate-100);">
                                      <div class="result-label">Số kỳ</div>
                                      <div class="result-value">${n}</div>
                                  </div>
                              </div>
                          `;
          } else {
            const pv = parseFloat(futureValueInput.value);
            if (isNaN(pv)) {
              alert("Vui lòng nhập giá trị hiện tại hợp lệ.");
              return;
            }
            const fv = pv * Math.pow(1 + r, n);
            resultsDiv.innerHTML = `
                              <div class="results-grid">
                                  <div class="result-card" style="background-color: var(--slate-100);">
                                      <div class="result-label">Giá trị Hiện tại</div>
                                      <div class="result-value">$${pv.toFixed(
                                        2
                                      )}</div>
                                  </div>
                                  <div class="result-card" style="background-color: var(--indigo-100);">
                                      <div class="result-label">Giá trị Tương lai</div>
                                      <div class="result-value">$${fv.toFixed(
                                        2
                                      )}</div>
                                  </div>
                                  <div class="result-card" style="background-color: var(--slate-100);">
                                      <div class="result-label">Lãi suất</div>
                                      <div class="result-value">${(
                                        r * 100
                                      ).toFixed(2)}%</div>
                                  </div>
                                  <div class="result-card" style="background-color: var(--slate-100);">
                                      <div class="result-label">Số kỳ</div>
                                      <div class="result-value">${n}</div>
                                  </div>
                              </div>
                          `;
          }

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- Compound Interest Calculator ---
      function renderCompoundInterestCalculator() {
        return `
                      <h2 class="calculator-title">Máy tính Lãi kép</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Sức mạnh của Lãi kép
                          </div>
                          <p class="explanation-text">
                              <strong>Lãi kép</strong> là khoản lãi được tính dựa trên số tiền gốc ban đầu và phần lãi đã tích lũy từ các kỳ trước.
                              Đây thường được gọi là “lãi mẹ đẻ lãi con”, giúp tài sản tăng trưởng theo cấp số nhân theo thời gian.
                          </p>
                          <p class="explanation-text">
                              Tần suất ghép lãi càng cao thì lợi nhuận càng lớn. Công cụ này giúp bạn hình dung cách các mức tần suất ghép lãi khác nhau ảnh hưởng đến tốc độ tăng trưởng khoản đầu tư.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Bắt đầu sớm và để khoản đầu tư của bạn tích lũy lãi kép trong thời gian dài là một trong những chiến lược xây dựng tài sản mạnh mẽ nhất.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Số tiền gốc ($)</label>
                              <input type="number" id="principal" class="form-input" placeholder="10000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Lãi suất hằng năm (%)</label>
                              <input type="number" id="annualRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Số năm</label>
                              <input type="number" id="years" class="form-input" placeholder="10">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Tần suất ghép lãi</label>
                              <select id="compounding" class="form-select">
                                  <option value="1">Annually</option>
                                  <option value="2">Semi-annually</option>
                                  <option value="4">Quarterly</option>
                                  <option value="12">Monthly</option>
                                  <option value="365">Daily</option>
                              </select>
                          </div>
                      </div>
                      <button class="btn btn-success" id="calculateCI">Tính Lãi Kép</button>
                      <div id="ciResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupCompoundInterestCalculator() {
        const calculateBtn = document.getElementById("calculateCI");
        const resultsDiv = document.getElementById("ciResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(
            document.getElementById("principal").value
          );
          const annualRate =
            parseFloat(document.getElementById("annualRate").value) / 100;
          const years = parseFloat(document.getElementById("years").value);
          const compounding = parseFloat(
            document.getElementById("compounding").value
          );

          if (
            isNaN(principal) ||
            isNaN(annualRate) ||
            isNaN(years) ||
            isNaN(compounding) ||
            principal < 0 ||
            annualRate < 0 ||
            years < 0 ||
            compounding <= 0
          ) {
            alert("Vui lòng nhập các số dương hợp lệ.");
            return;
          }

          const finalAmount =
            principal *
            Math.pow(1 + annualRate / compounding, compounding * years);
          const interestEarned = finalAmount - principal;

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--green-100);">
                                  <div class="result-label">Final Amount</div>
                                  <div class="result-value">$${finalAmount.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Principal</div>
                                  <div class="result-value">$${principal.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Interest Earned</div>
                                  <div class="result-value">$${interestEarned.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Annual Rate</div>
                                  <div class="result-value">${(
                                    annualRate * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- Loan Payment Calculator ---
      function renderLoanPaymentCalculator() {
        return `
                      <h2 class="calculator-title">Máy tính Khoản vay</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Hiểu về Khấu hao khoản vay
                          </div>
                          <p class="explanation-text">
                              Công cụ này giúp bạn xác định khoản thanh toán hằng tháng và hiểu tổng số tiền lãi phải trả trong suốt thời hạn vay.
                              Công cụ sử dụng công thức khấu hao tiêu chuẩn cho các khoản vay lãi suất cố định.
                          </p>
                          <p class="explanation-text">
                              Trong những năm đầu của khoản vay, phần lớn số tiền thanh toán hàng tháng được dùng để trả lãi hơn là trả gốc.
                              Khi khoản vay dần đến cuối kỳ, tỷ lệ này sẽ đảo ngược.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Chỉ cần giảm nhẹ lãi suất hoặc rút ngắn thời hạn vay cũng có thể giúp bạn tiết kiệm hàng nghìn $ tiền lãi.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Số tiền vay ($)</label>
                              <input type="number" id="loanAmount" class="form-input" placeholder="10000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Lãi suất hằng năm (%)</label>
                              <input type="number" id="loanRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Thời hạn vay (năm)</label>
                              <input type="number" id="loanTerm" class="form-input" placeholder="10">
                          </div>
                      </div>
                      <button class="btn btn-secondary" id="calculateLoan">Tính Khoản Thanh Toán</button>
                      <div id="loanResults" class="results-container hidden" style="border-color: var(--blue-100); background-color: var(--blue-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupLoanPaymentCalculator() {
        const calculateBtn = document.getElementById("calculateLoan");
        const resultsDiv = document.getElementById("loanResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(
            document.getElementById("loanAmount").value
          );
          const annualRate =
            parseFloat(document.getElementById("loanRate").value) / 100;
          const years = parseFloat(document.getElementById("loanTerm").value);

          if (
            isNaN(principal) ||
            isNaN(annualRate) ||
            isNaN(years) ||
            principal < 0 ||
            annualRate < 0 ||
            years < 0
          ) {
            alert("Vui lòng nhập các số dương hợp lệ.");
            return;
          }

          const monthlyRate = annualRate / 12;
          const numberOfPayments = years * 12;
          const monthlyPayment =
            (principal * monthlyRate) /
            (1 - Math.pow(1 + monthlyRate, -numberOfPayments));
          const totalPayment = monthlyPayment * numberOfPayments;
          const totalInterest = totalPayment - principal;

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--blue-100);">
                                  <div class="result-label">Monthly Payment</div>
                                  <div class="result-value">$${monthlyPayment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Total Payment</div>
                                  <div class="result-value">$${totalPayment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Total Interest</div>
                                  <div class="result-value">$${totalInterest.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Loan Term</div>
                                  <div class="result-value">${years} years</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // ==================== INTERMEDIATE CALCULATORS ====================
      // --- CAPM Calculator ---
      function renderCAPMCalculator() {
        return `
                      <h2 class="calculator-title">Mô hình Định giá Tài sản Vốn (CAPM)</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Mối quan hệ giữa Rủi ro và Lợi nhuận
                          </div>
                          <p class="explanation-text">
                              The <strong>Mô hình Định giá Tài sản Vốn (CAPM)</strong> mô tả mối quan hệ giữa rủi ro hệ thống và lợi nhuận kỳ vọng của tài sản, đặc biệt là cổ phiếu.
                              Nó được sử dụng rộng rãi trong tài chính để định giá các chứng khoán rủi ro và tính lợi nhuận kỳ vọng dựa trên mức rủi ro của tài sản.
                          </p>
                          <p class="explanation-text">
                              <strong>Beta (β)</strong> đo lường mức biến động của cổ phiếu so với thị trường chung. Beta = 1 → cổ phiếu biến động theo thị trường,
                              Beta > 1 → cổ phiếu biến động mạnh hơn thị trường.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> CAPM chỉ ra rằng nhà đầu tư cần được bù đắp theo hai cách: giá trị thời gian của tiền (lãi suất phi rủi ro) và rủi ro (phần bù rủi ro thị trường). Mô hình này giúp xác định xem một cổ phiếu có được định giá hợp lý dựa trên hồ sơ rủi ro của nó hay không.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Lãi suất phi rủi ro (%)</label>
                              <input type="number" id="riskFreeRate" class="form-input" placeholder="3" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Beta (β)</label>
                              <input type="number" id="beta" class="form-input" placeholder="1.2" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Lợi nhuận thị trường (%)</label>
                              <input type="number" id="marketReturn" class="form-input" placeholder="8" step="0.01">
                          </div>
                      </div>
                      <button class="btn btn-primary" id="calculateCAPM">Tính Lợi nhuận Kỳ vọng (CAPM)</button>
                      <div id="capmResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupCAPMCalculator() {
        const calculateBtn = document.getElementById("calculateCAPM");
        const resultsDiv = document.getElementById("capmResults");

        calculateBtn.addEventListener("click", () => {
          const rf =
            parseFloat(document.getElementById("riskFreeRate").value) / 100;
          const beta = parseFloat(document.getElementById("beta").value);
          const rm =
            parseFloat(document.getElementById("marketReturn").value) / 100;

          if (isNaN(rf) || isNaN(beta) || isNaN(rm)) {
            alert("Vui lòng nhập các số hợp lệ.");
            return;
          }

          const marketRiskPremium = rm - rf;
          const riskPremium = beta * marketRiskPremium;
          const expectedReturn = rf + riskPremium;

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--indigo-100);">
                                  <div class="result-label">Lợi nhuận Kỳ vọng</div>
                                  <div class="result-value">${(
                                    expectedReturn * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Lãi suất phi rủi ro</div>
                                  <div class="result-value">${(
                                    rf * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Phần bù rủi ro thị trường</div>
                                  <div class="result-value">${(
                                    marketRiskPremium * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Phần bù rủi ro</div>
                                  <div class="result-value">${(
                                    riskPremium * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- Bond Pricing Calculator ---
      function renderBondPricingCalculator() {
        return `
                      <h2 class="calculator-title">Bond Pricing Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Fixed Income Valuation
                          </div>
                          <p class="explanation-text">
                              This calculator determines the fair value of a bond based on its coupon rate, yield to maturity, and time to maturity.
                              Bond prices move inversely to interest rates - when rates rise, bond prices fall, and vice versa.
                          </p>
                          <p class="explanation-text">
                              <strong>Yield to Maturity (YTM)</strong> is the total return anticipated on a bond if it is held until it matures.
                              When YTM equals the coupon rate, the bond trades at par (face value). When YTM is higher than the coupon rate, the bond trades at a discount.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Bond duration measures sensitivity to interest rate changes. Longer-term bonds are more sensitive to rate changes than shorter-term bonds.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Face Value ($)</label>
                              <input type="number" id="faceValue" class="form-input" placeholder="1000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Coupon Rate (%)</label>
                              <input type="number" id="couponRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Yield to Maturity (%)</label>
                              <input type="number" id="ytm" class="form-input" placeholder="6" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Years to Maturity</label>
                              <input type="number" id="yearsToMaturity" class="form-input" placeholder="10">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Payment Frequency</label>
                              <select id="frequency" class="form-select">
                                  <option value="1">Annual</option>
                                  <option value="2" selected>Semi-annual</option>
                              </select>
                          </div>
                      </div>
                      <button class="btn btn-warning" id="calculateBond">Calculate Bond Price</button>
                      <div id="bondResults" class="results-container hidden" style="border-color: var(--orange-100); background-color: var(--orange-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupBondPricingCalculator() {
        const calculateBtn = document.getElementById("calculateBond");
        const resultsDiv = document.getElementById("bondResults");

        calculateBtn.addEventListener("click", () => {
          const faceValue = parseFloat(
            document.getElementById("faceValue").value
          );
          const couponRate =
            parseFloat(document.getElementById("couponRate").value) / 100;
          const ytm = parseFloat(document.getElementById("ytm").value) / 100;
          const yearsToMaturity = parseFloat(
            document.getElementById("yearsToMaturity").value
          );
          const frequency = parseFloat(
            document.getElementById("frequency").value
          );

          if (
            isNaN(faceValue) ||
            isNaN(couponRate) ||
            isNaN(ytm) ||
            isNaN(yearsToMaturity) ||
            isNaN(frequency) ||
            faceValue < 0 ||
            couponRate < 0 ||
            ytm < 0 ||
            yearsToMaturity < 0 ||
            (frequency !== 1 && frequency !== 2)
          ) {
            alert("Vui lòng nhập các số dương hợp lệ.");
            return;
          }

          const couponPayment = (faceValue * couponRate) / frequency;
          const periods = yearsToMaturity * frequency;
          const periodicYield = ytm / frequency;

          let bondPrice = 0;
          for (let t = 1; t <= periods; t++) {
            bondPrice += couponPayment / Math.pow(1 + periodicYield, t);
          }
          bondPrice += faceValue / Math.pow(1 + periodicYield, periods);

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--orange-100);">
                                  <div class="result-label">Bond Price</div>
                                  <div class="result-value">$${bondPrice.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Face Value</div>
                                  <div class="result-value">$${faceValue.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Coupon Payment</div>
                                  <div class="result-value">$${couponPayment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Yield to Maturity</div>
                                  <div class="result-value">${(
                                    ytm * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- NPV & IRR Calculator ---
      function renderNPVIRRCalculator() {
        return `
                      <h2 class="calculator-title">NPV & IRR Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Capital Budgeting Decisions
                          </div>
                          <p class="explanation-text">
                              <strong>Net Present Value (NPV)</strong> measures the profitability of a project by calculating the difference between the present value of cash inflows and outflows.
                              A positive NPV indicates the project should be profitable.
                          </p>
                          <p class="explanation-text">
                              <strong>Internal Rate of Return (IRR)</strong> is the discount rate that makes the NPV of all cash flows equal to zero.
                              It represents the expected compound annual rate of return that will be earned on a project.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> When evaluating mutually exclusive projects, NPV is generally preferred over IRR as it directly measures the value added to the firm. The IRR can be misleading when comparing projects of different sizes or durations.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Initial Investment ($)</label>
                              <input type="number" id="initialInvestment" class="form-input" placeholder="100000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Discount Rate (%)</label>
                              <input type="number" id="discountRate" class="form-input" placeholder="10" step="0.1">
                          </div>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Cash Flows by Year ($)</label>
                          <div class="cash-flows-grid" id="cashFlowsContainer">
                              <!-- Cash flows will be populated by JavaScript -->
                          </div>
                      </div>
                      <button class="btn btn-danger" id="calculateNPV">Calculate NPV & IRR</button>
                      <div id="npvResults" class="results-container hidden" style="border-color: var(--rose-100); background-color: var(--rose-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      // Fixed IRR calculation function
      function calculateIRR(cashFlows, initialInvestment, initialGuess = 0.1) {
        const maxIterations = 1000;
        const tolerance = 1e-7;
        let irr = initialGuess;

        // Validate cash flows first
        const hasPositive = cashFlows.some((cf) => cf > 0);
        const hasNegative = cashFlows.some((cf) => cf < 0);

        if (!hasPositive || !hasNegative) {
          return {
            success: false,
            message: "Need both positive and negative cash flows",
          };
        }

        for (let i = 0; i < maxIterations; i++) {
          let npv = -Math.abs(initialInvestment);
          let derivative = 0;

          for (let t = 0; t < cashFlows.length; t++) {
            const period = t + 1;
            const denominator = Math.pow(1 + irr, period);
            npv += cashFlows[t] / denominator;
            derivative -= (period * cashFlows[t]) / (denominator * (1 + irr));
          }

          // Check if derivative is too small (avoid division by zero)
          if (Math.abs(derivative) < 1e-10) {
            return {
              success: false,
              message: "IRR calculation failed - derivative too small",
            };
          }

          const delta = npv / derivative;
          irr -= delta;

          // Prevent IRR from going to unrealistic values
          if (irr < -0.99) irr = -0.99; // Minimum -99%
          if (irr > 10) irr = 10; // Maximum 1000%

          if (Math.abs(delta) < tolerance) {
            return { success: true, irr: irr };
          }
        }

        return {
          success: false,
          message: "IRR did not converge - may have multiple solutions",
        };
      }

      function setupNPVIRRCalculator() {
        const cashFlowsContainer =
          document.getElementById("cashFlowsContainer");
        const calculateBtn = document.getElementById("calculateNPV");
        const resultsDiv = document.getElementById("npvResults");

        // Create 5 cash flow inputs
        for (let i = 1; i <= 5; i++) {
          const div = document.createElement("div");
          div.innerHTML = `
                          <label class="form-label">Year ${i}</label>
                          <input type="number" class="form-input cash-flow-input" id="cf${i}" placeholder="25000">
                      `;
          cashFlowsContainer.appendChild(div);
        }

        calculateBtn.addEventListener("click", () => {
          const initialInvestment = parseFloat(
            document.getElementById("initialInvestment").value
          );
          const discountRate =
            parseFloat(document.getElementById("discountRate").value) / 100;

          if (isNaN(initialInvestment) || isNaN(discountRate)) {
            alert(
              "Please enter valid numbers for initial investment and discount rate."
            );
            return;
          }

          // Get cash flows
          const cashFlows = [];
          for (let i = 1; i <= 5; i++) {
            const cf = parseFloat(document.getElementById(`cf${i}`).value);
            if (isNaN(cf)) {
              alert(`Please enter a valid number for Year ${i} cash flow.`);
              return;
            }
            cashFlows.push(cf);
          }

          // Calculate NPV
          let npv = -initialInvestment;
          for (let i = 0; i < cashFlows.length; i++) {
            npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
          }

          // Calculate IRR using the fixed function
          const irrResult = calculateIRR(cashFlows, initialInvestment);

          if (!irrResult.success) {
            resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--rose-100);">
                                  <div class="result-label">NPV</div>
                                  <div class="result-value">$${npv.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--orange-100);">
                                  <div class="result-label">IRR</div>
                                  <div class="result-error">${
                                    irrResult.message
                                  }</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Initial Investment</div>
                                  <div class="result-value">$${initialInvestment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Discount Rate</div>
                                  <div class="result-value">${(
                                    discountRate * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;
          } else {
            const irr = irrResult.irr;
            resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--rose-100);">
                                  <div class="result-label">NPV</div>
                                  <div class="result-value">$${npv.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--pink-100);">
                                  <div class="result-label">IRR</div>
                                  <div class="result-value">${(
                                    irr * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Initial Investment</div>
                                  <div class="result-value">$${initialInvestment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Discount Rate</div>
                                  <div class="result-value">${(
                                    discountRate * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;
          }

          resultsDiv.classList.remove("hidden");
        });
      }

      // ==================== ADVANCED CALCULATORS ====================
      // --- Black-Scholes Calculator ---
      function renderBlackScholesCalculator() {
        return `
                      <h2 class="calculator-title">Black-Scholes Option Pricing Model</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Options Valuation
                          </div>
                          <p class="explanation-text">
                              The <strong>Black-Scholes model</strong> is a mathematical model for pricing options contracts. It calculates the theoretical price of European-style options
                              (which can only be exercised at expiration) using current stock prices, expected dividends, the option's strike price, expected interest rates, time to expiration, and expected volatility.
                          </p>
                          <p class="explanation-text">
                              The model assumes that the price of heavily traded assets follows a geometric Brownian motion with constant drift and volatility.
                              It revolutionized options trading by providing a standardized way to price options.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> The "Greeks" (Delta, Gamma, Theta, Vega, Rho) measure different dimensions of risk in option positions and are derived from the Black-Scholes model.
                          </div>
                      </div>
                      <div class="options-toggle">
                          <button class="option-btn active" id="callOption">Call Option</button>
                          <button class="option-btn" id="putOption">Put Option</button>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Current Stock Price ($)</label>
                              <input type="number" id="stockPrice" class="form-input" placeholder="100">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Strike Price ($)</label>
                              <input type="number" id="strikePrice" class="form-input" placeholder="100">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Time to Expiration (Years)</label>
                              <input type="number" id="timeToExp" class="form-input" placeholder="1" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Risk-free Rate (%)</label>
                              <input type="number" id="bsRiskFreeRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Volatility (%)</label>
                              <input type="number" id="volatility" class="form-input" placeholder="20" step="0.1">
                          </div>
                      </div>
                      <button class="btn btn-primary" id="calculateBS">Calculate Option Price</button>
                      <div id="bsResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      // Improved Normal CDF with higher accuracy
      function normalCDF(x) {
        // Approximation by Abramowitz and Stegun (1964)
        // Accuracy: 7.5e-8 (much better than current 0.5%)

        const sign = x >= 0 ? 1 : -1;
        x = Math.abs(x) / Math.sqrt(2);

        // Constants
        const a1 = 0.254829592;
        const a2 = -0.284496736;
        const a3 = 1.421413741;
        const a4 = -1.453152027;
        const a5 = 1.061405429;
        const p = 0.3275911;

        const t = 1 / (1 + p * x);
        const erfApprox =
          1 -
          ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

        return 0.5 * (1 + sign * erfApprox);
      }

      // Normal PDF for Greeks calculation
      function normalPDF(x) {
        return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
      }

      // Greeks calculation
      function calculateGreeks(S, K, T, r, sigma, isCall) {
        const d1 =
          (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
          (sigma * Math.sqrt(T));
        const d2 = d1 - sigma * Math.sqrt(T);

        const Nd1 = normalCDF(d1);
        const Nd2 = normalCDF(d2);
        const nd1 = normalPDF(d1);

        // Delta: Rate of change of option price with respect to stock price
        const delta = isCall ? Nd1 : Nd1 - 1;

        // Gamma: Rate of change of delta with respect to stock price
        const gamma = nd1 / (S * sigma * Math.sqrt(T));

        // Theta: Rate of change of option price with respect to time (per day)
        const theta1 = -(S * nd1 * sigma) / (2 * Math.sqrt(T));
        const theta2 = isCall
          ? -r * K * Math.exp(-r * T) * Nd2
          : r * K * Math.exp(-r * T) * normalCDF(-d2);
        const theta = (theta1 + theta2) / 365; // Per day

        // Vega: Rate of change of option price with respect to volatility
        const vega = (S * nd1 * Math.sqrt(T)) / 100; // Per 1% change in volatility

        // Rho: Rate of change of option price with respect to interest rate
        const rho = isCall
          ? (K * T * Math.exp(-r * T) * Nd2) / 100
          : -(K * T * Math.exp(-r * T) * normalCDF(-d2)) / 100;

        return { delta, gamma, theta, vega, rho };
      }

      function setupBlackScholesCalculator() {
        const callOption = document.getElementById("callOption");
        const putOption = document.getElementById("putOption");
        const calculateBtn = document.getElementById("calculateBS");
        const resultsDiv = document.getElementById("bsResults");

        let isCall = true;

        callOption.addEventListener("click", () => {
          callOption.classList.add("active");
          putOption.classList.remove("active");
          isCall = true;
        });

        putOption.addEventListener("click", () => {
          putOption.classList.add("active");
          callOption.classList.remove("active");
          isCall = false;
        });

        calculateBtn.addEventListener("click", () => {
          const S = parseFloat(document.getElementById("stockPrice").value);
          const K = parseFloat(document.getElementById("strikePrice").value);
          const T = parseFloat(document.getElementById("timeToExp").value);
          const r =
            parseFloat(document.getElementById("bsRiskFreeRate").value) / 100;
          const sigma =
            parseFloat(document.getElementById("volatility").value) / 100;

          if (
            isNaN(S) ||
            isNaN(K) ||
            isNaN(T) ||
            isNaN(r) ||
            isNaN(sigma) ||
            S <= 0 ||
            K <= 0 ||
            T <= 0 ||
            sigma <= 0
          ) {
            alert("Vui lòng nhập các số dương hợp lệ.");
            return;
          }

          const d1 =
            (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
            (sigma * Math.sqrt(T));
          const d2 = d1 - sigma * Math.sqrt(T);

          const Nd1 = normalCDF(d1);
          const Nd2 = normalCDF(d2);
          const Nminusd1 = normalCDF(-d1);
          const Nminusd2 = normalCDF(-d2);

          let optionPrice;
          if (isCall) {
            optionPrice = S * Nd1 - K * Math.exp(-r * T) * Nd2;
          } else {
            optionPrice = K * Math.exp(-r * T) * Nminusd2 - S * Nminusd1;
          }

          // Calculate Greeks
          const greeks = calculateGreeks(S, K, T, r, sigma, isCall);

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--indigo-100);">
                                  <div class="result-label">${
                                    isCall ? "Call" : "Put"
                                  } Price</div>
                                  <div class="result-value">$${optionPrice.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--blue-100);">
                                  <div class="result-label">Delta (Δ)</div>
                                  <div class="result-value">${greeks.delta.toFixed(
                                    4
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--cyan-100);">
                                  <div class="result-label">Gamma (Γ)</div>
                                  <div class="result-value">${greeks.gamma.toFixed(
                                    4
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--green-100);">
                                  <div class="result-label">Theta (Θ)</div>
                                  <div class="result-value">$${greeks.theta.toFixed(
                                    2
                                  )}/day</div>
                              </div>
                              <div class="result-card" style="background-color: var(--purple-100);">
                                  <div class="result-label">Vega (ν)</div>
                                  <div class="result-value">$${greeks.vega.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--pink-100);">
                                  <div class="result-label">Rho (ρ)</div>
                                  <div class="result-value">$${greeks.rho.toFixed(
                                    2
                                  )}</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- WACC Calculator ---
      function renderWACCCalculator() {
        return `
                      <h2 class="calculator-title">Weighted Average Cost of Capital (WACC)</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Company's Cost of Capital
                          </div>
                          <p class="explanation-text">
                              <strong>Weighted Average Cost of Capital (WACC)</strong> represents a firm's average after-tax cost of capital from all sources, including common stock, preferred stock, bonds, and other forms of debt.
                              It is the minimum return a company must earn on its existing asset base to satisfy its creditors, owners, and other providers of capital.
                          </p>
                          <p class="explanation-text">
                              Companies use WACC as a hurdle rate for evaluating investment opportunities. Projects with returns below WACC would destroy value, while those with returns above WACC would create value.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> WACC is widely used in discounted cash flow (DCF) analysis as the discount rate. A lower WACC makes future cash flows more valuable, increasing the perceived value of a company.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Market Value of Equity ($)</label>
                              <input type="number" id="marketValueEquity" class="form-input" placeholder="500000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Market Value of Debt ($)</label>
                              <input type="number" id="marketValueDebt" class="form-input" placeholder="300000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Cost of Equity (%)</label>
                              <input type="number" id="costOfEquity" class="form-input" placeholder="12" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Cost of Debt (%)</label>
                              <input type="number" id="costOfDebt" class="form-input" placeholder="6" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Tax Rate (%)</label>
                              <input type="number" id="taxRate" class="form-input" placeholder="30" step="0.1">
                          </div>
                      </div>
                      <button class="btn btn-success" id="calculateWACC">Calculate WACC</button>
                      <div id="waccResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupWACCCalculator() {
        const calculateBtn = document.getElementById("calculateWACC");
        const resultsDiv = document.getElementById("waccResults");

        calculateBtn.addEventListener("click", () => {
          const E = parseFloat(
            document.getElementById("marketValueEquity").value
          );
          const D = parseFloat(
            document.getElementById("marketValueDebt").value
          );
          const Re =
            parseFloat(document.getElementById("costOfEquity").value) / 100;
          const Rd =
            parseFloat(document.getElementById("costOfDebt").value) / 100;
          const T = parseFloat(document.getElementById("taxRate").value) / 100;

          if (
            isNaN(E) ||
            isNaN(D) ||
            isNaN(Re) ||
            isNaN(Rd) ||
            isNaN(T) ||
            E < 0 ||
            D < 0 ||
            Re < 0 ||
            Rd < 0 ||
            T < 0 ||
            T > 100
          ) {
            alert("Vui lòng nhập các số hợp lệ.");
            return;
          }

          const V = E + D;

          // WACC = (E/V × Re) + ((D/V × Rd) × (1-T))
          const wacc = (E / V) * Re + (D / V) * Rd * (1 - T);
          const equityWeight = E / V;
          const debtWeight = D / V;
          const afterTaxCostOfDebt = Rd * (1 - T);

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--green-100);">
                                  <div class="result-label">WACC</div>
                                  <div class="result-value">${(
                                    wacc * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Equity Weight</div>
                                  <div class="result-value">${(
                                    equityWeight * 100
                                  ).toFixed(1)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Debt Weight</div>
                                  <div class="result-value">${(
                                    debtWeight * 100
                                  ).toFixed(1)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">After-tax Cost of Debt</div>
                                  <div class="result-value">${(
                                    afterTaxCostOfDebt * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
        });
      }
      // --- DCF Valuation Calculator ---
      function renderDCFCalculator() {
        return `
                <h2 class="calculator-title">Discounted Cash Flow (DCF) Valuation</h2>
                <div class="explanation-box">
                  <div class="explanation-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Enterprise Valuation Model
                  </div>
                  <p class="explanation-text">
                    <strong>DCF Valuation</strong> determines a company's intrinsic value by calculating the present value of its expected future cash flows.
                    This is the most widely used valuation method in investment banking, private equity, and equity research.
                  </p>
                  <p class="explanation-text">
                    The model projects Free Cash Flows (FCF) for a forecast period (typically 5-10 years), then estimates a Terminal Value
                    to capture all cash flows beyond the forecast period. Both are discounted back to present value using WACC.
                  </p>
                  <div class="explanation-note">
                    <strong>PE/IB Insight:</strong> DCF is highly sensitive to assumptions (growth rate, WACC, terminal value).
                    Always perform sensitivity analysis on key variables. A 1% change in WACC can swing valuation by 10-15%.
                  </div>
                </div>

                <div class="options-toggle">
                  <button class="option-btn active" id="terminalGrowth">Perpetuity Growth</button>
                  <button class="option-btn" id="terminalMultiple">Exit Multiple</button>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Initial FCF ($M)</label>
                    <input type="number" id="initialFCF" class="form-input" placeholder="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">FCF Growth Rate (%)</label>
                    <input type="number" id="fcfGrowthRate" class="form-input" placeholder="8" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Forecast Period (Years)</label>
                    <input type="number" id="forecastPeriod" class="form-input" placeholder="5" min="1" max="20">
                  </div>
                  <div class="form-group">
                    <label class="form-label">WACC / Discount Rate (%)</label>
                    <input type="number" id="dcfWACC" class="form-input" placeholder="10" step="0.1">
                  </div>
                  <div class="form-group" id="terminalGrowthInput">
                    <label class="form-label">Terminal Growth Rate (%)</label>
                    <input type="number" id="terminalGrowthRate" class="form-input" placeholder="3" step="0.1">
                  </div>
                  <div class="form-group hidden" id="terminalMultipleInput">
                    <label class="form-label">Exit EV/EBITDA Multiple</label>
                    <input type="number" id="exitMultiple" class="form-input" placeholder="10" step="0.1">
                  </div>
                  <div class="form-group hidden" id="terminalEBITDAInput">
                    <label class="form-label">Terminal Year EBITDA ($M)</label>
                    <input type="number" id="terminalEBITDA" class="form-input" placeholder="150" step="0.1">
                  </div>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Cash & Equivalents ($M)</label>
                    <input type="number" id="cashEquiv" class="form-input" placeholder="50" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Debt ($M)</label>
                    <input type="number" id="totalDebt" class="form-input" placeholder="200" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Shares Outstanding (M)</label>
                    <input type="number" id="sharesOut" class="form-input" placeholder="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Minority Interest ($M)</label>
                    <input type="number" id="minorityInterest" class="form-input" placeholder="0" step="0.1">
                  </div>
                </div>

                <button class="btn btn-primary" id="calculateDCF">Calculate Enterprise & Equity Value</button>

                <div id="dcfResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                  <!-- Results will be populated here -->
                </div>

                <div id="dcfBreakdown" class="hidden" style="margin-top: 2rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                  <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--slate-700);">Cash Flow Projection</h3>
                  <div style="overflow-x: auto;">
                    <table id="fcfTable" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <!-- Table will be populated here -->
                    </table>
                  </div>
                </div>
              `;
      }

      function setupDCFCalculator() {
        const terminalGrowthBtn = document.getElementById("terminalGrowth");
        const terminalMultipleBtn = document.getElementById("terminalMultiple");
        const terminalGrowthInput = document.getElementById(
          "terminalGrowthInput"
        );
        const terminalMultipleInput = document.getElementById(
          "terminalMultipleInput"
        );
        const terminalEBITDAInput = document.getElementById(
          "terminalEBITDAInput"
        );
        const calculateBtn = document.getElementById("calculateDCF");
        const resultsDiv = document.getElementById("dcfResults");
        const breakdownDiv = document.getElementById("dcfBreakdown");

        let usePerpetuityGrowth = true;

        // Toggle between terminal value methods
        terminalGrowthBtn.addEventListener("click", () => {
          terminalGrowthBtn.classList.add("active");
          terminalMultipleBtn.classList.remove("active");
          terminalGrowthInput.classList.remove("hidden");
          terminalMultipleInput.classList.add("hidden");
          terminalEBITDAInput.classList.add("hidden");
          usePerpetuityGrowth = true;
        });

        terminalMultipleBtn.addEventListener("click", () => {
          terminalMultipleBtn.classList.add("active");
          terminalGrowthBtn.classList.remove("active");
          terminalGrowthInput.classList.add("hidden");
          terminalMultipleInput.classList.remove("hidden");
          terminalEBITDAInput.classList.remove("hidden");
          usePerpetuityGrowth = false;
        });

        calculateBtn.addEventListener("click", () => {
          // Get inputs
          const initialFCF = parseFloat(
            document.getElementById("initialFCF").value
          );
          const fcfGrowthRate =
            parseFloat(document.getElementById("fcfGrowthRate").value) / 100;
          const forecastPeriod = parseInt(
            document.getElementById("forecastPeriod").value
          );
          const wacc =
            parseFloat(document.getElementById("dcfWACC").value) / 100;
          const cash = parseFloat(document.getElementById("cashEquiv").value);
          const debt = parseFloat(document.getElementById("totalDebt").value);
          const shares = parseFloat(document.getElementById("sharesOut").value);
          const minorityInt =
            parseFloat(document.getElementById("minorityInterest").value) || 0;

          // Validate inputs
          if (
            isNaN(initialFCF) ||
            isNaN(fcfGrowthRate) ||
            isNaN(forecastPeriod) ||
            isNaN(wacc) ||
            isNaN(cash) ||
            isNaN(debt) ||
            isNaN(shares)
          ) {
            alert("Vui lòng nhập các số hợp lệ cho tất cả các mục bắt buộc.");
            return;
          }

          if (forecastPeriod < 1 || forecastPeriod > 20) {
            alert("Thời gian dự báo phải nằm trong khoảng từ 1 đến 20 năm.");
            return;
          }

          if (wacc <= 0) {
            alert("WACC phải là một số dương.");
            return;
          }

          // Project FCFs
          const fcfs = [];
          const pvFCFs = [];
          let cumulativePVFCF = 0;

          for (let year = 1; year <= forecastPeriod; year++) {
            const fcf = initialFCF * Math.pow(1 + fcfGrowthRate, year);
            const pvFCF = fcf / Math.pow(1 + wacc, year);
            fcfs.push(fcf);
            pvFCFs.push(pvFCF);
            cumulativePVFCF += pvFCF;
          }

          // Calculate Terminal Value
          let terminalValue, terminalValuePV;

          if (usePerpetuityGrowth) {
            const terminalGrowthRate =
              parseFloat(document.getElementById("terminalGrowthRate").value) /
              100;

            if (isNaN(terminalGrowthRate)) {
              alert("Vui lòng nhập tỷ lệ tăng trưởng cuối cùng hợp lệ.");
              return;
            }

            if (terminalGrowthRate >= wacc) {
              alert(
                "Tỷ lệ tăng trưởng cuối cùng phải nhỏ hơn WACC. Thông thường là 2-3% (tỷ lệ tăng trưởng GDP)."
              );
              return;
            }

            const finalYearFCF = fcfs[fcfs.length - 1];
            const terminalYearFCF = finalYearFCF * (1 + terminalGrowthRate);

            // Gordon Growth Model: TV = FCF(t+1) / (WACC - g)
            terminalValue = terminalYearFCF / (wacc - terminalGrowthRate);
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          } else {
            const exitMultiple = parseFloat(
              document.getElementById("exitMultiple").value
            );
            const terminalEBITDA = parseFloat(
              document.getElementById("terminalEBITDA").value
            );

            if (isNaN(exitMultiple) || isNaN(terminalEBITDA)) {
              alert("Vui lòng nhập hệ số thoát (exit multiple) và EBITDA cuối kỳ hợp lệ.");
              return;
            }

            if (exitMultiple <= 0) {
              alert("Hệ số thoát (exit multiple) phải là số dương.");
              return;
            }

            // TV = Exit Multiple × Terminal Year EBITDA
            terminalValue = exitMultiple * terminalEBITDA;
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          }

          // Calculate Enterprise Value
          const enterpriseValue = cumulativePVFCF + terminalValuePV;

          // Calculate Equity Value
          const equityValue = enterpriseValue + cash - debt - minorityInt;

          // Calculate per share value
          const valuePerShare = equityValue / shares;

          // Display results
          const tvPercentage = (terminalValuePV / enterpriseValue) * 100;

          resultsDiv.innerHTML = `
                  <div class="results-grid">
                    <div class="result-card" style="background-color: var(--indigo-100);">
                      <div class="result-label">Enterprise Value</div>
                      <div class="result-value">$${enterpriseValue.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--blue-100);">
                      <div class="result-label">Equity Value</div>
                      <div class="result-value">$${equityValue.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--cyan-100);">
                      <div class="result-label">Value per Share</div>
                      <div class="result-value">$${valuePerShare.toFixed(
                        2
                      )}</div>
                    </div>
                    <div class="result-card" style="background-color: var(--green-100);">
                      <div class="result-label">PV of Forecast FCFs</div>
                      <div class="result-value">$${cumulativePVFCF.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--emerald-100);">
                      <div class="result-label">Terminal Value (PV)</div>
                      <div class="result-value">$${terminalValuePV.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--slate-100);">
                      <div class="result-label">TV % of Total</div>
                      <div class="result-value">${tvPercentage.toFixed(
                        1
                      )}%</div>
                    </div>
                  </div>
                  <div style="margin-top: 1rem; padding: 1rem; background: var(--blue-50); border-radius: 0.5rem; border-left: 3px solid var(--blue-500);">
                    <div style="font-size: 0.875rem; color: var(--slate-700);">
                      <strong>Bridge to Equity Value:</strong><br>
                      Enterprise Value: $${enterpriseValue.toFixed(1)}M<br>
                      + Cash: $${cash.toFixed(1)}M<br>
                      − Debt: $${debt.toFixed(1)}M<br>
                      ${
                        minorityInt > 0
                          ? `− Minority Interest: $${minorityInt.toFixed(
                              1
                            )}M<br>`
                          : ""
                      }
                      = Equity Value: $${equityValue.toFixed(1)}M
                    </div>
                  </div>
                `;

          resultsDiv.classList.remove("hidden");

          // Build FCF projection table
          let tableHTML = `
                  <thead>
                    <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Year</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">FCF ($M)</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Growth Rate</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Discount Factor</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">PV of FCF ($M)</th>
                    </tr>
                  </thead>
                  <tbody>
                `;

          for (let year = 1; year <= forecastPeriod; year++) {
            const discountFactor = 1 / Math.pow(1 + wacc, year);
            const growthRate = year === 1 ? fcfGrowthRate : fcfGrowthRate;

            tableHTML += `
                    <tr style="border-bottom: 1px solid var(--slate-200);">
                      <td style="padding: 0.75rem; font-weight: 500;">Year ${year}</td>
                      <td style="padding: 0.75rem; text-align: right;">$${fcfs[
                        year - 1
                      ].toFixed(1)}</td>
                      <td style="padding: 0.75rem; text-align: right;">${(
                        growthRate * 100
                      ).toFixed(1)}%</td>
                      <td style="padding: 0.75rem; text-align: right;">${discountFactor.toFixed(
                        4
                      )}</td>
                      <td style="padding: 0.75rem; text-align: right;">$${pvFCFs[
                        year - 1
                      ].toFixed(1)}</td>
                    </tr>
                  `;
          }

          tableHTML += `
                  <tr style="border-top: 2px solid var(--slate-300); background: var(--slate-50); font-weight: 600;">
                    <td style="padding: 0.75rem;" colspan="4">PV of Forecast Period FCFs</td>
                    <td style="padding: 0.75rem; text-align: right;">$${cumulativePVFCF.toFixed(
                      1
                    )}</td>
                  </tr>
                  <tr style="background: var(--indigo-50); font-weight: 600;">
                    <td style="padding: 0.75rem;">Terminal Value</td>
                    <td style="padding: 0.75rem; text-align: right;">$${terminalValue.toFixed(
                      1
                    )}</td>
                    <td style="padding: 0.75rem; text-align: right;" colspan="2">
                      ${
                        usePerpetuityGrowth
                          ? `Perpetuity @ ${parseFloat(
                              document.getElementById("terminalGrowthRate")
                                .value
                            ).toFixed(1)}%`
                          : `${parseFloat(
                              document.getElementById("exitMultiple").value
                            ).toFixed(1)}x EBITDA`
                      }
                    </td>
                    <td style="padding: 0.75rem; text-align: right;">$${terminalValuePV.toFixed(
                      1
                    )}</td>
                  </tr>
                  <tr style="border-top: 2px solid var(--indigo-500); background: var(--indigo-100); font-weight: 700; font-size: 1rem;">
                    <td style="padding: 1rem;" colspan="4">Enterprise Value</td>
                    <td style="padding: 1rem; text-align: right;">$${enterpriseValue.toFixed(
                      1
                    )}</td>
                  </tr>
                </tbody>
                `;

          document.getElementById("fcfTable").innerHTML = tableHTML;
          breakdownDiv.classList.remove("hidden");
        });
      }

      // ==================== ENHANCED LBO MODEL CODE ====================

      function renderLBOCalculator() {
        return `
                <h2 class="calculator-title">Advanced Leveraged Buyout (LBO) Model</h2>
                <div class="explanation-box">
                  <div class="explanation-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Institutional-Grade LBO Model
                  </div>
                  <p class="explanation-text">
                    Advanced LBO model with multi-tranche debt structure, management incentives, dividend recaps,
                    and 3-scenario analysis. This model reflects real PE deal dynamics including covenants,
                    cash sweeps, and realistic exit strategies.
                  </p>
                  <div class="explanation-note">
                    <strong>PE Best Practice:</strong> Always model Base/Upside/Downside scenarios. Target IRR 20-25%+
                    with 2.5-3.0x+ MOIC. Returns come from: (1) Multiple expansion, (2) EBITDA growth, (3) Deleveraging.
                  </div>
                </div>

                <!-- Transaction Structure Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  📊 Transaction Structure
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">LTM EBITDA ($M)</label>
                    <input type="number" id="lboEBITDA" class="form-input" value="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Entry EV/EBITDA Multiple</label>
                    <input type="number" id="entryMultiple" class="form-input" value="10.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Transaction Fees (% of EV)</label>
                    <input type="number" id="transFees" class="form-input" value="2.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Existing Cash ($M)</label>
                    <input type="number" id="existingCash" class="form-input" value="10" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Minimum Cash ($M)</label>
                    <input type="number" id="minCash" class="form-input" value="10" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Hold Period (Years)</label>
                    <input type="number" id="holdPeriod" class="form-input" value="5" min="3" max="10">
                  </div>
                </div>

                <!-- Debt Structure Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  💰 Multi-Tranche Debt Structure
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Revolver (x EBITDA)</label>
                    <input type="number" id="revolverMultiple" class="form-input" value="0.5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Revolver Rate (SOFR + bps)</label>
                    <input type="number" id="revolverRate" class="form-input" value="450" step="25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Commitment Fee (%)</label>
                    <input type="number" id="commitmentFee" class="form-input" value="0.5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Term Loan B (x EBITDA)</label>
                    <input type="number" id="tlbMultiple" class="form-input" value="4.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">TLB Rate (SOFR + bps)</label>
                    <input type="number" id="tlbRate" class="form-input" value="500" step="25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">TLB Amortization (%/year)</label>
                    <input type="number" id="tlbAmort" class="form-input" value="1.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Mezzanine (x EBITDA)</label>
                    <input type="number" id="mezzMultiple" class="form-input" value="1.5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Mezz Rate (%)</label>
                    <input type="number" id="mezzRate" class="form-input" value="11.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">PIK Toggle (%)</label>
                    <input type="number" id="pikToggle" class="form-input" value="50" step="10">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Base SOFR (%)</label>
                    <input type="number" id="baseSofr" class="form-input" value="4.5" step="0.25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Max Net Leverage (Year 1)</label>
                    <input type="number" id="maxLevY1" class="form-input" value="6.0" step="0.25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Max Net Leverage (Year 5)</label>
                    <input type="number" id="maxLevY5" class="form-input" value="4.0" step="0.25">
                  </div>
                </div>

                <!-- Management Equity Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  👔 Management Equity Structure
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Management Rollover (%)</label>
                    <input type="number" id="mgmtRollover" class="form-input" value="15" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Sweet Equity Pool (%)</label>
                    <input type="number" id="sweetEquity" class="form-input" value="10" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Sweet Equity Discount (%)</label>
                    <input type="number" id="sweetDiscount" class="form-input" value="50" step="5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Options Pool (%)</label>
                    <input type="number" id="optionsPool" class="form-input" value="5" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Option Strike (% of FMV)</label>
                    <input type="number" id="optionStrike" class="form-input" value="100" step="5">
                  </div>
                </div>

                <!-- Operating Assumptions - Base Case -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  📈 Operating Assumptions (Base Case)
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Revenue Growth Y1 (%)</label>
                    <input type="number" id="revenueGrowthY1" class="form-input" value="8" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Revenue Growth Y2-Y5 (%)</label>
                    <input type="number" id="revenueGrowthSteady" class="form-input" value="5" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">EBITDA Margin Y1 (%)</label>
                    <input type="number" id="ebitdaMarginY1" class="form-input" value="20" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">EBITDA Margin Y5 (%)</label>
                    <input type="number" id="ebitdaMarginY5" class="form-input" value="23" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">D&A (% of Revenue)</label>
                    <input type="number" id="daPercent" class="form-input" value="3.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">CapEx (% of Revenue)</label>
                    <input type="number" id="capexPercent" class="form-input" value="2.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">NWC (% of Revenue)</label>
                    <input type="number" id="nwcPercent" class="form-input" value="10" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Tax Rate (%)</label>
                    <input type="number" id="taxRate" class="form-input" value="25" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Exit Multiple (Base)</label>
                    <input type="number" id="exitMultipleBase" class="form-input" value="10.0" step="0.5">
                  </div>
                </div>

                <!-- Scenario Adjustments -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  🎯 Scenario Adjustments
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Upside: Growth Delta (%)</label>
                    <input type="number" id="upsideGrowth" class="form-input" value="2" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Upside: Multiple Delta (x)</label>
                    <input type="number" id="upsideMultiple" class="form-input" value="1.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Downside: Growth Delta (%)</label>
                    <input type="number" id="downsideGrowth" class="form-input" value="-2" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Downside: Multiple Delta (x)</label>
                    <input type="number" id="downsideMultiple" class="form-input" value="-1.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Downside: Rate Increase (bps)</label>
                    <input type="number" id="downsideRate" class="form-input" value="200" step="50">
                  </div>
                </div>

                <!-- Dividend Recap Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  💵 Dividend Recapitalization (Optional)
                </h3>
                <div style="margin-bottom: 1rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="enableRecap" style="width: 20px; height: 20px;">
                    <span style="font-weight: 500;">Enable Dividend Recap</span>
                  </label>
                </div>
                <div class="form-grid" id="recapInputs" style="display: none;">
                  <div class="form-group">
                    <label class="form-label">Recap Year</label>
                    <input type="number" id="recapYear" class="form-input" value="3" min="2" max="4">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Additional Debt (x EBITDA)</label>
                    <input type="number" id="recapDebtMultiple" class="form-input" value="1.0" step="0.25">
                  </div>
                </div>

                <button class="btn btn-success" id="calculateLBO" style="margin-top: 1.5rem;">
                  🚀 Run LBO Model (3 Scenarios)
                </button>

                <!-- Results Sections -->
                <div id="lboScenarioResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50); margin-top: 2rem;">
                  <!-- Scenario comparison will be populated here -->
                </div>

                <div id="lboDetailedResults" class="hidden" style="margin-top: 2rem;">
                  <!-- Detailed results tabs for each scenario -->
                </div>
              `;
      }

      function setupLBOCalculator() {
        // Toggle recap inputs
        document
          .getElementById("enableRecap")
          .addEventListener("change", (e) => {
            document.getElementById("recapInputs").style.display = e.target
              .checked
              ? "grid"
              : "none";
          });

        document
          .getElementById("calculateLBO")
          .addEventListener("click", () => {
            runLBOModel();
          });
      }

      function runLBOModel() {
        // Get all inputs
        const inputs = getModelInputs();

        // Validate inputs
        if (!validateInputs(inputs)) {
          return;
        }

        // Run 3 scenarios
        const scenarios = {
          base: calculateScenario(inputs, "base"),
          upside: calculateScenario(inputs, "upside"),
          downside: calculateScenario(inputs, "downside"),
        };

        // Display results
        displayScenarioComparison(scenarios);
        displayDetailedResults(scenarios, inputs);
      }

      function getModelInputs() {
        return {
          // Transaction
          ltmEBITDA: parseFloat(document.getElementById("lboEBITDA").value),
          entryMultiple: parseFloat(
            document.getElementById("entryMultiple").value
          ),
          transFees:
            parseFloat(document.getElementById("transFees").value) / 100,
          existingCash: parseFloat(
            document.getElementById("existingCash").value
          ),
          minCash: parseFloat(document.getElementById("minCash").value),
          holdPeriod: parseInt(document.getElementById("holdPeriod").value),

          // Debt structure
          revolverMultiple: parseFloat(
            document.getElementById("revolverMultiple").value
          ),
          revolverRate:
            parseFloat(document.getElementById("revolverRate").value) / 10000,
          commitmentFee:
            parseFloat(document.getElementById("commitmentFee").value) / 100,
          tlbMultiple: parseFloat(document.getElementById("tlbMultiple").value),
          tlbRate: parseFloat(document.getElementById("tlbRate").value) / 10000,
          tlbAmort: parseFloat(document.getElementById("tlbAmort").value) / 100,
          mezzMultiple: parseFloat(
            document.getElementById("mezzMultiple").value
          ),
          mezzRate: parseFloat(document.getElementById("mezzRate").value) / 100,
          pikToggle:
            parseFloat(document.getElementById("pikToggle").value) / 100,
          baseSofr: parseFloat(document.getElementById("baseSofr").value) / 100,
          maxLevY1: parseFloat(document.getElementById("maxLevY1").value),
          maxLevY5: parseFloat(document.getElementById("maxLevY5").value),

          // Management equity
          mgmtRollover:
            parseFloat(document.getElementById("mgmtRollover").value) / 100,
          sweetEquity:
            parseFloat(document.getElementById("sweetEquity").value) / 100,
          sweetDiscount:
            parseFloat(document.getElementById("sweetDiscount").value) / 100,
          optionsPool:
            parseFloat(document.getElementById("optionsPool").value) / 100,
          optionStrike:
            parseFloat(document.getElementById("optionStrike").value) / 100,

          // Operating assumptions
          revenueGrowthY1:
            parseFloat(document.getElementById("revenueGrowthY1").value) / 100,
          revenueGrowthSteady:
            parseFloat(document.getElementById("revenueGrowthSteady").value) /
            100,
          ebitdaMarginY1:
            parseFloat(document.getElementById("ebitdaMarginY1").value) / 100,
          ebitdaMarginY5:
            parseFloat(document.getElementById("ebitdaMarginY5").value) / 100,
          daPercent:
            parseFloat(document.getElementById("daPercent").value) / 100,
          capexPercent:
            parseFloat(document.getElementById("capexPercent").value) / 100,
          nwcPercent:
            parseFloat(document.getElementById("nwcPercent").value) / 100,
          taxRate: parseFloat(document.getElementById("taxRate").value) / 100,
          exitMultipleBase: parseFloat(
            document.getElementById("exitMultipleBase").value
          ),

          // Scenarios
          upsideGrowth:
            parseFloat(document.getElementById("upsideGrowth").value) / 100,
          upsideMultiple: parseFloat(
            document.getElementById("upsideMultiple").value
          ),
          downsideGrowth:
            parseFloat(document.getElementById("downsideGrowth").value) / 100,
          downsideMultiple: parseFloat(
            document.getElementById("downsideMultiple").value
          ),
          downsideRate:
            parseFloat(document.getElementById("downsideRate").value) / 10000,

          // Recap
          enableRecap: document.getElementById("enableRecap").checked,
          recapYear: parseInt(document.getElementById("recapYear").value),
          recapDebtMultiple: parseFloat(
            document.getElementById("recapDebtMultiple").value
          ),
        };
      }

      function validateInputs(inputs) {
        if (isNaN(inputs.ltmEBITDA) || inputs.ltmEBITDA <= 0) {
          alert("Vui lòng nhập LTM EBITDA hợp lệ.");
          return false;
        }

        if (inputs.holdPeriod < 3 || inputs.holdPeriod > 10) {
          alert("Thời gian nắm giữ phải từ 3 đến 10 năm.");
          return false;
        }

        const totalLeverage =
          inputs.revolverMultiple + inputs.tlbMultiple + inputs.mezzMultiple;
        if (totalLeverage < 2 || totalLeverage > 10) {
          alert("Tổng đòn bẩy phải từ 2x đến 10x EBITDA.");
          return false;
        }

        const totalMgmtEquity =
          inputs.mgmtRollover + inputs.sweetEquity + inputs.optionsPool;
        if (totalMgmtEquity > 0.4) {
          alert("Tổng cổ phần quản lý không được vượt quá 40%.");
          return false;
        }

        return true;
      }

      function calculateScenario(inputs, scenarioType) {
        // Adjust inputs based on scenario
        const adjustedInputs = adjustForScenario(inputs, scenarioType);

        // Step 1: Calculate purchase price and sources/uses
        const transaction = calculateTransaction(adjustedInputs);

        // Step 2: Project financials
        const projections = projectFinancials(adjustedInputs, transaction);

        // Step 3: Calculate exit value and returns
        const returns = calculateReturns(
          adjustedInputs,
          transaction,
          projections
        );

        // Step 4: Calculate management returns
        const mgmtReturns = calculateManagementReturns(
          adjustedInputs,
          transaction,
          returns
        );

        return {
          transaction,
          projections,
          returns,
          mgmtReturns,
          inputs: adjustedInputs,
        };
      }

      function adjustForScenario(inputs, scenarioType) {
        const adjusted = { ...inputs };

        if (scenarioType === "upside") {
          adjusted.revenueGrowthY1 += inputs.upsideGrowth;
          adjusted.revenueGrowthSteady += inputs.upsideGrowth;
          adjusted.exitMultipleBase += inputs.upsideMultiple;
        } else if (scenarioType === "downside") {
          adjusted.revenueGrowthY1 += inputs.downsideGrowth;
          adjusted.revenueGrowthSteady += inputs.downsideGrowth;
          adjusted.exitMultipleBase += inputs.downsideMultiple;
          adjusted.revolverRate += inputs.downsideRate;
          adjusted.tlbRate += inputs.downsideRate;
        }

        return adjusted;
      }

      function calculateTransaction(inputs) {
        const purchaseEV = inputs.ltmEBITDA * inputs.entryMultiple;
        const transFees = purchaseEV * inputs.transFees;
        const totalUses = purchaseEV + transFees;

        // Debt sizing
        const revolver = inputs.ltmEBITDA * inputs.revolverMultiple;
        const tlb = inputs.ltmEBITDA * inputs.tlbMultiple;
        const mezz = inputs.ltmEBITDA * inputs.mezzMultiple;
        const totalDebt = revolver + tlb + mezz;

        // Equity calculation
        const purchaseEquity =
          totalUses - totalDebt - inputs.existingCash + inputs.minCash;
        const rolloverValue = purchaseEquity * inputs.mgmtRollover;
        const sponsorEquity = purchaseEquity - rolloverValue;

        // FMV per share (for sweet equity and options)
        const fmvPerShare = purchaseEquity; // Simplified
        const sweetEquityStrike = fmvPerShare * (1 - inputs.sweetDiscount);
        const optionStrike = fmvPerShare * inputs.optionStrike;

        // Ownership structure
        const sponsorOwnership =
          1 - inputs.mgmtRollover - inputs.sweetEquity - inputs.optionsPool;

        return {
          purchaseEV,
          transFees,
          totalUses,
          revolver,
          tlb,
          mezz,
          totalDebt,
          purchaseEquity,
          rolloverValue,
          sponsorEquity,
          fmvPerShare,
          sweetEquityStrike,
          optionStrike,
          sponsorOwnership,
          totalLeverage: totalDebt / inputs.ltmEBITDA,
        };
      }

      function projectFinancials(inputs, transaction) {
        const years = [];
        let currentRevenue = inputs.ltmEBITDA / inputs.ebitdaMarginY1;
        let prevNWC = currentRevenue * inputs.nwcPercent;

        // Covenant step-down
        const covenantStepDown =
          (inputs.maxLevY1 - inputs.maxLevY5) / (inputs.holdPeriod - 1);

        // Debt balances
        let revolverBalance = transaction.revolver;
        let tlbBalance = transaction.tlb;
        let mezzBalance = transaction.mezz;

        let recapDividend = 0;

        for (let year = 1; year <= inputs.holdPeriod; year++) {
          // Revenue growth
          const growthRate =
            year === 1 ? inputs.revenueGrowthY1 : inputs.revenueGrowthSteady;
          const revenue = currentRevenue * (1 + growthRate);

          // EBITDA margin expansion
          const marginProgress = (year - 1) / (inputs.holdPeriod - 1);
          const ebitdaMargin =
            inputs.ebitdaMarginY1 +
            (inputs.ebitdaMarginY5 - inputs.ebitdaMarginY1) * marginProgress;
          const ebitda = revenue * ebitdaMargin;

          // Operating metrics
          const depreciation = revenue * inputs.daPercent;
          const ebit = ebitda - depreciation;

          // Interest calculation
          const sofrRate = inputs.baseSofr;
          const revolverInterest =
            revolverBalance * (sofrRate + inputs.revolverRate);
          const commitmentFeeAmount =
            (transaction.revolver - revolverBalance) * inputs.commitmentFee;
          const tlbInterest = tlbBalance * (sofrRate + inputs.tlbRate);

          // Mezz interest with PIK toggle
          const mezzCashInterest =
            mezzBalance * inputs.mezzRate * (1 - inputs.pikToggle);
          const mezzPIKInterest =
            mezzBalance * inputs.mezzRate * inputs.pikToggle;

          const totalInterest =
            revolverInterest +
            commitmentFeeAmount +
            tlbInterest +
            mezzCashInterest;

          const ebt = ebit - totalInterest;
          const taxes = Math.max(0, ebt * inputs.taxRate);
          const netIncome = ebt - taxes;

          // Cash flow
          const capex = revenue * inputs.capexPercent;
          const nwc = revenue * inputs.nwcPercent;
          const changeInNWC = nwc - prevNWC;

          // Free cash flow
          const fcf = netIncome + depreciation - capex - changeInNWC;

          // Mandatory amortization
          const tlbAmortization = transaction.tlb * inputs.tlbAmort;

          // Cash sweep (excess FCF to debt paydown)
          let cashAvailable = fcf - tlbAmortization;

          // Dividend recap
          let recapAmount = 0;
          if (inputs.enableRecap && year === inputs.recapYear) {
            const recapDebt = ebitda * inputs.recapDebtMultiple;
            const proformaLeverage =
              (tlbBalance + mezzBalance + recapDebt) / ebitda;
            const maxLeverage = inputs.maxLevY1 - covenantStepDown * (year - 1);

            if (proformaLeverage <= maxLeverage) {
              recapAmount = recapDebt;
              tlbBalance += recapDebt;
              cashAvailable -= recapAmount;
              recapDividend = recapAmount;
            }
          }

          // Debt paydown waterfall
          const revolverPaydown = Math.min(
            revolverBalance,
            Math.max(0, cashAvailable)
          );
          cashAvailable -= revolverPaydown;
          revolverBalance -= revolverPaydown;

          const tlbPaydown =
            tlbAmortization +
            Math.min(tlbBalance - tlbAmortization, Math.max(0, cashAvailable));
          cashAvailable -= tlbPaydown - tlbAmortization;
          tlbBalance -= tlbPaydown;

          // Mezz PIK accretion
          mezzBalance += mezzPIKInterest;

          const totalDebtBalance = revolverBalance + tlbBalance + mezzBalance;
          const netLeverage = totalDebtBalance / ebitda;
          const maxLeverage = inputs.maxLevY1 - covenantStepDown * (year - 1);
          const covenantCompliance = netLeverage <= maxLeverage;

          years.push({
            year,
            revenue,
            ebitda,
            ebitdaMargin,
            depreciation,
            ebit,
            totalInterest,
            ebt,
            taxes,
            netIncome,
            capex,
            changeInNWC,
            fcf,
            tlbAmortization,
            revolverPaydown,
            tlbPaydown,
            mezzPIKInterest,
            recapAmount,
            revolverBalance,
            tlbBalance,
            mezzBalance,
            totalDebtBalance,
            netLeverage,
            maxLeverage,
            covenantCompliance,
          });

          currentRevenue = revenue;
          prevNWC = nwc;
        }

        return { years, recapDividend };
      }

      function calculateReturns(inputs, transaction, projections) {
        const finalYear = projections.years[projections.years.length - 1];

        // Exit value
        const exitEBITDA = finalYear.ebitda;
        const exitEV = exitEBITDA * inputs.exitMultipleBase;
        const exitDebt = finalYear.totalDebtBalance;
        const exitEquityValue = exitEV - exitDebt;

        // Sponsor returns
        const sponsorExitValue = exitEquityValue * transaction.sponsorOwnership;
        const sponsorInvested = transaction.sponsorEquity;
        const sponsorProfit =
          sponsorExitValue - sponsorInvested + projections.recapDividend;
        const sponsorMoM =
          (sponsorExitValue + projections.recapDividend) / sponsorInvested;

        // IRR calculation
        const cashFlows = [-sponsorInvested];
        for (let i = 1; i < inputs.holdPeriod; i++) {
          const yearCF =
            i === inputs.recapYear && inputs.enableRecap
              ? projections.recapDividend
              : 0;
          cashFlows.push(yearCF);
        }
        cashFlows.push(sponsorExitValue);

        const sponsorIRR = calculateIRR(cashFlows);

        // Value creation bridge
        const entryEV = transaction.purchaseEV;
        const ebitdaGrowth = exitEBITDA - inputs.ltmEBITDA;
        const ebitdaGrowthValue = ebitdaGrowth * inputs.exitMultipleBase;
        const multipleExpansion =
          (inputs.exitMultipleBase - inputs.entryMultiple) * exitEBITDA;
        const deleveraging = transaction.totalDebt - exitDebt;

        return {
          exitEBITDA,
          exitEV,
          exitDebt,
          exitEquityValue,
          sponsorExitValue,
          sponsorInvested,
          sponsorProfit,
          sponsorMoM,
          sponsorIRR,
          ebitdaGrowth,
          ebitdaGrowthValue,
          multipleExpansion,
          deleveraging,
        };
      }

      function calculateManagementReturns(inputs, transaction, returns) {
        const exitEquityValue = returns.exitEquityValue;

        // Rollover returns (same economics as sponsor on their portion)
        const rolloverExitValue = exitEquityValue * inputs.mgmtRollover;
        const rolloverInvested = transaction.rolloverValue;
        const rolloverMoM = rolloverExitValue / rolloverInvested;
        const rolloverIRR = Math.pow(rolloverMoM, 1 / inputs.holdPeriod) - 1;

        // Sweet equity returns
        const sweetEquityExitValue = exitEquityValue * inputs.sweetEquity;
        const sweetEquityInvested =
          transaction.sweetEquityStrike * inputs.sweetEquity;
        const sweetEquityMoM = sweetEquityExitValue / sweetEquityInvested;
        const sweetEquityIRR =
          Math.pow(sweetEquityMoM, 1 / inputs.holdPeriod) - 1;

        // Options returns
        const optionsExitValue =
          Math.max(0, exitEquityValue - transaction.optionStrike) *
          inputs.optionsPool;
        const optionsInvested = 0.01; // Nominal investment
        const optionsMoM = optionsExitValue / optionsInvested;

        // Blended management returns
        const totalMgmtExitValue =
          rolloverExitValue + sweetEquityExitValue + optionsExitValue;
        const totalMgmtInvested =
          rolloverInvested + sweetEquityInvested + optionsInvested;
        const blendedMgmtMoM = totalMgmtExitValue / totalMgmtInvested;
        const blendedMgmtIRR =
          Math.pow(blendedMgmtMoM, 1 / inputs.holdPeriod) - 1;

        return {
          rollover: {
            exitValue: rolloverExitValue,
            invested: rolloverInvested,
            moM: rolloverMoM,
            irr: rolloverIRR,
          },
          sweetEquity: {
            exitValue: sweetEquityExitValue,
            invested: sweetEquityInvested,
            moM: sweetEquityMoM,
            irr: sweetEquityIRR,
          },
          options: {
            exitValue: optionsExitValue,
            invested: optionsInvested,
            moM: optionsMoM,
          },
          blended: {
            exitValue: totalMgmtExitValue,
            invested: totalMgmtInvested,
            moM: blendedMgmtMoM,
            irr: blendedMgmtIRR,
          },
        };
      }

      function calculateIRR(cashFlows) {
        let irr = 0.15; // Initial guess
        const maxIterations = 1000;
        const tolerance = 1e-7;

        for (let iter = 0; iter < maxIterations; iter++) {
          let npv = 0;
          let derivative = 0;

          for (let t = 0; t < cashFlows.length; t++) {
            npv += cashFlows[t] / Math.pow(1 + irr, t);
            derivative -= (t * cashFlows[t]) / Math.pow(1 + irr, t + 1);
          }

          if (Math.abs(derivative) < 1e-10) break;

          const delta = npv / derivative;
          irr -= delta;

          if (irr < -0.99) irr = -0.99;
          if (irr > 10) irr = 10;

          if (Math.abs(delta) < tolerance) break;
        }

        return irr;
      }

      function displayScenarioComparison(scenarios) {
        const resultsDiv = document.getElementById("lboScenarioResults");

        const getIRRColor = (irr) => {
          if (irr >= 0.25) return "var(--green-600)";
          if (irr >= 0.2) return "var(--blue-600)";
          if (irr >= 0.15) return "var(--orange-500)";
          return "var(--red-600)";
        };

        const getIRRLabel = (irr) => {
          if (irr >= 0.25) return "🚀 Exceptional";
          if (irr >= 0.2) return "✅ Strong";
          if (irr >= 0.15) return "⚠️ Acceptable";
          return "❌ Below Target";
        };

        resultsDiv.innerHTML = `
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
                  📊 Three-Scenario Returns Analysis
                </h3>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                  ${["downside", "base", "upside"]
                    .map((scenario) => {
                      const s = scenarios[scenario];
                      const irrColor = getIRRColor(s.returns.sponsorIRR);
                      const irrLabel = getIRRLabel(s.returns.sponsorIRR);
                      const scenarioColor =
                        scenario === "base"
                          ? "blue"
                          : scenario === "upside"
                          ? "green"
                          : "orange";

                      return `
                      <div style="background: linear-gradient(135deg, var(--${scenarioColor}-50), var(--${scenarioColor}-100));
                                  padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--${scenarioColor}-300);">
                        <h4 style="font-size: 1rem; font-weight: 700; text-transform: uppercase;
                                  color: var(--${scenarioColor}-900); margin-bottom: 1rem; text-align: center;">
                          ${
                            scenario === "base"
                              ? "📍"
                              : scenario === "upside"
                              ? "📈"
                              : "📉"
                          } ${scenario.toUpperCase()}
                        </h4>

                        <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                          <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Sponsor IRR</div>
                            <div style="font-size: 2rem; font-weight: 800; color: ${irrColor};">
                              ${(s.returns.sponsorIRR * 100).toFixed(1)}%
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: ${irrColor};">
                              ${irrLabel}
                            </div>
                          </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">MoM</div>
                            <div style="font-weight: 700; color: var(--slate-800);">${s.returns.sponsorMoM.toFixed(
                              2
                            )}x</div>
                          </div>
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">Profit</div>
                            <div style="font-weight: 700; color: var(--slate-800);">$${s.returns.sponsorProfit.toFixed(
                              0
                            )}M</div>
                          </div>
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">Exit EV</div>
                            <div style="font-weight: 700; color: var(--slate-800);">$${s.returns.exitEV.toFixed(
                              0
                            )}M</div>
                          </div>
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">Exit Lev</div>
                            <div style="font-weight: 700; color: var(--slate-800);">
                              ${(
                                s.returns.exitDebt / s.returns.exitEBITDA
                              ).toFixed(2)}x
                            </div>
                          </div>
                        </div>

                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--slate-50);
                                    border-radius: 0.375rem; font-size: 0.75rem;">
                          <strong>Exit Multiple:</strong> ${s.inputs.exitMultipleBase.toFixed(
                            1
                          )}x<br>
                          <strong>EBITDA Growth:</strong> ${(
                            (s.returns.exitEBITDA / s.inputs.ltmEBITDA - 1) *
                            100
                          ).toFixed(0)}%<br>
                          <strong>Debt Paydown:</strong> $${s.returns.deleveraging.toFixed(
                            0
                          )}M
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>

                <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                            padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
                  <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                    🎯 Investment Committee Summary
                  </h4>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">IRR Range</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                        ${(scenarios.downside.returns.sponsorIRR * 100).toFixed(
                          1
                        )}% – ${(
          scenarios.upside.returns.sponsorIRR * 100
        ).toFixed(1)}%
                      </div>
                    </div>
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">MoM Range</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                        ${scenarios.downside.returns.sponsorMoM.toFixed(
                          2
                        )}x – ${scenarios.upside.returns.sponsorMoM.toFixed(2)}x
                      </div>
                    </div>
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Base IRR</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: ${getIRRColor(
                        scenarios.base.returns.sponsorIRR
                      )};">
                        ${(scenarios.base.returns.sponsorIRR * 100).toFixed(1)}%
                      </div>
                    </div>
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Entry Leverage</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                        ${scenarios.base.transaction.totalLeverage.toFixed(2)}x
                      </div>
                    </div>
                  </div>

                  <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                              border-left: 4px solid var(--indigo-500); font-size: 0.875rem;">
                    <strong>IC Recommendation:</strong>
                    ${
                      scenarios.base.returns.sponsorIRR >= 0.2
                        ? '✅ <span style="color: var(--green-700);">APPROVE</span> - Strong risk-adjusted returns across scenarios'
                        : scenarios.base.returns.sponsorIRR >= 0.15
                        ? '⚠️ <span style="color: var(--orange-700);">CONDITIONAL</span> - Acceptable base case, but limited downside protection'
                        : '❌ <span style="color: var(--red-700);">REJECT</span> - Insufficient returns relative to risk'
                    }
                  </div>
                </div>
              `;

        resultsDiv.classList.remove("hidden");
      }

      function displayDetailedResults(scenarios, inputs) {
        const detailsDiv = document.getElementById("lboDetailedResults");

        // Create tabs for each scenario
        detailsDiv.innerHTML = `
                <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem;
                            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                  <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-800);">
                    📑 Detailed Analysis (Base Case)
                  </h3>

                  ${renderSourcesUses(scenarios.base)}
                  ${renderDebtSchedule(scenarios.base)}
                  ${renderFinancialProjections(scenarios.base)}
                  ${renderManagementReturns(scenarios.base)}
                  ${renderValueCreationBridge(scenarios.base)}
                </div>
              `;

        detailsDiv.classList.remove("hidden");
      }

      function renderSourcesUses(scenario) {
        const t = scenario.transaction;

        return `
                <div style="margin-top: 2rem;">
                  <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                    💰 Sources & Uses of Funds
                  </h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div style="background: var(--slate-50); padding: 1.25rem; border-radius: 0.5rem;">
                      <h5 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--slate-700);">Uses</h5>
                      <table style="width: 100%; font-size: 0.875rem;">
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Purchase Enterprise Value</td>
                          <td style="text-align: right; font-weight: 500;">$${t.purchaseEV.toFixed(
                            1
                          )}M</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Transaction Fees</td>
                          <td style="text-align: right; font-weight: 500;">$${t.transFees.toFixed(
                            1
                          )}M</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Cash to Balance Sheet</td>
                          <td style="text-align: right; font-weight: 500;">$${scenario.inputs.minCash.toFixed(
                            1
                          )}M</td>
                        </tr>
                        <tr style="border-top: 2px solid var(--slate-400); font-weight: 700;">
                          <td style="padding: 0.75rem 0;">Total Uses</td>
                          <td style="text-align: right;">$${t.totalUses.toFixed(
                            1
                          )}M</td>
                        </tr>
                      </table>
                    </div>

                    <div style="background: var(--blue-50); padding: 1.25rem; border-radius: 0.5rem;">
                      <h5 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--slate-700);">Sources</h5>
                      <table style="width: 100%; font-size: 0.875rem;">
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Revolver</td>
                          <td style="text-align: right; font-weight: 500;">$${t.revolver.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.revolver / scenario.inputs.ltmEBITDA).toFixed(
                              2
                            )}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Term Loan B</td>
                          <td style="text-align: right; font-weight: 500;">$${t.tlb.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.tlb / scenario.inputs.ltmEBITDA).toFixed(2)}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Mezzanine / Sub Debt</td>
                          <td style="text-align: right; font-weight: 500;">$${t.mezz.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.mezz / scenario.inputs.ltmEBITDA).toFixed(2)}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 2px solid var(--slate-300); font-weight: 600; background: var(--slate-100);">
                          <td style="padding: 0.5rem 0;">Total Debt</td>
                          <td style="text-align: right;">$${t.totalDebt.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; font-weight: 700; color: var(--slate-700);">
                            ${t.totalLeverage.toFixed(2)}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Existing Cash</td>
                          <td style="text-align: right; font-weight: 500;">$${scenario.inputs.existingCash.toFixed(
                            1
                          )}M</td>
                          <td></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200); background: var(--orange-50);">
                          <td style="padding: 0.5rem 0;">Management Rollover</td>
                          <td style="text-align: right; font-weight: 500;">$${t.rolloverValue.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(scenario.inputs.mgmtRollover * 100).toFixed(0)}%
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200); background: var(--green-50);">
                          <td style="padding: 0.5rem 0; font-weight: 600;">Sponsor Equity</td>
                          <td style="text-align: right; font-weight: 700; color: var(--green-700);">$${t.sponsorEquity.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.sponsorOwnership * 100).toFixed(1)}%
                          </td>
                        </tr>
                        <tr style="border-top: 2px solid var(--slate-400); font-weight: 700;">
                          <td style="padding: 0.75rem 0;">Total Sources</td>
                          <td style="text-align: right;">$${(
                            t.totalDebt +
                            scenario.inputs.existingCash +
                            t.purchaseEquity
                          ).toFixed(1)}M</td>
                          <td></td>
                        </tr>
                      </table>

                      <div style="margin-top: 1rem; padding: 0.75rem; background: var(--white);
                                  border-radius: 0.375rem; font-size: 0.75rem;">
                        <strong>Equity Breakdown:</strong><br>
                        Sponsor: ${(t.sponsorOwnership * 100).toFixed(1)}% |
                        Mgmt Rollover: ${(
                          scenario.inputs.mgmtRollover * 100
                        ).toFixed(1)}% |
                        Sweet Equity: ${(
                          scenario.inputs.sweetEquity * 100
                        ).toFixed(1)}% |
                        Options: ${(scenario.inputs.optionsPool * 100).toFixed(
                          1
                        )}%
                      </div>
                    </div>
                  </div>
                </div>
              `;
      }

      function renderDebtSchedule(scenario) {
        const years = scenario.projections.years;

        let tableHTML = `
                <div style="margin-top: 2rem;">
                  <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                    📊 Debt Schedule & Covenant Compliance
                  </h4>
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <thead>
                        <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                          <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Year</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">EBITDA</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Revolver</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">TLB</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Mezz</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Total Debt</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Net Lev</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Covenant</th>
                          <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Status</th>
                        </tr>
                      </thead>
                      <tbody>
              `;

        years.forEach((y) => {
          const complianceIcon = y.covenantCompliance ? "✅" : "❌";
          const rowStyle = y.covenantCompliance
            ? ""
            : "background: var(--red-50);";

          tableHTML += `
                  <tr style="border-bottom: 1px solid var(--slate-200); ${rowStyle}">
                    <td style="padding: 0.75rem; font-weight: 500;">Year ${
                      y.year
                    }</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.ebitda.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.revolverBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.tlbBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.mezzBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right; font-weight: 600;">$${y.totalDebtBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right; font-weight: 600;">${y.netLeverage.toFixed(
                      2
                    )}x</td>
                    <td style="padding: 0.75rem; text-align: right;">≤ ${y.maxLeverage.toFixed(
                      2
                    )}x</td>
                    <td style="padding: 0.75rem; text-align: center;">${complianceIcon}</td>
                  </tr>
                `;
        });

        tableHTML += `
                      </tbody>
                    </table>
                  </div>
                </div>
              `;

        return tableHTML;
      }

      function renderFinancialProjections(scenario) {
        const years = scenario.projections.years;
        const inputs = scenario.inputs;

        let tableHTML = `
                <div style="margin-top: 2rem;">
                  <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                    📈 5-Year Financial Projections
                  </h4>
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <thead>
                        <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                          <th style="padding: 0.75rem; text-align: left; font-weight: 600; position: sticky; left: 0; background: var(--slate-100);">Metric</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">LTM</th>
              `;

        for (let i = 1; i <= inputs.holdPeriod; i++) {
          tableHTML += `<th style="padding: 0.75rem; text-align: right; font-weight: 600;">Year ${i}</th>`;
        }

        tableHTML += `</tr></thead><tbody>`;

        // Revenue
        tableHTML += `<tr style="background: var(--blue-50); border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--blue-50);">Revenue</td>
                <td style="padding: 0.75rem; text-align: right;">$${(
                  inputs.ltmEBITDA / inputs.ebitdaMarginY1
                ).toFixed(1)}M</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.revenue.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // EBITDA
        tableHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--white);">EBITDA</td>
                <td style="padding: 0.75rem; text-align: right;">$${inputs.ltmEBITDA.toFixed(
                  1
                )}M</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.ebitda.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // EBITDA Margin
        tableHTML += `<tr style="background: var(--slate-50); border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--slate-50);">EBITDA Margin</td>
                <td style="padding: 0.75rem; text-align: right;">${(
                  inputs.ebitdaMarginY1 * 100
                ).toFixed(1)}%</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">${(
            y.ebitdaMargin * 100
          ).toFixed(1)}%</td>`;
        });
        tableHTML += `</tr>`;

        // Free Cash Flow
        tableHTML += `<tr style="background: var(--green-50); border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--green-50);">Free Cash Flow</td>
                <td style="padding: 0.75rem; text-align: right;">-</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 600;">$${y.fcf.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // Debt Paydown
        tableHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Total Debt Paydown</td>
                  <td style="padding: 0.75rem; text-align: right;">-</td>`;
        years.forEach((y) => {
          const totalPaydown =
            y.tlbAmortization +
            y.revolverPaydown +
            (y.tlbPaydown - y.tlbAmortization);
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">$${totalPaydown.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // Dividend Recap
        if (inputs.enableRecap) {
          tableHTML += `<tr style="background: var(--purple-50); border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--purple-50);">Dividend Recap</td>
                    <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            tableHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--purple-700);">
                      ${
                        y.recapAmount > 0
                          ? `$${y.recapAmount.toFixed(1)}M`
                          : "-"
                      }
                    </td>`;
          });
          tableHTML += `</tr>`;
        }

        tableHTML += `</tbody></table></div></div>`;

        return tableHTML;
      }

      function renderManagementReturns(scenario) {
        const mgmt = scenario.mgmtReturns;
        const sponsor = scenario.returns;

        return `
                  <div style="margin-top: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                      👔 Management vs Sponsor Returns Comparison
                    </h4>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                      <!-- Sponsor Returns -->
                      <div style="background: linear-gradient(135deg, var(--blue-50), var(--blue-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--blue-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--blue-900);
                                  margin-bottom: 1rem; text-align: center;">
                          💼 SPONSOR
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">IRR</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--blue-700);">
                            ${(sponsor.sponsorIRR * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${sponsor.sponsorInvested.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${sponsor.sponsorExitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>MoM:</span>
                            <strong style="color: var(--blue-700);">${sponsor.sponsorMoM.toFixed(
                              2
                            )}x</strong>
                          </div>
                        </div>
                      </div>

                      <!-- Management Rollover -->
                      <div style="background: linear-gradient(135deg, var(--cyan-50), var(--cyan-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--cyan-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--cyan-900);
                                  margin-bottom: 1rem; text-align: center;">
                          🔄 ROLLOVER
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">IRR</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--cyan-700);">
                            ${(mgmt.rollover.irr * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${mgmt.rollover.invested.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${mgmt.rollover.exitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>MoM:</span>
                            <strong style="color: var(--cyan-700);">${mgmt.rollover.moM.toFixed(
                              2
                            )}x</strong>
                          </div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--cyan-50);
                                    border-radius: 0.25rem; font-size: 0.7rem; text-align: center;">
                          Same economics as sponsor
                        </div>
                      </div>

                      <!-- Sweet Equity -->
                      <div style="background: linear-gradient(135deg, var(--green-50), var(--green-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--green-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--green-900);
                                  margin-bottom: 1rem; text-align: center;">
                          🍬 SWEET EQUITY
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">IRR</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--green-700);">
                            ${(mgmt.sweetEquity.irr * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${mgmt.sweetEquity.invested.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${mgmt.sweetEquity.exitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>MoM:</span>
                            <strong style="color: var(--green-700);">${mgmt.sweetEquity.moM.toFixed(
                              2
                            )}x</strong>
                          </div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--green-50);
                                    border-radius: 0.25rem; font-size: 0.7rem; text-align: center;">
                          ${(scenario.inputs.sweetDiscount * 100).toFixed(
                            0
                          )}% discount to FMV
                        </div>
                      </div>

                      <!-- Options -->
                      <div style="background: linear-gradient(135deg, var(--purple-50), var(--purple-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--purple-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--purple-900);
                                  margin-bottom: 1rem; text-align: center;">
                          🎯 OPTIONS
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">Return</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--purple-700);">
                            ${
                              mgmt.options.moM > 1000
                                ? "∞"
                                : mgmt.options.moM.toFixed(0) + "x"
                            }
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${mgmt.options.invested.toFixed(
                              2
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${mgmt.options.exitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>Profit:</span>
                            <strong style="color: var(--purple-700);">$${(
                              mgmt.options.exitValue - mgmt.options.invested
                            ).toFixed(1)}M</strong>
                          </div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--purple-50);
                                    border-radius: 0.25rem; font-size: 0.7rem; text-align: center;">
                          Strike: ${(
                            scenario.inputs.optionStrike * 100
                          ).toFixed(0)}% of FMV
                        </div>
                      </div>
                    </div>

                    <!-- Blended Management Returns -->
                    <div style="margin-top: 1.5rem; background: linear-gradient(135deg, var(--orange-50), var(--orange-100));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--orange-300);">
                      <h5 style="font-size: 1rem; font-weight: 700; color: var(--orange-900);
                                margin-bottom: 1rem; text-align: center;">
                        📊 Blended Management Returns (Total Package)
                      </h5>
                      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Invested</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            $${mgmt.blended.invested.toFixed(1)}M
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Exit Value</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            $${mgmt.blended.exitValue.toFixed(1)}M
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Blended IRR</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            ${(mgmt.blended.irr * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Blended MoM</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            ${mgmt.blended.moM.toFixed(2)}x
                          </div>
                        </div>
                      </div>

                      <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                                  border-left: 4px solid var(--orange-500); font-size: 0.875rem;">
                        <strong>Key Insight:</strong>
                        ${
                          mgmt.blended.irr > sponsor.sponsorIRR
                            ? `Management's blended IRR of ${(
                                mgmt.blended.irr * 100
                              ).toFixed(1)}% outperforms sponsor's ${(
                                sponsor.sponsorIRR * 100
                              ).toFixed(
                                1
                              )}% due to sweet equity and options leverage. This ${(
                                (mgmt.blended.irr - sponsor.sponsorIRR) *
                                100
                              ).toFixed(
                                1
                              )}% premium properly incentivizes management to drive value creation.`
                            : `Management's blended IRR of ${(
                                mgmt.blended.irr * 100
                              ).toFixed(
                                1
                              )}% is aligned with sponsor returns of ${(
                                sponsor.sponsorIRR * 100
                              ).toFixed(
                                1
                              )}%, indicating strong alignment of interests.`
                        }
                      </div>
                    </div>
                  </div>
                `;
      }

      function renderValueCreationBridge(scenario) {
        const returns = scenario.returns;
        const inputs = scenario.inputs;

        return `
                  <div style="margin-top: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                      🌉 Value Creation Bridge Analysis
                    </h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                      <!-- Exit Waterfall -->
                      <div style="background: var(--blue-50); padding: 1.25rem; border-radius: 0.5rem;
                                  border-left: 4px solid var(--blue-500);">
                        <h5 style="font-weight: 600; color: var(--blue-900); margin-bottom: 1rem;">Exit Waterfall</h5>
                        <table style="width: 100%; font-size: 0.875rem;">
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Exit EBITDA</td>
                            <td style="text-align: right; font-weight: 600;">$${returns.exitEBITDA.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Exit Multiple</td>
                            <td style="text-align: right; font-weight: 500;">${inputs.exitMultipleBase.toFixed(
                              1
                            )}x</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; font-weight: 600;">Exit Enterprise Value</td>
                            <td style="text-align: right; font-weight: 700; color: var(--blue-700);">$${returns.exitEV.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Less: Remaining Debt</td>
                            <td style="text-align: right; font-weight: 500;">($${returns.exitDebt.toFixed(
                              1
                            )}M)</td>
                          </tr>
                          <tr style="border-top: 2px solid var(--blue-600); background: var(--blue-100);">
                            <td style="padding: 0.75rem 0; font-weight: 700;">Exit Equity Value</td>
                            <td style="text-align: right; font-weight: 700; color: var(--blue-800);">$${returns.exitEquityValue.toFixed(
                              1
                            )}M</td>
                          </tr>
                        </table>

                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--white);
                                    border-radius: 0.375rem; font-size: 0.75rem;">
                          <strong>Exit Leverage:</strong> ${(
                            returns.exitDebt / returns.exitEBITDA
                          ).toFixed(2)}x Net Debt/EBITDA<br>
                          <strong>Total Debt Paydown:</strong> $${returns.deleveraging.toFixed(
                            1
                          )}M
                          (${(
                            (returns.deleveraging /
                              scenario.transaction.totalDebt) *
                            100
                          ).toFixed(0)}%)
                        </div>
                      </div>

                      <!-- Value Creation Sources -->
                      <div style="background: var(--green-50); padding: 1.25rem; border-radius: 0.5rem;
                                  border-left: 4px solid var(--green-500);">
                        <h5 style="font-weight: 600; color: var(--green-900); margin-bottom: 1rem;">Sources of Value Creation</h5>
                        <table style="width: 100%; font-size: 0.875rem;">
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Initial Equity</td>
                            <td style="text-align: right; font-weight: 600;">$${returns.sponsorInvested.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; color: var(--blue-700);">
                              + EBITDA Growth (${inputs.ltmEBITDA.toFixed(
                                0
                              )}M → ${returns.exitEBITDA.toFixed(0)}M)
                            </td>
                            <td style="text-align: right; font-weight: 500;">$${returns.ebitdaGrowthValue.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; color: var(--green-700);">
                              + Deleveraging (Debt Paydown)
                            </td>
                            <td style="text-align: right; font-weight: 500;">$${returns.deleveraging.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; color: ${
                              returns.multipleExpansion >= 0
                                ? "var(--green-700)"
                                : "var(--red-700)"
                            };">
                              ${
                                returns.multipleExpansion >= 0 ? "+" : "−"
                              } Multiple ${
          returns.multipleExpansion >= 0 ? "Expansion" : "Compression"
        }
                              (${inputs.entryMultiple.toFixed(
                                1
                              )}x → ${inputs.exitMultipleBase.toFixed(1)}x)
                            </td>
                            <td style="text-align: right; font-weight: 500;">$${Math.abs(
                              returns.multipleExpansion
                            ).toFixed(1)}M</td>
                          </tr>
                          ${
                            scenario.projections.recapDividend > 0
                              ? `
                            <tr style="border-bottom: 1px solid var(--slate-200);">
                              <td style="padding: 0.5rem 0; color: var(--purple-700);">
                                + Dividend Recap (Year ${inputs.recapYear})
                              </td>
                              <td style="text-align: right; font-weight: 500;">$${scenario.projections.recapDividend.toFixed(
                                1
                              )}M</td>
                            </tr>
                          `
                              : ""
                          }
                          <tr style="border-top: 2px solid var(--green-600); background: var(--green-100);">
                            <td style="padding: 0.75rem 0; font-weight: 700;">Exit Equity Value (Sponsor)</td>
                            <td style="text-align: right; font-weight: 700; color: var(--green-800);">$${returns.sponsorExitValue.toFixed(
                              1
                            )}M</td>
                          </tr>
                        </table>

                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--white);
                                    border-radius: 0.375rem; font-size: 0.75rem;">
                          <strong>Total Profit:</strong> $${returns.sponsorProfit.toFixed(
                            1
                          )}M
                          (+${((returns.sponsorMoM - 1) * 100).toFixed(0)}%)<br>
                          <strong>CAGR:</strong> ${(
                            (Math.pow(
                              returns.sponsorMoM,
                              1 / inputs.holdPeriod
                            ) -
                              1) *
                            100
                          ).toFixed(1)}%
                        </div>
                      </div>
                    </div>

                    <!-- Value Attribution Chart -->
                    <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
                      <h5 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                        📊 Value Creation Attribution (% of Total Value Added)
                      </h5>

                      ${(() => {
                        const totalValueAdded = returns.sponsorProfit;
                        const ebitdaContribution =
                          (returns.ebitdaGrowthValue / totalValueAdded) * 100;
                        const deleverageContribution =
                          (returns.deleveraging / totalValueAdded) * 100;
                        const multipleContribution =
                          (returns.multipleExpansion / totalValueAdded) * 100;
                        const recapContribution =
                          scenario.projections.recapDividend > 0
                            ? (scenario.projections.recapDividend /
                                totalValueAdded) *
                              100
                            : 0;

                        return `
                          <div style="display: grid; grid-template-columns: repeat(${
                            scenario.projections.recapDividend > 0 ? 4 : 3
                          }, 1fr); gap: 1rem;">
                            <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">EBITDA Growth</div>
                              <div style="font-size: 2rem; font-weight: 800; color: var(--blue-600);">
                                ${ebitdaContribution.toFixed(0)}%
                              </div>
                              <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                $${returns.ebitdaGrowthValue.toFixed(1)}M
                              </div>
                              <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                <div style="height: ${ebitdaContribution}%; background: linear-gradient(to top, var(--blue-500), var(--blue-300));
                                            width: 100%; transition: height 0.5s;"></div>
                              </div>
                            </div>

                            <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Deleveraging</div>
                              <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                                ${deleverageContribution.toFixed(0)}%
                              </div>
                              <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                $${returns.deleveraging.toFixed(1)}M
                              </div>
                              <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                <div style="height: ${deleverageContribution}%; background: linear-gradient(to top, var(--green-500), var(--green-300));
                                            width: 100%; transition: height 0.5s;"></div>
                              </div>
                            </div>

                            <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Multiple ${
                                returns.multipleExpansion >= 0
                                  ? "Expansion"
                                  : "Compression"
                              }</div>
                              <div style="font-size: 2rem; font-weight: 800; color: ${
                                returns.multipleExpansion >= 0
                                  ? "var(--purple-600)"
                                  : "var(--red-600)"
                              };">
                                ${
                                  returns.multipleExpansion >= 0 ? "+" : ""
                                }${multipleContribution.toFixed(0)}%
                              </div>
                              <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                $${Math.abs(returns.multipleExpansion).toFixed(
                                  1
                                )}M
                              </div>
                              <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                <div style="height: ${Math.abs(
                                  multipleContribution
                                )}%; background: linear-gradient(to top, ${
                          returns.multipleExpansion >= 0
                            ? "var(--purple-500), var(--purple-300)"
                            : "var(--red-500), var(--red-300)"
                        });
                                            width: 100%; transition: height 0.5s;"></div>
                              </div>
                            </div>

                            ${
                              scenario.projections.recapDividend > 0
                                ? `
                              <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Dividend Recap</div>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--orange-600);">
                                  ${recapContribution.toFixed(0)}%
                                </div>
                                <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                  $${scenario.projections.recapDividend.toFixed(
                                    1
                                  )}M
                                </div>
                                <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                  <div style="height: ${recapContribution}%; background: linear-gradient(to top, var(--orange-500), var(--orange-300));
                                              width: 100%; transition: height 0.5s;"></div>
                                </div>
                              </div>
                            `
                                : ""
                            }
                          </div>
                        `;
                      })()}

                      <div style="margin-top: 1.5rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                                  border-left: 4px solid var(--indigo-500); font-size: 0.875rem;">
                        <strong>Strategic Insight:</strong>
                        ${(() => {
                          const totalValueAdded = returns.sponsorProfit;
                          const ebitdaContribution =
                            (returns.ebitdaGrowthValue / totalValueAdded) * 100;
                          const deleverageContribution =
                            (returns.deleveraging / totalValueAdded) * 100;
                          const multipleContribution =
                            (returns.multipleExpansion / totalValueAdded) * 100;

                          if (ebitdaContribution > 50) {
                            return `This deal is driven primarily by <strong>operational value creation</strong> (${ebitdaContribution.toFixed(
                              0
                            )}% of returns),
                                    indicating strong execution on business plan and revenue/margin expansion. This is the most sustainable source of PE returns.`;
                          } else if (deleverageContribution > 40) {
                            return `This deal is heavily reliant on <strong>financial engineering</strong> (${deleverageContribution.toFixed(
                              0
                            )}% from deleveraging),
                                                  which is solid but requires strong cash flow generation. Focus on maintaining covenant compliance throughout the hold period.`;
                          } else if (multipleContribution > 30) {
                            return `<strong>Multiple expansion</strong> contributes ${Math.abs(
                              multipleContribution
                            ).toFixed(0)}% of value.
                                                  ${
                                                    multipleContribution > 0
                                                      ? "This assumes favorable exit market conditions. Stress test downside scenarios with multiple compression."
                                                      : "Despite multiple compression, operational improvements drive positive returns."
                                                  }`;
                          } else {
                            return `Balanced value creation across all three levers: EBITDA growth (${ebitdaContribution.toFixed(
                              0
                            )}%),
                                                  deleveraging (${deleverageContribution.toFixed(
                                                    0
                                                  )}%), and multiple dynamics (${multipleContribution.toFixed(
                              0
                            )}%).
                                                  This diversified approach reduces execution risk.`;
                          }
                        })()}
                                    </div>
                                  </div>
                                </div>
                              `;
      }

      // ==================== EXPORT INITIALIZATION ====================

      function initializeLBOModel() {
        const container = document.getElementById("lboModelContainer");
        if (!container) {
          console.error("LBO Model container not found");
          return;
        }

        container.innerHTML = renderLBOCalculator();
        setupLBOCalculator();

        console.log("✅ Advanced LBO Model initialized successfully");
      }

      // Auto-initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeLBOModel);
      } else {
        initializeLBOModel();
      }

      // ==================== CREDIT CARD PAYMENT OPTIMIZER ====================

      function renderCCPOCalculator() {
        return `
          <h2 class="calculator-title">Credit Card Payment Optimizer (CCPO)</h2>

          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Chiến lược xóa nợ thông minh
            </div>
            <p class="explanation-text">
              <strong>Đừng chỉ trả tối thiểu.</strong> Trình tối ưu này giúp bạn xóa nợ thẻ tín dụng một cách chiến lược.
              So sánh các phương pháp đã được chứng minh: <strong>Avalanche</strong> (trả nợ theo lãi suất cao nhất trước) vs
              <strong>Snowball</strong> (trả nợ theo số dư nhỏ nhất trước).
            </p>
            <div class="explanation-note">
              <strong>Financial Insight:</strong> Sự khác biệt giữa việc trả ngẫu nhiên và chiến lược tối ưu có thể tiết kiệm hàng nghìn $ tiền lãi và rút ngắn đáng kể thời gian bạn trở nên không còn nợ. Ngay cả việc trả thêm 50$/tháng cũng tăng tốc giảm nợ đáng kể nhờ lãi kép.
            </div>
          </div>

          <!-- Card Input Section -->
          <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--slate-700);">
                💳 Thẻ Tín dụng của bạn
              </h3>
              <button class="btn btn-primary" id="addCardBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.875rem;">
                + Thêm Thẻ
              </button>
            </div>

            <div id="cardsContainer">
              <!-- Cards will be added here -->
            </div>
          </div>

          <!-- Payment Strategy Section -->
          <div class="form-grid" style="margin-bottom: 1.5rem;">
            <div class="form-group">
              <label class="form-label">💰 Tổng khoản thanh toán hàng tháng có sẵn</label>
              <input type="number" id="totalMonthlyPayment" class="form-input" placeholder="500" step="10">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                Phải ≥ tổng tất cả khoản thanh toán tối thiểu
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">📅 Thanh toán thêm (Tùy chọn)</label>
              <input type="number" id="extraPayment" class="form-input" placeholder="0" step="50">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                Khoản thanh toán một lần (thưởng, hoàn thuế…)
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">🎯 Khi nào áp dụng khoản thanh toán thêm?</label>
              <select id="extraPaymentMonth" class="form-select">
                <option value="0">Not applicable</option>
                <option value="1">Month 1</option>
                <option value="3">Month 3</option>
                <option value="6">Month 6</option>
                <option value="12">Month 12</option>
              </select>
            </div>
          </div>

          <button class="btn btn-success" id="optimizeBtn">
            🚀 Tối ưu Chiến lược Thanh toán của tôi
          </button>

          <!-- Results Section -->
          <div id="ccpoResults" class="hidden" style="margin-top: 2rem;">
            <!-- Strategy comparison -->
            <div id="strategyComparison"></div>

            <!-- Detailed breakdown tabs -->
            <div id="detailedBreakdown" class="hidden" style="margin-top: 2rem;"></div>
          </div>
        `;
      }

      function setupCCPOCalculator() {
        let cards = [];
        let cardIdCounter = 1;

        // Add initial card
        addCard();

        // Event listeners
        document.getElementById("addCardBtn").addEventListener("click", () => {
          if (cards.length < 10) {
            addCard();
          } else {
            alert("Chỉ được phép tối đa 10 thẻ.");
          }
        });

        document
          .getElementById("optimizeBtn")
          .addEventListener("click", optimizePayments);

        function addCard() {
          const cardId = cardIdCounter++;
          const card = {
            id: cardId,
            balance: 0,
            apr: 0,
            minPaymentPercent: 2,
            name: `Card ${cardId}`,
          };
          cards.push(card);
          renderCards();
        }

        function removeCard(cardId) {
          cards = cards.filter((c) => c.id !== cardId);
          renderCards();
        }

        function renderCards() {
          const container = document.getElementById("cardsContainer");

          if (cards.length === 0) {
            container.innerHTML =
              '<p style="text-align: center; color: var(--slate-500);">No cards added yet</p>';
            return;
          }

          container.innerHTML = cards
            .map(
              (card) => `
            <div class="card-row" data-card-id="${card.id}" style="
              background: var(--white);
              padding: 1rem;
              border-radius: 0.5rem;
              margin-bottom: 0.75rem;
              border: 2px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Card Name</label>
                  <input type="text" class="form-input card-name" value="${card.name}"
                         style="font-weight: 500; color: var(--indigo-700);">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Số dư ($)</label>
                  <input type="number" class="form-input card-balance" value="${card.balance}"
                         placeholder="5000" step="100">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">APR (%)</label>
                  <input type="number" class="form-input card-apr" value="${card.apr}"
                         placeholder="18.99" step="0.01">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Thanh toán tối thiểu (%)</label>
                  <input type="number" class="form-input card-minpayment" value="${card.minPaymentPercent}"
                         placeholder="2" step="0.1" min="1" max="10">
                </div>

                <button class="remove-card-btn" data-card-id="${card.id}" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.5rem 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                  transition: all 0.2s;
                ">
                  🗑️
                </button>
              </div>
            </div>
          `
            )
            .join("");

          // Attach event listeners
          document.querySelectorAll(".remove-card-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const cardId = parseInt(e.target.dataset.cardId);
              removeCard(cardId);
            });
          });

          // Update card data on input change
          document.querySelectorAll(".card-row").forEach((row) => {
            const cardId = parseInt(row.dataset.cardId);
            const card = cards.find((c) => c.id === cardId);

            row.querySelector(".card-name").addEventListener("input", (e) => {
              card.name = e.target.value;
            });

            row
              .querySelector(".card-balance")
              .addEventListener("input", (e) => {
                card.balance = parseFloat(e.target.value) || 0;
              });

            row.querySelector(".card-apr").addEventListener("input", (e) => {
              card.apr = parseFloat(e.target.value) || 0;
            });

            row
              .querySelector(".card-minpayment")
              .addEventListener("input", (e) => {
                card.minPaymentPercent = parseFloat(e.target.value) || 2;
              });
          });
        }

        function optimizePayments() {
          // Validate inputs
          const totalPayment = parseFloat(
            document.getElementById("totalMonthlyPayment").value
          );
          const extraPayment =
            parseFloat(document.getElementById("extraPayment").value) || 0;
          const extraPaymentMonth =
            parseInt(document.getElementById("extraPaymentMonth").value) || 0;

          if (cards.length === 0) {
            alert("Vui lòng thêm ít nhất một thẻ tín dụng.");
            return;
          }

          if (isNaN(totalPayment) || totalPayment <= 0) {
            alert("Vui lòng nhập tổng khoản thanh toán hàng tháng hợp lệ.");
            return;
          }

          // Validate all cards have data
          for (let card of cards) {
            if (card.balance <= 0 || card.apr <= 0) {
              alert(`Vui lòng điền đầy đủ thông tin cho thẻ ${card.name}`);
              return;
            }
          }

          // Calculate minimum payments
          const totalMinPayment = cards.reduce((sum, card) => {
            const minPayment = Math.max(
              25,
              card.balance * (card.minPaymentPercent / 100)
            );
            return sum + minPayment;
          }, 0);

          if (totalPayment < totalMinPayment) {
            alert(
              `Total monthly payment ($${totalPayment.toFixed(
                2
              )}) must be at least the sum of minimum payments ($${totalMinPayment.toFixed(
                2
              )})`
            );
            return;
          }

          // Run optimizations
          const minPaymentOnly = simulateStrategy(
            "minimum",
            cards,
            totalMinPayment,
            extraPayment,
            extraPaymentMonth
          );
          const avalanche = simulateStrategy(
            "avalanche",
            cards,
            totalPayment,
            extraPayment,
            extraPaymentMonth
          );
          const snowball = simulateStrategy(
            "snowball",
            cards,
            totalPayment,
            extraPayment,
            extraPaymentMonth
          );

          // Display results
          displayResults({
            minPaymentOnly,
            avalanche,
            snowball,
            totalPayment,
            extraPayment,
            extraPaymentMonth,
          });
        }

        function simulateStrategy(
          strategyType,
          cards,
          monthlyPayment,
          extraPayment,
          extraPaymentMonth
        ) {
          // Clone cards to avoid mutation
          let remainingCards = cards.map((c) => ({
            ...c,
            remainingBalance: c.balance,
            totalInterestPaid: 0,
            monthsPaid: 0,
          }));

          const monthlyBreakdown = [];
          let month = 0;
          let totalInterestPaid = 0;

          while (
            remainingCards.some((c) => c.remainingBalance > 0) &&
            month < 600
          ) {
            // Max 50 years safety
            month++;

            // Apply interest to all cards
            remainingCards.forEach((card) => {
              if (card.remainingBalance > 0) {
                const monthlyInterest =
                  (card.remainingBalance * (card.apr / 100)) / 12;
                card.remainingBalance += monthlyInterest;
                card.totalInterestPaid += monthlyInterest;
                totalInterestPaid += monthlyInterest;
              }
            });

            // Determine payment allocation
            let availablePayment = monthlyPayment;

            // Add extra payment if applicable
            if (month === extraPaymentMonth && extraPayment > 0) {
              availablePayment += extraPayment;
            }

            // Sort cards based on strategy
            let sortedCards;
            if (strategyType === "avalanche") {
              sortedCards = [...remainingCards].sort((a, b) => b.apr - a.apr);
            } else if (strategyType === "snowball") {
              sortedCards = [...remainingCards].sort(
                (a, b) => a.remainingBalance - b.remainingBalance
              );
            } else {
              // minimum payment only
              sortedCards = [...remainingCards];
            }

            // Pay minimum on all cards first
            const cardPayments = [];
            sortedCards.forEach((card) => {
              if (card.remainingBalance > 0) {
                const minPayment = Math.max(
                  25,
                  card.remainingBalance * (card.minPaymentPercent / 100)
                );
                const payment = Math.min(
                  minPayment,
                  card.remainingBalance,
                  availablePayment
                );

                card.remainingBalance -= payment;
                availablePayment -= payment;

                cardPayments.push({
                  cardId: card.id,
                  cardName: card.name,
                  payment: payment,
                  remainingBalance: Math.max(0, card.remainingBalance),
                });

                if (card.remainingBalance <= 0) {
                  card.monthsPaid = month;
                }
              }
            });

            // Allocate remaining payment based on strategy
            if (strategyType !== "minimum" && availablePayment > 0.01) {
              for (let card of sortedCards) {
                if (card.remainingBalance > 0) {
                  const extraPaymentToCard = Math.min(
                    availablePayment,
                    card.remainingBalance
                  );
                  card.remainingBalance -= extraPaymentToCard;
                  availablePayment -= extraPaymentToCard;

                  // Update payment in breakdown
                  const cardPayment = cardPayments.find(
                    (p) => p.cardId === card.id
                  );
                  if (cardPayment) {
                    cardPayment.payment += extraPaymentToCard;
                    cardPayment.remainingBalance = Math.max(
                      0,
                      card.remainingBalance
                    );
                  }

                  if (card.remainingBalance <= 0) {
                    card.monthsPaid = month;
                  }

                  if (availablePayment < 0.01) break;
                }
              }
            }

            monthlyBreakdown.push({
              month,
              payments: cardPayments,
              totalPaid:
                monthlyPayment +
                (month === extraPaymentMonth ? extraPayment : 0),
              totalRemaining: remainingCards.reduce(
                (sum, c) => sum + Math.max(0, c.remainingBalance),
                0
              ),
            });

            // Check if all paid off
            if (remainingCards.every((c) => c.remainingBalance <= 0)) {
              break;
            }
          }

          return {
            strategyType,
            monthsToPayoff: month,
            totalInterestPaid,
            cardDetails: remainingCards.map((c) => ({
              id: c.id,
              name: c.name,
              originalBalance: c.balance,
              totalInterestPaid: c.totalInterestPaid,
              monthsPaid: c.monthsPaid,
            })),
            monthlyBreakdown,
          };
        }

        function displayResults(results) {
          const {
            minPaymentOnly,
            avalanche,
            snowball,
            totalPayment,
            extraPayment,
            extraPaymentMonth,
          } = results;

          const resultsDiv = document.getElementById("ccpoResults");
          const comparisonDiv = document.getElementById("strategyComparison");

          // Calculate savings
          const avalancheSavings =
            minPaymentOnly.totalInterestPaid - avalanche.totalInterestPaid;
          const snowballSavings =
            minPaymentOnly.totalInterestPaid - snowball.totalInterestPaid;
          const avalancheVsSnowball =
            snowball.totalInterestPaid - avalanche.totalInterestPaid;

          const bestStrategy =
            avalanche.totalInterestPaid <= snowball.totalInterestPaid
              ? "avalanche"
              : "snowball";

          comparisonDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
              📊 So sánh Chiến lược Thanh toán
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <!-- Minimum Payment Only -->
              <div style="background: linear-gradient(135deg, var(--red-50), var(--red-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--red-300);">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--red-900); margin-bottom: 1rem; text-align: center;">
                  ⚠️ CHỈ THANH TOÁN TỐI THIỂU
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Thời gian trả hết nợ</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--red-600);">
                      ${minPaymentOnly.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--red-600);">
                      ${(minPaymentOnly.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Tổng lãi</div>
                    <div style="font-weight: 700; color: var(--red-700);">$${minPaymentOnly.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--red-50);
                            border-radius: 0.375rem; font-size: 0.75rem; text-align: center; color: var(--red-800);">
                  ⚠️ Mốc tham chiếu – Không được khuyến nghị!
                </div>
              </div>

              <!-- Avalanche Method -->
              <div style="background: linear-gradient(135deg, var(--green-50), var(--green-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            bestStrategy === "avalanche"
                              ? "var(--green-600)"
                              : "var(--green-300)"
                          };
                          box-shadow: ${
                            bestStrategy === "avalanche"
                              ? "0 4px 12px rgba(16, 185, 129, 0.3)"
                              : "none"
                          };">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem; text-align: center;">
                  🎯 AVALANCHE
                  ${
                    bestStrategy === "avalanche"
                      ? '<div style="font-size: 0.75rem; color: var(--green-700); margin-top: 0.25rem;">⭐ ĐƯỢC KHUYẾN NGHỊ</div>'
                      : ""
                  }
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Thời gian trả hết nợ</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                      ${avalanche.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--green-600);">
                      ${(avalanche.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Tổng lãi</div>
                    <div style="font-weight: 700; color: var(--green-700);">$${avalanche.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">so với trả tối thiểu</div>
                    <div style="font-weight: 700; color: var(--green-700);">-$${avalancheSavings.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50);
                            border-radius: 0.375rem; font-size: 0.75rem;">
                  <strong>Chiến lược:</strong> Trả nợ thẻ có APR cao nhất trước<br>
                  <strong>Tiết kiệm:</strong> ${
                    minPaymentOnly.monthsToPayoff - avalanche.monthsToPayoff
                  } months
                </div>
              </div>

              <!-- Snowball Method -->
              <div style="background: linear-gradient(135deg, var(--blue-50), var(--blue-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            bestStrategy === "snowball"
                              ? "var(--blue-600)"
                              : "var(--blue-300)"
                          };
                          box-shadow: ${
                            bestStrategy === "snowball"
                              ? "0 4px 12px rgba(59, 130, 246, 0.3)"
                              : "none"
                          };">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 1rem; text-align: center;">
                  ⛄ SNOWBALL
                  ${
                    bestStrategy === "snowball"
                      ? '<div style="font-size: 0.75rem; color: var(--blue-700); margin-top: 0.25rem;">⭐ RECOMMENDED</div>'
                      : ""
                  }
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Thời gian trả hết nợ</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--blue-600);">
                      ${snowball.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--blue-600);">
                      ${(snowball.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Tổng lãi</div>
                    <div style="font-weight: 700; color: var(--blue-700);">$${snowball.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">so với trả tối thiểu</div>
                    <div style="font-weight: 700; color: var(--blue-700);">-$${snowballSavings.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--blue-50);
                            border-radius: 0.375rem; font-size: 0.75rem;">
                  <strong>Chiến lược:</strong> Trả nợ thẻ có số dư nhỏ nhất trước<br>
                  <strong>Tiết kiệm:</strong> ${
                    minPaymentOnly.monthsToPayoff - snowball.monthsToPayoff
                  } months
                </div>
              </div>
            </div>

            <!-- Key Insights -->
            <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                        padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
              <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                💡 Những Insight & Khuyến nghị
              </h4>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Khoản Thanh toán Hàng tháng của bạn</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                    $${totalPayment.toFixed(0)}/mo
                  </div>
                  ${
                    extraPayment > 0
                      ? `
                    <div style="font-size: 0.7rem; color: var(--purple-600); margin-top: 0.25rem;">
                      + $${extraPayment} in month ${extraPaymentMonth}
                    </div>
                  `
                      : ""
                  }
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Chiến lược tốt nhất</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: ${
                    bestStrategy === "avalanche"
                      ? "var(--green-700)"
                      : "var(--blue-700)"
                  };">
                    ${
                      bestStrategy === "avalanche"
                        ? "🎯 Avalanche"
                        : "⛄ Snowball"
                    }
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Tiết kiệm lãi</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                    $${Math.max(avalancheSavings, snowballSavings).toFixed(0)}
                  </div>
                </div>
              </div>

              <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                          border-left: 4px solid var(--indigo-500); font-size: 0.875rem;">
                <strong>Tại sao chọn ${
                  bestStrategy === "avalanche" ? "Avalanche" : "Snowball"
                }?</strong>
                ${
                  bestStrategy === "avalanche"
                    ? `
                  Phương pháp Avalanche giúp bạn tiết kiệm <strong>$${avalancheVsSnowball.toFixed(
                    0
                  )} more</strong> so với Snowball bằng cách ưu tiên trả nợ có lãi suất cao trước.
                  Đây là chiến lược tối ưu về mặt tài chính để giảm thiểu tổng lãi phải trả.
                `
                    : `
                  Mặc dù Snowball trả lãi nhiều hơn một chút ($${avalancheVsSnowball.toFixed(
                    0
                  )} difference), nó giúp bạn
                  <strong>tạo động lực</strong> bnhờ xóa các thẻ nhanh hơn, giúp duy trì tiến trình trả nợ.
                  ${
                    Math.abs(avalancheVsSnowball / avalancheSavings) < 0.05
                      ? "Sự khác biệt rất nhỏ (<5%), nên hãy chọn phương pháp giúp bạn duy trì động lực!"
                      : ""
                  }
                `
                }
              </div>

              <button class="btn btn-primary" id="showDetailedBtn" style="margin-top: 1rem;">
                📈 Show Detailed Payment Schedule
              </button>
            </div>
          `;

          resultsDiv.classList.remove("hidden");

          // Add event listener for detailed view
          document
            .getElementById("showDetailedBtn")
            .addEventListener("click", () => {
              displayDetailedBreakdown(avalanche, snowball);
            });
        }

        function displayDetailedBreakdown(avalanche, snowball) {
          const detailedDiv = document.getElementById("detailedBreakdown");

          detailedDiv.innerHTML = `
            <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem;
                        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
              <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-800);">
                📅 Month-by-Month Payment Schedule
              </h3>

              <div class="options-toggle" style="margin-bottom: 1.5rem;">
                <button class="option-btn active" id="avalancheDetailBtn">Chiến lược Avalanche</button>
                <button class="option-btn" id="snowballDetailBtn">Chiến lược Snowball</button>
              </div>

              <div id="avalancheDetail">
                ${renderPaymentSchedule(avalanche)}
              </div>

              <div id="snowballDetail" class="hidden">
                ${renderPaymentSchedule(snowball)}
              </div>
            </div>
          `;

          detailedDiv.classList.remove("hidden");

          // Toggle between strategies
          document
            .getElementById("avalancheDetailBtn")
            .addEventListener("click", (e) => {
              document
                .getElementById("avalancheDetailBtn")
                .classList.add("active");
              document
                .getElementById("snowballDetailBtn")
                .classList.remove("active");
              document
                .getElementById("avalancheDetail")
                .classList.remove("hidden");
              document.getElementById("snowballDetail").classList.add("hidden");
            });

          document
            .getElementById("snowballDetailBtn")
            .addEventListener("click", (e) => {
              document
                .getElementById("snowballDetailBtn")
                .classList.add("active");
              document
                .getElementById("avalancheDetailBtn")
                .classList.remove("active");
              document
                .getElementById("snowballDetail")
                .classList.remove("hidden");
              document
                .getElementById("avalancheDetail")
                .classList.add("hidden");
            });
        }

        function renderPaymentSchedule(strategy) {
          const { monthlyBreakdown, cardDetails } = strategy;

          // Group cards by payoff milestone
          const payoffMilestones = cardDetails
            .sort((a, b) => a.monthsPaid - b.monthsPaid)
            .map((card) => ({
              ...card,
              payoffMonth: card.monthsPaid,
            }));

          // Show first 12 months + every 6 months after
          const monthsToShow = [];
          for (let i = 1; i <= Math.min(12, monthlyBreakdown.length); i++) {
            monthsToShow.push(i);
          }
          for (let i = 18; i <= monthlyBreakdown.length; i += 6) {
            monthsToShow.push(i);
          }
          // Always include final month
          if (!monthsToShow.includes(monthlyBreakdown.length)) {
            monthsToShow.push(monthlyBreakdown.length);
          }

          return `
                  <!-- Payoff Timeline -->
                  <div style="background: var(--slate-50); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
                      🎯 Lộ trình Trả nợ
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                      ${payoffMilestones
                        .map(
                          (card, idx) => `
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;
                                    border-left: 4px solid ${getCardColor(
                                      idx
                                    )};">
                          <div style="font-weight: 600; color: var(--slate-800); margin-bottom: 0.5rem;">
                            ${card.name}
                          </div>
                          <div style="font-size: 0.875rem; color: var(--slate-600);">
                            Paid off: <strong>Month ${card.payoffMonth}</strong>
                            <br>
                            Interest: <strong>$${card.totalInterestPaid.toFixed(
                              0
                            )}</strong>
                          </div>
                        </div>
                      `
                        )
                        .join("")}
                    </div>
                  </div>

                  <!-- Monthly Breakdown Table -->
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <thead>
                        <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                          <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Month</th>
                          ${cardDetails
                            .map(
                              (card) => `
                            <th style="padding: 0.75rem; text-align: right; font-weight: 600;">${card.name}</th>
                          `
                            )
                            .join("")}
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Tổng khoản thanh toán</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Nợ còn lại</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${monthsToShow
                          .map((monthNum) => {
                            const month = monthlyBreakdown[monthNum - 1];

                            return `
                            <tr style="border-bottom: 1px solid var(--slate-200); ${
                              monthNum === monthlyBreakdown.length
                                ? "background: var(--green-50); font-weight: 600;"
                                : ""
                            }">
                              <td style="padding: 0.75rem; font-weight: 500;">
                                ${monthNum}
                                ${
                                  payoffMilestones.find(
                                    (c) => c.payoffMonth === monthNum
                                  )
                                    ? "🎉"
                                    : ""
                                }
                              </td>
                              ${cardDetails
                                .map((card) => {
                                  const payment = month.payments.find(
                                    (p) => p.cardId === card.id
                                  );
                                  const isPaidOff =
                                    payment && payment.remainingBalance === 0;

                                  return `
                                  <td style="padding: 0.75rem; text-align: right; ${
                                    isPaidOff
                                      ? "color: var(--green-700); font-weight: 600;"
                                      : ""
                                  }">
                                    ${
                                      payment
                                        ? `$${payment.payment.toFixed(0)}`
                                        : "-"
                                    }
                                    ${isPaidOff ? " ✓" : ""}
                                  </td>
                                `;
                                })
                                .join("")}
                              <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                $${month.totalPaid.toFixed(0)}
                              </td>
                              <td style="padding: 0.75rem; text-align: right; font-weight: 600; ${
                                month.totalRemaining === 0
                                  ? "color: var(--green-700);"
                                  : ""
                              }">
                                $${month.totalRemaining.toFixed(0)}
                              </td>
                            </tr>
                          `;
                          })
                          .join("")}
                      </tbody>
                    </table>
                  </div>

                  <!-- Summary Stats -->
                  <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Tổng số nợ đã trả</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--blue-700);">
                        $${cardDetails
                          .reduce((sum, c) => sum + c.originalBalance, 0)
                          .toFixed(0)}
                      </div>
                    </div>

                    <div style="background: var(--red-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Tổng tiền lãi</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--red-700);">
                        $${strategy.totalInterestPaid.toFixed(0)}
                      </div>
                    </div>

                    <div style="background: var(--green-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Thời gian để hết nợ</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                        ${strategy.monthsToPayoff} months
                      </div>
                    </div>

                    <div style="background: var(--purple-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Thẻ đầu tiên đã trả xong</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--purple-700);">
                        Month ${Math.min(
                          ...cardDetails.map((c) => c.monthsPaid)
                        )}
                      </div>
                    </div>
                  </div>

                  <!-- Action Items -->
                  <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
                              border-radius: 0.75rem; border-left: 4px solid var(--indigo-500);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                      ✅ Action Plan for Success
                    </h4>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.875rem; line-height: 1.8;">
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        📌 <strong>Thiết lập thanh toán tự động cho tất cả các thẻ để tránh phí trễ hạn
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        🎯 <strong>Tập trung thanh toán thêm</strong> on ${
                          strategy.strategyType === "avalanche"
                            ? "highest APR card"
                            : "smallest balance card"
                        } each month
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        💰 <strong>Dành các khoản bất ngờ</strong> (hoàn thuế, thưởng) để đẩy nhanh việc trả nợ
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        🔒 <strong>Tạm dừng các giao dịch mới</strong> trên các thẻ đang trả nợ
                      </li>
                      <li style="padding: 0.5rem 0;">
                        📊 <strong>Theo dõi tiến độ hàng tháng</strong> và ăn mừng các cột mốc đạt được (${
                          payoffMilestones.length
                        } thẻ để thanh toán xong!)
                      </li>
                    </ul>
                  </div>

                  <!-- Progress Visualization -->
                  <div style="margin-top: 1.5rem; padding: 1.25rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                      📉 Debt Reduction Progress
                    </h4>
                    ${renderProgressChart(monthlyBreakdown, cardDetails)}
                  </div>
                `;
        }

        function renderProgressChart(monthlyBreakdown, cardDetails) {
          const maxDebt = monthlyBreakdown[0].totalRemaining;
          const milestones = [0, 25, 50, 75, 100];

          return `
                  <div style="position: relative; height: 300px; background: var(--slate-50); border-radius: 0.5rem; padding: 1rem;">
                    <!-- Y-axis labels -->
                    <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 60px; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0;">
                      ${milestones
                        .reverse()
                        .map(
                          (pct) => `
                        <div style="font-size: 0.75rem; color: var(--slate-600); text-align: right; padding-right: 0.5rem;">
                          $${((maxDebt * pct) / 100).toFixed(0)}
                        </div>
                      `
                        )
                        .join("")}
                    </div>

                    <!-- Chart area -->
                    <div style="position: absolute; left: 70px; right: 20px; top: 20px; bottom: 40px;">
                      ${renderDebtLine(monthlyBreakdown, maxDebt)}
                    </div>

                    <!-- X-axis -->
                    <div style="position: absolute; left: 70px; right: 20px; bottom: 10px; display: flex; justify-content: space-between;">
                      ${[0, 25, 50, 75, 100]
                        .map((pct) => {
                          const month = Math.floor(
                            (monthlyBreakdown.length * pct) / 100
                          );
                          return `<div style="font-size: 0.75rem; color: var(--slate-600);">Mo ${month}</div>`;
                        })
                        .join("")}
                    </div>
                  </div>

                  <div style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: var(--slate-600);">
                    🎯 Debt-free date: <strong>${new Date(
                      Date.now() +
                        monthlyBreakdown.length * 30 * 24 * 60 * 60 * 1000
                    ).toLocaleDateString("en-US", {
                      month: "short",
                      year: "numeric",
                    })}</strong>
                  </div>
                `;
        }

        function renderDebtLine(monthlyBreakdown, maxDebt) {
          const points = monthlyBreakdown
            .filter(
              (_, idx) =>
                idx % Math.ceil(monthlyBreakdown.length / 50) === 0 ||
                idx === monthlyBreakdown.length - 1
            )
            .map((month, idx, arr) => {
              const x = (idx / (arr.length - 1)) * 100;
              const y = 100 - (month.totalRemaining / maxDebt) * 100;
              return `${x},${y}`;
            })
            .join(" ");

          return `
                  <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style="overflow: visible;">
                    <!-- Grid lines -->
                    ${[0, 25, 50, 75, 100]
                      .map(
                        (pct) => `
                      <line x1="0" y1="${pct}" x2="100" y2="${pct}" stroke="var(--slate-200)" stroke-width="0.2"/>
                    `
                      )
                      .join("")}

                    <!-- Debt line -->
                    <polyline
                      points="${points}"
                      fill="none"
                      stroke="var(--red-500)"
                      stroke-width="1"
                      vector-effect="non-scaling-stroke"
                    />

                    <!-- Fill area under line -->
                    <polygon
                      points="0,100 ${points} 100,100"
                      fill="var(--red-100)"
                      opacity="0.3"
                    />

                    <!-- End point marker -->
                    <circle
                      cx="${points.split(" ").pop().split(",")[0]}"
                      cy="${points.split(" ").pop().split(",")[1]}"
                      r="1.5"
                      fill="var(--green-600)"
                      vector-effect="non-scaling-stroke"
                    />
                  </svg>
                `;
        }

        function getCardColor(index) {
          const colors = [
            "var(--blue-500)",
            "var(--green-500)",
            "var(--purple-500)",
            "var(--orange-500)",
            "var(--cyan-500)",
            "var(--pink-500)",
            "var(--indigo-500)",
            "var(--red-500)",
            "var(--yellow-500)",
            "var(--teal-500)",
          ];
          return colors[index % colors.length];
        }
      }

      // --- TIME VS MONEY TRADE-OFF CALCULATOR ---
      function renderTimeMoneyCalculator() {
        return `
          <h2 class="calculator-title">⏰ Máy tính Quy đổi Thời gian – Tiền bạc 💰</h2>

          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Ngừng lãng phí tài sản quý giá nhất của bạn: Thời gian!
            </div>
            <p class="explanation-text">
              <strong>Thời gian của bạn có giá trị khác nhau trong từng bối cảnh.</strong> Máy tính này giúp bạn đưa ra quyết định hợp lý bằng cách so sánh các hoạt động dựa trên KHI nào và CÁCH bạn sử dụng thời gian.
            </p>
            <div class="explanation-note">
              <strong>Key Insight:</strong> Giá trị "giờ làm việc" của bạn không phải lúc nào cũng áp dụng được. Thời gian cuối tuần, buổi tối và thời gian rảnh có chi phí cơ hội khác nhau. Chúng tôi sẽ tính quy đổi thực tế cho từng tình huống.
            </div>
          </div>

          <!-- Your Time Profile -->
          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
                      padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; border: 2px solid var(--indigo-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
              💼 Hồ sơ thời gian của bạn
            </h3>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">💰 Mức lương theo giờ ($/hr)</label>
                <input type="number" id="workHourlyRate" class="form-input" placeholder="30" step="1">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Số tiền bạn thực sự kiếm được mỗi giờ khi làm việc
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">⏰ Bạn có thể làm thêm giờ không?</label>
                <select id="canWorkExtra" class="form-select">
                  <option value="yes">Có – Tôi có thể làm thêm/freelance</option>
                  <option value="limited">Hạn chế – Đôi khi có thể</option>
                  <option value="no">Không – Lương cố định/giờ cố định</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">💵 Mức thù lao Freelance / Side Hustle ($/hr)</label>
                <input type="number" id="freelanceRate" class="form-input" placeholder="50" step="5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Để trống nếu không áp dụng
                </div>
              </div>
            </div>

            <div id="profileSummary" class="hidden" style="margin-top: 1rem; padding: 1rem; background: var(--white);
                                                            border-radius: 0.5rem; border-left: 4px solid var(--indigo-500);">
              <!-- Will be populated by JS -->
            </div>
          </div>

          <!-- Scenario Selector -->
          <div style="background: var(--slate-50); padding: 1rem; border-radius: 0.75rem; margin-bottom: 2rem;">
            <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
              🎯 Chọn tình huống của bạn
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
              <button class="scenario-btn active" data-scenario="opportunity">
                💸 Chi phí cơ hội<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Việc này có đáng với thời gian của tôi không?</span>
              </button>
              <button class="scenario-btn" data-scenario="sunk">
                🎬 Trợ lý Chi phí chìm<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Nên dừng hay tiếp tục?</span>
              </button>
              <button class="scenario-btn" data-scenario="diy">
                🔧 Tự làm (DIY) hay Thuê ngoài<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Tự làm hay đi thuê?</span>
              </button>
              <button class="scenario-btn" data-scenario="activity">
                📊 So sánh các hoạt động<br>
                <span style="font-size: 0.75rem; font-weight: normal;">So sánh nhiều lựa chọn</span>
              </button>
            </div>
          </div>

          <!-- Scenario Content -->
          <div id="scenarioContent"></div>

          <!-- Results -->
          <div id="timeMoneyResults" class="results-container hidden"
              style="border-color: var(--indigo-100); background-color: var(--indigo-50); margin-top: 2rem;">
          </div>
        `;
      }

      function setupTimeMoneyCalculator() {
        let activeScenario = "opportunity";
        let workRate = 0;
        let freelanceRate = 0;
        let canWorkExtra = "no";

        const workRateInput = document.getElementById("workHourlyRate");
        const freelanceRateInput = document.getElementById("freelanceRate");
        const canWorkExtraSelect = document.getElementById("canWorkExtra");
        const profileSummary = document.getElementById("profileSummary");

        function updateProfile() {
          workRate = parseFloat(workRateInput.value) || 0;
          freelanceRate = parseFloat(freelanceRateInput.value) || 0;
          canWorkExtra = canWorkExtraSelect.value;

          if (workRate > 0) {
            let opportunityCostText = "";

            if (canWorkExtra === "yes" && freelanceRate > 0) {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $${freelanceRate.toFixed(
                2
              )}/hr (freelance rate)`;
            } else if (canWorkExtra === "yes") {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $${workRate.toFixed(
                2
              )}/hr (work rate - you can work extra)`;
            } else if (canWorkExtra === "limited") {
              opportunityCostText = `<strong>Your opportunity cost:</strong> ~$${(
                workRate * 0.5
              ).toFixed(2)}/hr (limited extra work possible)`;
            } else {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $0/hr for free time (fixed hours - can't work more)`;
            }

            profileSummary.innerHTML = `
              <div style="font-size: 0.875rem; line-height: 1.6;">
                <strong>Work Rate:</strong> $${workRate.toFixed(2)}/hr<br>
                ${
                  freelanceRate > 0
                    ? `<strong>Freelance Rate:</strong> $${freelanceRate.toFixed(
                        2
                      )}/hr<br>`
                    : ""
                }
                ${opportunityCostText}<br><br>
                <div style="background: var(--blue-50); padding: 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem;">
                  <strong>💡 Important Context:</strong><br>
                  ${
                    canWorkExtra === "no"
                      ? '• Your free time has NO monetary opportunity cost (you can\'t work more anyway)<br>• Focus on ENJOYMENT and LONG-TERM VALUE instead<br>• "Saving money" on free time is usually worth it'
                      : canWorkExtra === "limited"
                      ? "• You can sometimes work extra, so time has PARTIAL monetary value<br>• Weekend/evening activities: compare against 50% of work rate<br>• High-value activities might be worth your limited extra work time"
                      : '• You can freely trade time for money (freelance/overtime)<br>• Any activity should beat your freelance rate to be "worth it"<br>• Time spent on low-ROI activities = money left on the table'
                  }
                </div>
              </div>
            `;
            profileSummary.classList.remove("hidden");
          }
        }

        workRateInput.addEventListener("change", updateProfile);
        freelanceRateInput.addEventListener("change", updateProfile);
        canWorkExtraSelect.addEventListener("change", updateProfile); 


        const scenarioBtns = document.querySelectorAll(".scenario-btn");
        scenarioBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            scenarioBtns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            activeScenario = btn.dataset.scenario;
            loadScenario(activeScenario, {
              workRate,
              freelanceRate,
              canWorkExtra,
            });
          });
        });

        
        loadScenario("opportunity", { workRate, freelanceRate, canWorkExtra });

        function loadScenario(scenario, rates) {
          const content = document.getElementById("scenarioContent");

          switch (scenario) {
            case "opportunity":
              content.innerHTML = renderOpportunityCostNew();
              setupOpportunityCostNew(rates);
              break;
            case "sunk":
              content.innerHTML = renderSunkCost();
              setupSunkCost(rates.workRate);
              break;
            case "diy":
              content.innerHTML = renderDIYvsPay();
              setupDIYvsPay(rates.workRate);
              break;
            case "activity":
              content.innerHTML = renderActivityROI();
              setupActivityROI(rates.workRate);
              break;
          }
        }
      }

      function renderOpportunityCostNew() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              💸 Máy tính Chi phí Cơ hội Thông minh
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Thỏa thuận này thực sự giúp tôi tiết kiệm tiền hay tôi đang tự lừa mình?"
            </p>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">⏰ Thời gian bạn sẽ bỏ ra (giờ)</label>
                <input type="number" id="oppTimeSpent" class="form-input" placeholder="1" step="0.25">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Tổng thời gian bao gồm đi lại, chờ đợi, v.v.
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">💰 Tiền bạn sẽ tiết kiệm ($)</label>
                <input type="number" id="oppMoneySaved" class="form-input" placeholder="20" step="1">
              </div>

              <div class="form-group">
                <label class="form-label">📅 Bạn sẽ làm việc này khi nào?</label>
                <select id="oppTiming" class="form-select">
                  <option value="work">During Work Hours</option>
                  <option value="evening">Evening (after work)</option>
                  <option value="weekend">Weekend</option>
                  <option value="flexible">Flexible - anytime</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">🎯 Bạn có thể làm việc khác thay thế không?</label>
                <select id="oppCanWork" class="form-select">
                  <option value="yes">Có – tôi có thể kiếm tiền trong khoảng thời gian này</option>
                  <option value="no">Không – Đây là thời gian rảnh/giải trí</option>
                </select>
              </div>
            </div>

            <button class="btn btn-primary" id="calculateOppNew">
              🧮 Tính CHI PHÍ THỰC SỰ
            </button>
          </div>
        `;
      }

      function setupOpportunityCostNew(rates) {
        document
          .getElementById("calculateOppNew")
          .addEventListener("click", () => {
            if (rates.workRate === 0) {
              alert("Vui lòng thiết lập mức lương theo giờ trước!");
              return;
            }

            const timeSpent = parseFloat(
              document.getElementById("oppTimeSpent").value
            );
            const moneySaved = parseFloat(
              document.getElementById("oppMoneySaved").value
            );
            const timing = document.getElementById("oppTiming").value;
            const canWork = document.getElementById("oppCanWork").value;

            if (isNaN(timeSpent) || isNaN(moneySaved) || timeSpent <= 0) {
              alert("Vui lòng nhập giá trị thời gian và tiền hợp lệ.");
              return;
            }

            let opportunityCost = 0;
            let reasoning = "";
            let context = "";

            if (canWork === "yes") {
              if (rates.canWorkExtra === "yes" && rates.freelanceRate > 0) {
                opportunityCost = rates.freelanceRate * timeSpent;
                reasoning = `You could earn $${rates.freelanceRate.toFixed(
                  2
                )}/hr freelancing`;
                context = "high";
              } else if (rates.canWorkExtra === "yes") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `You could work overtime at $${rates.workRate.toFixed(
                  2
                )}/hr`;
                context = "high";
              } else if (timing === "work") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `This takes away from paid work time`;
                context = "high";
              } else {
                opportunityCost = rates.workRate * 0.3 * timeSpent;
                reasoning = `Limited opportunity to work extra (30% of work rate)`;
                context = "medium";
              }
            } else {
              if (timing === "work") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `This happens during work hours`;
                context = "high";
              } else {
                opportunityCost = 0;
                reasoning = `This is free time you can't monetize anyway`;
                context = "low";
              }
            }

            const netGain = moneySaved - opportunityCost;
            const effectiveRate = timeSpent > 0 ? moneySaved / timeSpent : 0;
            const isWorthIt = netGain > 0;

            displayOpportunityResults({
              timeSpent,
              moneySaved,
              opportunityCost,
              netGain,
              effectiveRate,
              isWorthIt,
              reasoning,
              context,
              timing,
              canWork,
              rates,
            });
          });
      }

      function displayOpportunityResults(data) {
        const resultsDiv = document.getElementById("timeMoneyResults");

        const contextColors = {
          high: {
            bg: "var(--red-50)",
            border: "var(--red-500)",
            text: "var(--red-800)",
          },
          medium: {
            bg: "var(--orange-50)",
            border: "var(--orange-500)",
            text: "var(--orange-800)",
          },
          low: {
            bg: "var(--blue-50)",
            border: "var(--blue-500)",
            text: "var(--blue-800)",
          },
        };

        const color = contextColors[data.context];

        resultsDiv.innerHTML = `
          <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
            ${
              data.isWorthIt
                ? "✅ GOOD DEAL - Worth Your Time!"
                : "❌ BAD DEAL - Not Worth It!"
            }
          </h3>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: var(--blue-100); padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Time Spent</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--blue-700);">
                ${data.timeSpent}h
              </div>
            </div>

            <div style="background: var(--green-100); padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Money Saved</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                $${data.moneySaved.toFixed(2)}
              </div>
            </div>

            <div style="background: ${
              color.bg
            }; padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Opportunity Cost</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: ${
                color.text
              };">
                $${data.opportunityCost.toFixed(2)}
              </div>
              <div style="font-size: 0.7rem; margin-top: 0.25rem; color: ${
                color.text
              };">
                ${data.reasoning}
              </div>
            </div>

            <div style="background: ${
              data.isWorthIt ? "var(--green-100)" : "var(--red-100)"
            }; padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Net Gain/Loss</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: ${
                data.isWorthIt ? "var(--green-700)" : "var(--red-700)"
              };">
                ${data.netGain >= 0 ? "+" : ""}$${data.netGain.toFixed(2)}
              </div>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, ${
            color.bg
          }, var(--indigo-50));
                      padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid ${
                        color.border
                      };">
            <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: ${
              color.text
            };">
              💡 Analysis:
            </h4>
            <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
              <p style="margin-bottom: 1rem;">
                <strong>Your effective rate for this activity:</strong> $${data.effectiveRate.toFixed(
                  2
                )}/hr
              </p>
              
              <p style="margin-bottom: 1rem;">
                <strong>Context matters:</strong> ${data.reasoning}
                ${
                  data.context === "low"
                    ? " Since you can't work during this time anyway, the opportunity cost is effectively $0. Any money saved is pure gain!"
                    : data.context === "medium"
                    ? " You have limited ability to work extra, so we use a conservative 30% of your work rate as opportunity cost."
                    : " You could directly earn money during this time, so opportunity cost equals your earning potential."
                }
              </p>

              ${
                data.isWorthIt
                  ? `
                  <p style="background: var(--green-50); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--green-600);">
                    <strong style="color: var(--green-800);">✅ This is worth it!</strong><br>
                    You're gaining $${data.netGain.toFixed(2)} net. ${
                      data.context === "low"
                        ? "Perfect use of free time that can't be monetized anyway."
                        : `You're earning $${data.effectiveRate.toFixed(
                            2
                          )}/hr, which beats your opportunity cost.`
                    }
                  </p>
                `
                  : `
                  <p style="background: var(--red-50); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--red-600);">
                    <strong style="color: var(--red-800);">❌ Not worth your time!</strong><br>
                    You're losing $${Math.abs(data.netGain).toFixed(2)} net. ${
                      data.canWork === "yes"
                        ? `You could earn $${data.opportunityCost.toFixed(
                            2
                          )} working instead.`
                        : "Your time during work hours is too valuable for this deal."
                    }
                  </p>
                `
              }

              <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem;">
                <strong>🎯 Rule of Thumb:</strong><br>
                ${
                  data.context === "low"
                    ? "• Free time: Almost any money saved is good<br>• Focus on enjoyment and learning value too"
                    : data.context === "medium"
                    ? "• Limited work ability: Save at least $" +
                      (data.rates.workRate * 0.3 * data.timeSpent).toFixed(2) +
                      " for " +
                      data.timeSpent +
                      "h<br>• Consider if it's worth giving up leisure time"
                    : "• Can work freely: Must save more than $" +
                      data.opportunityCost.toFixed(2) +
                      "<br>• Otherwise, work and pay full price instead"
                }
              </div>
            </div>
          </div>
        `;

        resultsDiv.classList.remove("hidden");
      }

      function renderSunkCost() {
        return `
                <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
                  <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                    🎬 Trợ lý Quyết định Chi phí Chìm
                  </h3>
                  <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
                    "Tôi có nên xem xong bộ phim/cuộc gặp mặt/cuốn sách này hay cắt lỗ ngay?"
                  </p>

                  <div class="form-grid">
                    <div class="form-group">
                      <label class="form-label">💵 Money Already Spent ($)</label>
                      <input type="number" id="sunkMoney" class="form-input" placeholder="15" step="1">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                        Giá vé xem phim, phí sự kiện, giá cuốn sách
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">⏰ Time Already Invested (min)</label>
                      <input type="number" id="sunkTime" class="form-input" placeholder="30" step="5">
                    </div>

                    <div class="form-group">
                      <label class="form-label">⏱️ Remaining Time (min)</label>
                      <input type="number" id="remainingTime" class="form-input" placeholder="90" step="5">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                        Bạn sẽ mất thêm bao lâu nếu tiếp tục?
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">😐 Mức độ hài lòng hiện tại (1-10)</label>
                      <input type="range" id="satisfaction" class="form-input" min="1" max="10" value="5"
                            style="padding: 0.5rem 0;">
                      <div style="text-align: center; font-size: 1.5rem; margin-top: 0.5rem;" id="satisfactionEmoji">😐</div>
                      <div style="text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--slate-700);" id="satisfactionValue">5/10</div>
                    </div>
                  </div>

                  <button class="btn btn-danger" id="calculateSunk">
                    🚨 Nên dừng hay tiếp tục?
                  </button>
                </div>
              `;
      }

      function setupSunkCost(hourlyRate) {
        // Satisfaction slider interactivity
        const satisfactionSlider = document.getElementById("satisfaction");
        const satisfactionEmoji = document.getElementById("satisfactionEmoji");
        const satisfactionValue = document.getElementById("satisfactionValue");

        const emojis = [
          "😫",
          "😞",
          "😕",
          "😐",
          "🙂",
          "😊",
          "😃",
          "😄",
          "🤩",
          "🥳",
        ];

        satisfactionSlider.addEventListener("input", (e) => {
          const value = parseInt(e.target.value);
          satisfactionValue.textContent = `${value}/10`;
          satisfactionEmoji.textContent = emojis[value - 1];
        });

        document
          .getElementById("calculateSunk")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Vui lòng thiết lập mức lương theo giờ trước!");
              return;
            }

            const sunkMoney = parseFloat(
              document.getElementById("sunkMoney").value
            );
            const sunkTime = parseFloat(
              document.getElementById("sunkTime").value
            );
            const remainingTime = parseFloat(
              document.getElementById("remainingTime").value
            );
            const satisfaction = parseInt(
              document.getElementById("satisfaction").value
            );

            if (
              isNaN(sunkMoney) ||
              isNaN(sunkTime) ||
              isNaN(remainingTime) ||
              isNaN(satisfaction)
            ) {
              alert("Vui lòng điền đầy đủ tất cả các mục.");
              return;
            }

            // Calculations
            const sunkTimeValue = hourlyRate * (sunkTime / 60);
            const totalSunkCost = sunkMoney + sunkTimeValue;
            const futureCost = hourlyRate * (remainingTime / 60);

            // Suffering penalty: low satisfaction = higher cost
            const sufferingMultiplier = 1 + (10 - satisfaction) * 0.2; // 1.0 to 2.8x
            const adjustedFutureCost = futureCost * sufferingMultiplier;

            const totalLossIfContinue = totalSunkCost + adjustedFutureCost;
            const totalLossIfQuit = totalSunkCost;

            const shouldQuit = adjustedFutureCost > sunkTimeValue * 0.3; // Quit if future cost > 30% of sunk
            const savingsFromQuitting = adjustedFutureCost;

            const resultsDiv = document.getElementById("timeMoneyResults");

            resultsDiv.innerHTML = `
                  <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;
                              color: ${
                                shouldQuit
                                  ? "var(--red-700)"
                                  : "var(--green-700)"
                              };">
                    ${
                      shouldQuit
                        ? "🚨 RECOMMENDATION: QUIT NOW"
                        : "✅ FINISH IT - You're Almost Done"
                    }
                  </h3>

                  <!-- Sunk Cost Visualization -->
                  <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-800); margin-bottom: 1rem;">
                      💸 Cost Breakdown
                    </h4>

                    <div style="margin-bottom: 1.5rem;">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600;">Already Lost (SUNK COST)</span>
                        <span style="font-size: 0.875rem; font-weight: 700; color: var(--red-600);">
                          $${totalSunkCost.toFixed(2)}
                        </span>
                      </div>
                      <div style="background: var(--slate-200); height: 30px; border-radius: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(to right, var(--red-500), var(--red-600));
                                    height: 100%; width: 100%; display: flex; align-items: center; justify-content: center;
                                    color: white; font-weight: 700; font-size: 0.875rem;">
                          GONE FOREVER
                        </div>
                      </div>
                      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--slate-600);">
                        $${sunkMoney} (money) + $${sunkTimeValue.toFixed(
              2
            )} (${sunkTime} min)
                      </div>
                    </div>

                    <div>
                      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600;">Additional Loss if You Stay</span>
                        <span style="font-size: 0.875rem; font-weight: 700; color: var(--orange-600);">
                          $${adjustedFutureCost.toFixed(2)}
                        </span>
                      </div>
                      <div style="background: var(--slate-200); height: 30px; border-radius: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(to right, var(--orange-400), var(--orange-600));
                                    height: 100%; width: ${
                                      (adjustedFutureCost /
                                        totalLossIfContinue) *
                                      100
                                    }%;
                                    display: flex; align-items: center; padding-left: 1rem;
                                    color: white; font-weight: 700; font-size: 0.875rem;">
                          ${
                            adjustedFutureCost > 10
                              ? "$" + adjustedFutureCost.toFixed(0)
                              : ""
                          }
                        </div>
                      </div>
                      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--slate-600);">
                        $${futureCost.toFixed(2)} base + ${(
              (sufferingMultiplier - 1) *
              100
            ).toFixed(0)}% suffering penalty
                      </div>
                    </div>
                  </div>

                  <!-- Comparison Cards -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Quit Option -->
                    <div style="background: linear-gradient(135deg, var(--green-50), var(--emerald-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                  shouldQuit
                                    ? "var(--green-600)"
                                    : "var(--green-300)"
                                };
                                ${
                                  shouldQuit
                                    ? "box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                                    : ""
                                }">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem; text-align: center;">
                        ✅ OPTION A: QUIT NOW
                      </h4>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Loss</div>
                          <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                            $${totalLossIfQuit.toFixed(2)}
                          </div>
                        </div>
                      </div>

                      <div style="font-size: 0.875rem; line-height: 1.6;">
                        <strong style="color: var(--green-800);">✅ You'll save:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>$${savingsFromQuitting.toFixed(
                            2
                          )} in opportunity cost</li>
                          <li>${remainingTime} minutes (${(
              remainingTime / 60
            ).toFixed(1)} hours)</li>
                          <li>Mental sanity (satisfaction: ${satisfaction}/10)</li>
                        </ul>
                      </div>

                      <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem;
                                  font-size: 0.75rem; border-left: 3px solid var(--green-600);">
                        <strong>Better alternatives:</strong>
                        <br>• Work ${remainingTime} min → Earn $${futureCost.toFixed(
              2
            )}
                        <br>• Learn a new skill
                        <br>• Do something enjoyable
                      </div>
                    </div>

                    <!-- Continue Option -->
                    <div style="background: linear-gradient(135deg, var(--red-50), var(--orange-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                  !shouldQuit
                                    ? "var(--blue-600)"
                                    : "var(--red-300)"
                                };">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--red-900); margin-bottom: 1rem; text-align: center;">
                        ${shouldQuit ? "❌" : "✅"} OPTION B: FINISH IT
                      </h4>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Loss</div>
                          <div style="font-size: 2rem; font-weight: 800; color: ${
                            shouldQuit ? "var(--red-600)" : "var(--blue-600)"
                          };">
                            $${totalLossIfContinue.toFixed(2)}
                          </div>
                        </div>
                      </div>

                      <div style="font-size: 0.875rem; line-height: 1.6;">
                        <strong style="color: ${
                          shouldQuit ? "var(--red-800)" : "var(--blue-800)"
                        };">
                          ${
                            shouldQuit
                              ? "❌ Additional cost:"
                              : "✅ Small additional cost:"
                          }
                        </strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>$${adjustedFutureCost.toFixed(
                            2
                          )} opportunity cost</li>
                          <li>${remainingTime} more minutes</li>
                          <li>${
                            satisfaction <= 3
                              ? "High suffering (low satisfaction)"
                              : satisfaction >= 7
                              ? "Minimal suffering (high satisfaction)"
                              : "Moderate suffering"
                          }</li>
                        </ul>
                      </div>

                      ${
                        shouldQuit
                          ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--red-50); border-radius: 0.375rem;
                                    font-size: 0.75rem; border-left: 3px solid var(--red-600);">
                          <strong>⚠️ Sunk Cost Fallacy Alert:</strong>
                          <br>Your brain says: "I paid $${sunkMoney}, I must finish!"
                          <br>Reality: That money is GONE. Staying = throwing $${adjustedFutureCost.toFixed(
                            2
                          )} after bad.
                        </div>
                      `
                          : `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--blue-50); border-radius: 0.375rem;
                                    font-size: 0.75rem; border-left: 3px solid var(--blue-600);">
                          <strong>💡 You're close to the end!</strong>
                          <br>Only ${remainingTime} min left, might as well finish.
                          <br>The additional cost is small relative to sunk cost.
                        </div>
                      `
                      }
                    </div>
                  </div>

                  <!-- Psychology Explanation -->
                  <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                              padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--indigo-600);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                      🧠 Hiểu về Ngụy biện Chi phí Chìm
                    </h4>

                    <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
                      <p style="margin-bottom: 1rem;">
                        <strong>Ngụy biện chi phí chìm là gì?</strong> Ngụy biện chi phí chìm là xu hướng tiếp tục một hoạt động sau khi đã đầu tư (tiền, thời gian, công sức), ngay cả khi việc từ bỏ sẽ mang lại lợi ích hơn.
                      </p>

                      <p style="margin-bottom: 1rem;">
                        <strong>Tại sao não bạn lại làm vậy?</strong> Con người có khuynh hướng tránh thua lỗ - chúng ta ghét “lãng phí” những gì đã bỏ ra. Nhưng chi phí đó đã mất rồi, bất kể quyết định tiếp theo của bạn ra sao.
                      </p>

                      <p style="margin-bottom: 1rem;">
                        <strong>Cách tiếp cận hợp lý:</strong> Bỏ qua hoàn toàn chi phí chìm.
                        Chỉ so sánh: <em>"Từ giờ trở đi tôi sẽ được/ mất gì?"</em>
                      </p>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                        <strong style="color: var(--indigo-700);">Ví dụ thực tế:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>Đọc hết một cuốn sách dở tệ mà bạn đã mua</li>
                          <li>Ngồi xem một bộ phim dở tệ mà bạn đã lỡ mua vé</li>
                          <li>Tiếp tục một dự án kinh doanh thất bại</li>
                          <li>Ở lại trong một mối quan hệ không tốt</li>
                          <li>Ăn đồ mình không thích (đã trả tiền buffet)</li>
                        </ul>
                      </div>

                      <div style="margin-top: 1rem; padding: 1rem; background: var(--indigo-100); border-radius: 0.5rem;">
                        <strong style="color: var(--indigo-900);">🎯 Quyết định của bạn:</strong>
                        <br><br>
                        Sunk cost (GONE): <strong>$${totalSunkCost.toFixed(
                          2
                        )}</strong>
                        <br>Future cost if stay: <strong>$${adjustedFutureCost.toFixed(
                          2
                        )}</strong>
                        <br>Savings if quit: <strong>$${savingsFromQuitting.toFixed(
                          2
                        )}</strong>
                        <br><br>
                        ${
                          shouldQuit
                            ? `<span style="color: var(--red-700); font-weight: 700;">
                            ⚠️ The sunk $${totalSunkCost.toFixed(
                              2
                            )} is already lost. Don't lose another $${adjustedFutureCost.toFixed(
                                2
                              )}!</span>`
                            : `<span style="color: var(--green-700); font-weight: 700;">
                            ✅ You're almost done - the additional $${adjustedFutureCost.toFixed(
                              2
                            )} is worth completing.</span>`
                        }
                      </div>
                    </div>
                  </div>

                  <!-- Action Plan -->
                  ${
                    shouldQuit
                      ? `
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--green-50); border-radius: 0.75rem;
                                border: 2px solid var(--green-400);">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem;">
                        🎯 Action Plan: What to Do Right Now
                      </h4>
                      <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.875rem; line-height: 1.8;">
                        <li><strong>Stand up and leave</strong> (or close the tab/book)</li>
                        <li><strong>Don't feel guilty</strong> - you made the rational choice</li>
                        <li><strong>Use the saved ${remainingTime} min wisely:</strong>
                          <ul style="margin-top: 0.5rem;">
                            <li>Work on a side project (+$${futureCost.toFixed(
                              2
                            )})</li>
                            <li>Learn something valuable (future income boost)</li>
                            <li>Exercise (health = wealth)</li>
                            <li>Quality time with loved ones (priceless)</li>
                          </ul>
                        </li>
                        <li><strong>Learn for next time:</strong> Avoid similar situations (read reviews, leave earlier)</li>
                      </ol>
                    </div>
                  `
                      : ""
                  }
                `;

            resultsDiv.classList.remove("hidden");
          });
      }

      function renderDIYvsPay() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              🔧 DIY vs Pay Professional Calculator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Should I fix it myself or hire someone?"
            </p>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">⏰ DIY Work Time (hours)</label>
                <input type="number" id="diyWorkTime" class="form-input" placeholder="4" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Actual hands-on work
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">📚 Learning Time (hours)</label>
                <input type="number" id="diyLearningTime" class="form-input" placeholder="2" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  YouTube tutorials, reading manuals
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">🎲 Failure Risk (%)</label>
                <input type="number" id="failureRisk" class="form-input" placeholder="30" step="5" min="0" max="100">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Chance you mess it up (0-100%)
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">🔁 Redo Time if Fail (hours)</label>
                <input type="number" id="redoTime" class="form-input" placeholder="2" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Time to fix your mistakes
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">💰 Professional Cost ($)</label>
                <input type="number" id="professionalCost" class="form-input" placeholder="200" step="10">
              </div>

              <div class="form-group">
                <label class="form-label">🛠️ Materials Cost ($)</label>
                <input type="number" id="materialsCost" class="form-input" placeholder="50" step="10">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Same for both DIY and pro
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">😰 Stress Level (1-10)</label>
                <input type="range" id="stressLevel" class="form-input" min="1" max="10" value="7"
                       style="padding: 0.5rem 0;">
                <div style="text-align: center; font-size: 1.5rem; margin-top: 0.5rem;" id="stressEmoji">😰</div>
                <div style="text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--slate-700);" id="stressValue">7/10</div>
              </div>

              <div class="form-group">
                <label class="form-label">😊 Do You Enjoy This?</label>
                <select id="enjoymentLevel" class="form-select">
                  <option value="0">😫 Hate it (-$50 value)</option>
                  <option value="1">😐 Neutral ($0)</option>
                  <option value="2">🙂 Mild enjoyment (+$25)</option>
                  <option value="3">😃 Love it (+$50)</option>
                </select>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Leisure value of DIY
                </div>
              </div>
            </div>

            <button class="btn btn-warning" id="calculateDIY">
              🔨 Calculate: DIY or Hire?
            </button>
          </div>
        `;
      }

      function setupDIYvsPay(hourlyRate) {
        // Stress slider interactivity
        const stressSlider = document.getElementById("stressLevel");
        const stressEmoji = document.getElementById("stressEmoji");
        const stressValue = document.getElementById("stressValue");

        const stressEmojis = [
          "😊",
          "🙂",
          "😐",
          "😕",
          "😟",
          "😰",
          "😫",
          "😱",
          "🤯",
          "💀",
        ];

        stressSlider.addEventListener("input", (e) => {
          const value = parseInt(e.target.value);
          stressValue.textContent = `${value}/10`;
          stressEmoji.textContent = stressEmojis[value - 1];
        });

        document
          .getElementById("calculateDIY")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Vui lòng thiết lập mức lương theo giờ trước!");
              return;
            }

            const diyWorkTime = parseFloat(
              document.getElementById("diyWorkTime").value
            );
            const diyLearningTime = parseFloat(
              document.getElementById("diyLearningTime").value
            );
            const failureRisk =
              parseFloat(document.getElementById("failureRisk").value) / 100;
            const redoTime = parseFloat(
              document.getElementById("redoTime").value
            );
            const professionalCost = parseFloat(
              document.getElementById("professionalCost").value
            );
            const materialsCost = parseFloat(
              document.getElementById("materialsCost").value
            );
            const stressLevel = parseInt(
              document.getElementById("stressLevel").value
            );
            const enjoymentLevel = parseInt(
              document.getElementById("enjoymentLevel").value
            );

            if (
              isNaN(diyWorkTime) ||
              isNaN(diyLearningTime) ||
              isNaN(failureRisk) ||
              isNaN(redoTime) ||
              isNaN(professionalCost) ||
              isNaN(materialsCost)
            ) {
              alert("Vui lòng điền đầy đủ thông tin.");
              return;
            }

            // DIY Calculations
            const totalDIYTime = diyWorkTime + diyLearningTime;
            const diyTimeCost = totalDIYTime * hourlyRate;
            const failureCost =
              failureRisk * (redoTime * hourlyRate + materialsCost); // Risk of wasting time + materials
            const stressCost = (stressLevel / 10) * 50; // High stress = up to $50 penalty

            const enjoymentValues = [-50, 0, 25, 50];
            const enjoymentValue = enjoymentValues[enjoymentLevel];

            const totalDIYCost =
              diyTimeCost +
              failureCost +
              stressCost +
              materialsCost -
              enjoymentValue;

            // Professional Calculations
            const professionalTimeSaved = totalDIYTime;
            const professionalOpportunityCost =
              professionalTimeSaved * hourlyRate - professionalCost; // Negative if pro is more expensive than your time saved
            const totalProfessionalCost =
              professionalCost + materialsCost - professionalOpportunityCost;

            const shouldHirePro = totalProfessionalCost < totalDIYCost;
            const savings = Math.abs(totalDIYCost - totalProfessionalCost);

            const resultsDiv = document.getElementById("timeMoneyResults");

            resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;
                        color: ${
                          shouldHirePro ? "var(--blue-700)" : "var(--green-700)"
                        };">
              ${
                shouldHirePro
                  ? "💼 HIRE THE PROFESSIONAL"
                  : "🔨 DO IT YOURSELF (DIY)"
              }
            </h3>

            <!-- Comparison Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
              <!-- DIY Option -->
              <div style="background: linear-gradient(135deg, var(--orange-50), var(--red-50));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            !shouldHirePro
                              ? "var(--green-600)"
                              : "var(--orange-300)"
                          };
                          ${
                            !shouldHirePro
                              ? "box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                              : ""
                          }">
                <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--orange-900); margin-bottom: 1rem; text-align: center;">
                  ${!shouldHirePro ? "✅" : "❌"} DIY OPTION
                </h4>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Cost</div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${
                      !shouldHirePro ? "var(--green-600)" : "var(--orange-600)"
                    };">
                      $${totalDIYCost.toFixed(2)}
                    </div>
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                  <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700); margin-bottom: 0.75rem;">
                    Cost Breakdown:
                                </h5>
                                <div style="font-size: 0.8rem; line-height: 1.8; color: var(--slate-600);">
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>⏰ Time cost (${totalDIYTime}h)</span>
                                    <span style="font-weight: 600;">$${diyTimeCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>🎲 Failure risk (${(
                                      failureRisk * 100
                                    ).toFixed(0)}%)</span>
                                    <span style="font-weight: 600;">$${failureCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>😰 Stress penalty</span>
                                    <span style="font-weight: 600;">$${stressCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>🛠️ Materials</span>
                                    <span style="font-weight: 600;">$${materialsCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; ${
                                    enjoymentValue >= 0
                                      ? "color: var(--green-600);"
                                      : "color: var(--red-600);"
                                  }">
                                    <span>😊 Enjoyment value</span>
                                    <span style="font-weight: 600;">${
                                      enjoymentValue >= 0 ? "+" : ""
                                    }$${enjoymentValue.toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>

                              <div style="font-size: 0.875rem; line-height: 1.6;">
                                <strong style="color: ${
                                  !shouldHirePro
                                    ? "var(--green-800)"
                                    : "var(--orange-800)"
                                };">
                                  ${!shouldHirePro ? "✅ Pros:" : "⚠️ Risks:"}
                                </strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                  ${
                                    !shouldHirePro
                                      ? `
                                    <li>Save $${savings.toFixed(
                                      2
                                    )} vs hiring pro</li>
                                    <li>Learn a new skill (${diyLearningTime}h investment)</li>
                                    ${
                                      enjoymentValue > 0
                                        ? "<li>Enjoyable activity (+$" +
                                          enjoymentValue +
                                          ")</li>"
                                        : ""
                                    }
                                  `
                                      : `
                                    <li>Lose $${savings.toFixed(
                                      2
                                    )} vs hiring pro</li>
                                    <li>${(failureRisk * 100).toFixed(
                                      0
                                    )}% chance of failure</li>
                                    <li>High stress (${stressLevel}/10)</li>
                                    <li>${totalDIYTime}h of your valuable time</li>
                                  `
                                  }
                                </ul>
                              </div>

                              <div style="margin-top: 1rem; padding: 0.75rem; background: ${
                                !shouldHirePro
                                  ? "var(--green-50)"
                                  : "var(--orange-100)"
                              }; 
                                          border-radius: 0.375rem; font-size: 0.75rem; border-left: 3px solid ${
                                            !shouldHirePro
                                              ? "var(--green-600)"
                                              : "var(--orange-600)"
                                          };">
                                ${
                                  !shouldHirePro
                                    ? `
                                  <strong>🎯 When DIY makes sense:</strong>
                                  <br>✅ You enjoy it (leisure value)
                                  <br>✅ Skill has future value (recurring task)
                                  <br>✅ Pro cost > 2× your time value
                                `
                                    : `
                                  <strong>⚠️ DIY Warning:</strong>
                                  <br>You're paying $${totalDIYCost.toFixed(
                                    2
                                  )} to do something
                                  <br>a pro would do for $${professionalCost.toFixed(
                                    2
                                  )}.
                                `
                                }
                              </div>
                            </div>

                            <!-- Professional Option -->
                            <div style="background: linear-gradient(135deg, var(--blue-50), var(--cyan-50)); 
                                        padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                          shouldHirePro
                                            ? "var(--blue-600)"
                                            : "var(--blue-300)"
                                        };
                                        ${
                                          shouldHirePro
                                            ? "box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);"
                                            : ""
                                        }">
                              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 1rem; text-align: center;">
                                ${shouldHirePro ? "✅" : "❌"} HIRE PROFESSIONAL
                              </h4>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <div style="text-align: center;">
                                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Cost</div>
                                  <div style="font-size: 2rem; font-weight: 800; color: ${
                                    shouldHirePro
                                      ? "var(--blue-600)"
                                      : "var(--red-600)"
                                  };">
                                    $${totalProfessionalCost.toFixed(2)}
                                  </div>
                                </div>
                              </div>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700); margin-bottom: 0.75rem;">
                                  Cost Breakdown:
                                </h5>
                                <div style="font-size: 0.8rem; line-height: 1.8; color: var(--slate-600);">
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>💼 Service fee</span>
                                    <span style="font-weight: 600;">$${professionalCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>🛠️ Materials</span>
                                    <span style="font-weight: 600;">$${materialsCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; color: var(--green-600);">
                                    <span>⏰ Time saved (${professionalTimeSaved}h)</span>
                                    <span style="font-weight: 600;">-$${Math.abs(
                                      professionalOpportunityCost
                                    ).toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>

                              <div style="font-size: 0.875rem; line-height: 1.6;">
                                <strong style="color: ${
                                  shouldHirePro
                                    ? "var(--blue-800)"
                                    : "var(--red-800)"
                                };">
                                  ${
                                    shouldHirePro
                                      ? "✅ Benefits:"
                                      : "⚠️ Downside:"
                                  }
                                </strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                  ${
                                    shouldHirePro
                                      ? `
                                    <li>Save $${savings.toFixed(2)} net</li>
                                    <li>Zero stress 😊</li>
                                    <li>Guaranteed quality</li>
                                    <li>Save ${professionalTimeSaved}h ($${(
                                          professionalTimeSaved * hourlyRate
                                        ).toFixed(2)} value)</li>
                                    <li>Use time for higher-value work</li>
                                  `
                                      : `
                                    <li>Pay $${savings.toFixed(
                                      2
                                    )} more than DIY</li>
                                    <li>No skill gained</li>
                                    <li>Less satisfying if you enjoy DIY</li>
                                  `
                                  }
                                </ul>
                              </div>

                              <div style="margin-top: 1rem; padding: 0.75rem; background: ${
                                shouldHirePro
                                  ? "var(--blue-50)"
                                  : "var(--slate-100)"
                              }; 
                                          border-radius: 0.375rem; font-size: 0.75rem; border-left: 3px solid ${
                                            shouldHirePro
                                              ? "var(--blue-600)"
                                              : "var(--slate-400)"
                                          };">
                                ${
                                  shouldHirePro
                                    ? `
                                  <strong>💡 Best use of saved ${professionalTimeSaved}h:</strong>
                                  <br>• Work/freelance → Earn $${(
                                    professionalTimeSaved * hourlyRate
                                  ).toFixed(2)}
                                  <br>• Learn high-value skill
                                  <br>• Quality time with family
                                  <br>• Rest & recharge
                                `
                                    : `
                                  <strong>When to hire a pro:</strong>
                                  <br>• Pro cost < Your time value
                                  <br>• High failure risk
                                  <br>• You hate the task
                                  <br>• One-time job (no skill reuse)
                                `
                                }
                              </div>
                            </div>
                          </div>

                          <!-- Decision Matrix -->
                          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50)); 
                                      padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--indigo-600); margin-bottom: 2rem;">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                              🎯 The Math Behind Your Decision
                            </h4>

                            <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; margin-bottom: 1rem;">
                              <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: center;">
                                <span><strong>Your hourly rate:</strong></span>
                                <span style="font-weight: 700; color: var(--indigo-700);">$${hourlyRate.toFixed(
                                  2
                                )}/hr</span>
                                
                                <span>DIY time investment:</span>
                                <span>${totalDIYTime}h = $${diyTimeCost.toFixed(
              2
            )}</span>
                                
                                <span>Professional fee:</span>
                                <span>$${professionalCost.toFixed(2)}</span>
                                
                                <span style="padding-top: 0.5rem; border-top: 2px solid var(--slate-200);"><strong>Break-even analysis:</strong></span>
                                <span style="padding-top: 0.5rem; border-top: 2px solid var(--slate-200);"></span>
                                
                                <span>DIY makes sense if pro cost ></span>
                                <span style="font-weight: 700; color: var(--green-600);">$${(
                                  diyTimeCost * 2
                                ).toFixed(2)}</span>
                              </div>
                            </div>

                            <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
                              <p style="margin-bottom: 0.5rem;">
                                <strong>Rule of thumb:</strong> Hire a pro if the cost is less than 2× your time value.
                              </p>
                              <p style="margin-bottom: 0.5rem;">
                                In your case: Pro costs $${professionalCost.toFixed(
                                  2
                                )}, your time is worth $${diyTimeCost.toFixed(
              2
            )}.
                              </p>
                              <p>
                                <strong>Verdict:</strong> 
                                ${
                                  shouldHirePro
                                    ? `Pro is ${(
                                        (1 -
                                          totalProfessionalCost /
                                            totalDIYCost) *
                                        100
                                      ).toFixed(0)}% cheaper than DIY. ✅`
                                    : `DIY is ${(
                                        (1 -
                                          totalDIYCost /
                                            totalProfessionalCost) *
                                        100
                                      ).toFixed(0)}% cheaper than pro. ${
                                        enjoymentValue > 0
                                          ? "(Plus you enjoy it!) 🎉"
                                          : ""
                                      }`
                                }
                              </p>
                            </div>
                          </div>

                          <!-- Special Cases -->
                          <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem;">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              🤔 When Should You Override This Recommendation?
                            </h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--green-600);">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--green-800); margin-bottom: 0.75rem;">
                                  ✅ DIY Even If More Expensive:
                                </h5>
                                <ul style="font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                                  <li>You genuinely enjoy the work</li>
                                  <li>Skill has future value (recurring task)</li>
                                  <li>Learning experience worth the cost</li>
                                  <li>Emergency & can't wait for pro</li>
                                  <li>Simple task, low failure risk</li>
                                </ul>
                              </div>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--blue-600);">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--blue-800); margin-bottom: 0.75rem;">
                                  💼 Hire Pro Even If DIY Cheaper:
                                </h5>
                                <ul style="font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                                  <li>Dangerous work (electrical, structural)</li>
                                  <li>Warranty/insurance required</li>
                                  <li>High stakes (can't afford failure)</li>
                                  <li>One-time job (no skill reuse)</li>
                                  <li>You're already overwhelmed</li>
                                </ul>
                              </div>
                            </div>
                          </div>

                          <!-- Real Examples -->
                          <div style="margin-top: 1.5rem; background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              📊 Real-World Examples (Based on $${hourlyRate.toFixed(
                                2
                              )}/hr rate)
                            </h4>
                            
                            <div style="overflow-x: auto;">
                              <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                <thead>
                                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Task</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">DIY Time</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Pro Cost</th>
                                    <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Verdict</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  ${[
                                    {
                                      task: "Oil change",
                                      diyTime: 0.5,
                                      proCost: 40,
                                      verdict:
                                        hourlyRate * 0.5 < 40 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Lawn mowing",
                                      diyTime: 1,
                                      proCost: 50,
                                      verdict:
                                        hourlyRate * 1 < 50 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "House cleaning",
                                      diyTime: 3,
                                      proCost: 120,
                                      verdict:
                                        hourlyRate * 3 < 120 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Assemble IKEA furniture",
                                      diyTime: 2,
                                      proCost: 80,
                                      verdict:
                                        hourlyRate * 2 < 80 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Paint room",
                                      diyTime: 8,
                                      proCost: 400,
                                      verdict:
                                        hourlyRate * 8 < 400 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Fix leaky faucet",
                                      diyTime: 1.5,
                                      proCost: 150,
                                      verdict:
                                        hourlyRate * 1.5 < 150 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Tax filing",
                                      diyTime: 4,
                                      proCost: 200,
                                      verdict:
                                        hourlyRate * 4 < 200 ? "DIY" : "Pro",
                                    },
                                  ]
                                    .map((item) => {
                                      const diyValue =
                                        hourlyRate * item.diyTime;
                                      const shouldDIY = diyValue < item.proCost;
                                      return `
                                      <tr style="border-bottom: 1px solid var(--slate-200);">
                                        <td style="padding: 0.75rem;">${
                                          item.task
                                        }</td>
                                        <td style="padding: 0.75rem; text-align: right;">${
                                          item.diyTime
                                        }h ($${diyValue.toFixed(0)})</td>
                                        <td style="padding: 0.75rem; text-align: right;">$${
                                          item.proCost
                                        }</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                          <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: 600;
                                                      background: ${
                                                        shouldDIY
                                                          ? "var(--green-100)"
                                                          : "var(--blue-100)"
                                                      };
                                                      color: ${
                                                        shouldDIY
                                                          ? "var(--green-800)"
                                                          : "var(--blue-800)"
                                                      };">
                                            ${shouldDIY ? "🔨 DIY" : "💼 Hire"}
                                          </span>
                                        </td>
                                      </tr>
                                    `;
                                    })
                                    .join("")}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        `;

            resultsDiv.classList.remove("hidden");
          });
      }

      function renderActivityROI() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              📊 Activity ROI Comparator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Compare multiple activities to find the best use of your time"
            </p>

            <div id="activitiesContainer">
              <!-- Activities will be added here -->
            </div>

            <button class="btn btn-secondary" id="addActivityBtn" style="margin-bottom: 1rem;">
              ➕ Add Activity to Compare
            </button>

            <button class="btn btn-success" id="compareActivitiesBtn">
              📊 Compare & Rank Activities
            </button>
          </div>
        `;
      }

      function setupActivityROI(hourlyRate) {
        let activities = [];
        let activityCounter = 1;

        // Add initial activities
        addActivity();
        addActivity();

        function addActivity() {
          const id = activityCounter++;
          activities.push({
            id,
            name: `Activity ${id}`,
            timeHours: 0,
            moneyImpact: 0,
            type: "cost", // cost or income
            futureValue: 0,
            enjoyment: 5,
          });
          renderActivities();
        }

        function removeActivity(id) {
          activities = activities.filter((a) => a.id !== id);
          renderActivities();
        }

        function renderActivities() {
          const container = document.getElementById("activitiesContainer");

          container.innerHTML = activities
            .map(
              (activity) => `
            <div class="activity-row" data-activity-id="${activity.id}" style="
              background: var(--slate-50); 
              padding: 1rem; 
              border-radius: 0.5rem; 
              margin-bottom: 1rem;
              border: 2px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Activity Name</label>
                  <input type="text" class="form-input activity-name" value="${
                    activity.name
                  }" 
                        placeholder="e.g. Freelance work, Cook at home">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Time (hours)</label>
                  <input type="number" class="form-input activity-time" value="${
                    activity.timeHours
                  }" 
                        placeholder="2" step="0.25">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Type</label>
                  <select class="form-select activity-type">
                    <option value="income" ${
                      activity.type === "income" ? "selected" : ""
                    }>💰 Earn Money</option>
                    <option value="cost" ${
                      activity.type === "cost" ? "selected" : ""
                    }>💸 Save Money</option>
                    <option value="expense" ${
                      activity.type === "expense" ? "selected" : ""
                    }>❌ Costs Money</option>
                    <option value="learning" ${
                      activity.type === "learning" ? "selected" : ""
                    }>📚 Learning</option>
                    <option value="leisure" ${
                      activity.type === "leisure" ? "selected" : ""
                    }>😊 Leisure</option>
                  </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">$ Amount</label>
                  <input type="number" class="form-input activity-money" value="${
                    activity.moneyImpact
                  }" 
                        placeholder="50" step="10">
                </div>
                
                <button class="remove-activity-btn" data-activity-id="${
                  activity.id
                }" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.5rem 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                ">
                  🗑️
                </button>
              </div>

              <!-- Additional fields for learning/leisure -->
              ${
                activity.type === "learning"
                  ? `
                <div style="margin-top: 1rem;">
                  <label class="form-label">Future Monthly Income Boost ($)</label>
                  <input type="number" class="form-input activity-future" value="${activity.futureValue}" 
                        placeholder="500" step="50">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                    Expected income increase from this skill
                  </div>
                </div>
              `
                  : activity.type === "leisure"
                  ? `
                <div style="margin-top: 1rem;">
                  <label class="form-label">Enjoyment Value (1-10)</label>
                  <input type="range" class="form-input activity-enjoyment" min="1" max="10" value="${
                    activity.enjoyment
                  }" 
                        style="padding: 0.5rem 0;">
                  <div style="text-align: center; font-size: 0.875rem; margin-top: 0.25rem;">
                    <strong>${activity.enjoyment}/10</strong> - Worth $${(
                      activity.enjoyment * 10
                    ).toFixed(0)} in mental health value
                  </div>
                </div>
              `
                  : ""
              }
            </div>
          `
            )
            .join("");

          // Attach event listeners
          document.querySelectorAll(".remove-activity-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const activityId = parseInt(e.target.dataset.activityId);
              if (activities.length > 1) {
                removeActivity(activityId);
              } else {
                alert("Bạn phải thêm ít nhất một hoạt động.");
              }
            });
          });

          // Update activity data on input change
          document.querySelectorAll(".activity-row").forEach((row) => {
            const activityId = parseInt(row.dataset.activityId);
            const activity = activities.find((a) => a.id === activityId);

            row
              .querySelector(".activity-name")
              .addEventListener("input", (e) => {
                activity.name = e.target.value;
              });

            row
              .querySelector(".activity-time")
              .addEventListener("input", (e) => {
                activity.timeHours = parseFloat(e.target.value) || 0;
              });

            row
              .querySelector(".activity-type")
              .addEventListener("change", (e) => {
                activity.type = e.target.value;
                renderActivities(); // Re-render to show/hide additional fields
              });

            row
              .querySelector(".activity-money")
              .addEventListener("input", (e) => {
                activity.moneyImpact = parseFloat(e.target.value) || 0;
              });

            const futureInput = row.querySelector(".activity-future");
            if (futureInput) {
              futureInput.addEventListener("input", (e) => {
                activity.futureValue = parseFloat(e.target.value) || 0;
              });
            }

            const enjoymentInput = row.querySelector(".activity-enjoyment");
            if (enjoymentInput) {
              enjoymentInput.addEventListener("input", (e) => {
                activity.enjoyment = parseInt(e.target.value);
                renderActivities(); // Update enjoyment display
              });
            }
          });
        }

        document
          .getElementById("addActivityBtn")
          .addEventListener("click", () => {
            if (activities.length < 10) {
              addActivity();
            } else {
              alert("Chỉ được phép tối đa 10 hoạt động.");
            }
          });

        document
          .getElementById("compareActivitiesBtn")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Vui lòng thiết lập mức lương theo giờ trước!");
              return;
            }

            if (
              activities.some((a) => a.timeHours === 0 || a.name.trim() === "")
            ) {
              alert("Vui lòng điền đầy đủ tên và thời gian cho tất cả các hoạt động.");
              return;
            }

            // Calculate ROI for each activity
            const results = activities.map((activity) => {
              const timeCost = activity.timeHours * hourlyRate;
              let netValue = 0;
              let roi = 0;
              let description = "";

              switch (activity.type) {
                case "income":
                  netValue = activity.moneyImpact - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Earn $${activity.moneyImpact} in ${activity.timeHours}h`;
                  break;

                case "cost":
                  netValue = activity.moneyImpact - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Save $${activity.moneyImpact} in ${activity.timeHours}h`;
                  break;

                case "expense":
                  netValue = -(activity.moneyImpact + timeCost);
                  roi = (netValue / timeCost) * 100;
                  description = `Costs $${activity.moneyImpact} + ${activity.timeHours}h time`;
                  break;

                case "learning":
                  // Assume skill pays off over 12 months
                  const futureGainPV = activity.futureValue * 6; // 6 months of benefit (conservative)
                  netValue = futureGainPV - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Learn → +$${activity.futureValue}/mo future income`;
                  break;

                case "leisure":
                  const leisureValue = activity.enjoyment * 10; // $10 per enjoyment point
                  netValue = leisureValue - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Leisure (${activity.enjoyment}/10 enjoyment)`;
                  break;
              }

              return {
                ...activity,
                timeCost,
                netValue,
                roi,
                description,
                hourlyRate: netValue / activity.timeHours,
              };
            });

            // Sort by ROI (highest first)
            results.sort((a, b) => b.roi - a.roi);

            displayActivityResults(results, hourlyRate);
          });

        function displayActivityResults(results, hourlyRate) {
          const resultsDiv = document.getElementById("timeMoneyResults");

          const medals = [
            "🥇",
            "🥈",
            "🥉",
            "4️⃣",
            "5️⃣",
            "6️⃣",
            "7️⃣",
            "8️⃣",
            "9️⃣",
            "🔟",
          ];

          resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
              🏆 Activity Rankings (Best to Worst ROI)
            </h3>

            <!-- Top 3 Podium -->
            ${
              results.length >= 3
                ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                ${[1, 0, 2]
                  .map((idx) => {
                    const activity = results[idx];
                    const colors = [
                      {
                        bg: "linear-gradient(135deg, var(--yellow-50), var(--yellow-100))",
                        border: "var(--yellow-500)",
                        text: "var(--yellow-800)",
                      },
                      {
                        bg: "linear-gradient(135deg, var(--slate-50), var(--slate-100))",
                        border: "var(--slate-400)",
                        text: "var(--slate-700)",
                      },
                      {
                        bg: "linear-gradient(135deg, var(--orange-50), var(--orange-100))",
                        border: "var(--orange-500)",
                        text: "var(--orange-800)",
                      },
                    ];
                    const rank = idx === 0 ? 1 : idx === 1 ? 0 : 2; // Gold=0, Silver=1, Bronze=2
                    const color = colors[rank];

                    return `
                                  <div style="background: ${
                                    color.bg
                                  }; padding: 1.5rem; border-radius: 0.75rem; 
                                              border: 3px solid ${
                                                color.border
                                              }; text-align: center;
                                              ${
                                                rank === 0
                                                  ? "transform: scale(1.05); box-shadow: 0 8px 16px rgba(234, 179, 8, 0.3);"
                                                  : ""
                                              }">
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                                      ${medals[idx]}
                                    </div>
                                    <h4 style="font-size: 1rem; font-weight: 700; color: ${
                                      color.text
                                    }; margin-bottom: 0.75rem;">
                                      ${activity.name}
                                    </h4>
                                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">ROI</div>
                                      <div style="font-size: 1.75rem; font-weight: 800; color: ${
                                        activity.roi >= 0
                                          ? "var(--green-600)"
                                          : "var(--red-600)"
                                      };">
                                        ${
                                          activity.roi >= 0 ? "+" : ""
                                        }${activity.roi.toFixed(0)}%
                                      </div>
                                    </div>
                                    <div style="font-size: 0.8rem; line-height: 1.5; color: ${
                                      color.text
                                    };">
                                      <strong>Net Value:</strong> ${
                                        activity.netValue >= 0 ? "+" : ""
                                      }$${activity.netValue.toFixed(0)}<br>
                                      <strong>Effective Rate:</strong> $${activity.hourlyRate.toFixed(
                                        0
                                      )}/hr<br>
                                      <strong>Time:</strong> ${
                                        activity.timeHours
                                      }h
                                    </div>
                                  </div>
                                `;
                  })
                  .join("")}
                            </div>
                          `
                : ""
            }
                          
                          <!-- Detailed Table -->
                          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              📊 Complete Analysis
                            </h4>
                            
                            <div style="overflow-x: auto;">
                              <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Rank</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Activity</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Time</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Time Cost</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">$ Impact</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Net Value</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Effective Rate</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">ROI</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  ${results
                                    .map((activity, idx) => {
                                      const isGood = activity.roi >= 0;
                                      const rowColor = isGood
                                        ? "background: var(--green-50);"
                                        : idx < 3
                                        ? "background: var(--yellow-50);"
                                        : "background: var(--red-50);";

                                      return `
                                      <tr style="border-bottom: 1px solid var(--slate-200); ${rowColor}">
                                        <td style="padding: 0.75rem; font-weight: 700; font-size: 1.2rem;">
                                          ${medals[idx]} #${idx + 1}
                                        </td>
                                        <td style="padding: 0.75rem;">
                                          <div style="font-weight: 600; color: var(--slate-800);">${
                                            activity.name
                                          }</div>
                                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                                            ${activity.description}
                                          </div>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right;">${
                                          activity.timeHours
                                        }h</td>
                                        <td style="padding: 0.75rem; text-align: right; color: var(--red-600);">
                                          -$${activity.timeCost.toFixed(0)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                          ${getMoneyImpactDisplay(activity)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 700; color: ${
                                          isGood
                                            ? "var(--green-600)"
                                            : "var(--red-600)"
                                        };">
                                          ${
                                            activity.netValue >= 0 ? "+" : ""
                                          }$${activity.netValue.toFixed(0)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                          $${activity.hourlyRate.toFixed(0)}/hr
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 700; font-size: 1rem; color: ${
                                          isGood
                                            ? "var(--green-700)"
                                            : "var(--red-700)"
                                        };">
                                          ${
                                            activity.roi >= 0 ? "+" : ""
                                          }${activity.roi.toFixed(0)}%
                                        </td>
                                      </tr>
                                    `;
                                    })
                                    .join("")}
                                </tbody>
                              </table>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem; font-size: 0.875rem;">
                              <strong>📌 How to read this table:</strong><br>
                              • <strong>Time Cost:</strong> Opportunity cost of your time (${
                                activity.timeHours
                              }h × $${hourlyRate}/hr)<br>
                              • <strong>Net Value:</strong> Total gain/loss after accounting for your time<br>
                              • <strong>Effective Rate:</strong> What you're "paying yourself" for this activity<br>
                              • <strong>ROI:</strong> Return on investment of your time<br><br>
                              <span style="color: var(--green-700); font-weight: 600;">✅ Positive ROI = Good use of time</span><br>
                              <span style="color: var(--red-700); font-weight: 600;">❌ Negative ROI = Losing money vs other options</span>
                            </div>
                          </div>
                          
                          <!-- Key Insights -->
                          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50)); 
                                      padding: 1.5rem; border-radius: 0.75rem; margin-top: 2rem; border-left: 4px solid var(--indigo-600);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                              💡 Key Insights & Recommendations
                            </h4>
                            
                            ${generateInsights(results, hourlyRate)}
                          </div>
                          
                          <!-- Visualization -->
                          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; margin-top: 2rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              📈 ROI Comparison Chart
                            </h4>
                            ${renderROIChart(results)}
                          </div>
                        `;

          resultsDiv.classList.remove("hidden");
        }

        function getMoneyImpactDisplay(activity) {
          switch (activity.type) {
            case "income":
              return `<span style="color: var(--green-600);">+$${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "cost":
              return `<span style="color: var(--green-600);">Save $${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "expense":
              return `<span style="color: var(--red-600);">-$${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "learning":
              return `<span style="color: var(--purple-600);">+$${activity.futureValue.toFixed(
                0
              )}/mo</span>`;
            case "leisure":
              return `<span style="color: var(--blue-600);">${activity.enjoyment}/10 😊</span>`;
          }
        }

        function generateInsights(results, hourlyRate) {
          const bestActivity = results[0];
          const worstActivity = results[results.length - 1];
          const goodActivities = results.filter((a) => a.roi >= 0);
          const badActivities = results.filter((a) => a.roi < 0);

          let insights = "";

          // Best activity
          insights += `
                          <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--green-600);">
                            <strong style="color: var(--green-800);">🥇 Best Activity: ${
                              bestActivity.name
                            }</strong><br>
                            <span style="font-size: 0.875rem;">
                              This is your highest ROI activity at ${bestActivity.roi.toFixed(
                                0
                              )}%. 
                              You're effectively earning $${bestActivity.hourlyRate.toFixed(
                                0
                              )}/hr, which is 
                              ${(
                                (bestActivity.hourlyRate / hourlyRate - 1) *
                                100
                              ).toFixed(0)}% better than your base rate.
                            </span>
                          </div>
                        `;

          // Worst activity warning
          if (worstActivity.roi < -50) {
            insights += `
                            <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--red-600);">
                              <strong style="color: var(--red-800);">⚠️ Avoid: ${
                                worstActivity.name
                              }</strong><br>
                              <span style="font-size: 0.875rem;">
                                This activity has a ${worstActivity.roi.toFixed(
                                  0
                                )}% ROI, meaning you're losing 
                                $${Math.abs(worstActivity.netValue).toFixed(
                                  0
                                )}. Consider eliminating or outsourcing this.
                              </span>
                            </div>
                          `;
          }

          // Summary stats
          insights += `
                          <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: var(--indigo-800);">📊 Summary Statistics:</strong><br>
                            <div style="font-size: 0.875rem; line-height: 1.8; margin-top: 0.5rem;">
                              • <span style="color: var(--green-700); font-weight: 600;">${
                                goodActivities.length
                              } positive ROI activities</span> 
                                (total value: +$${goodActivities
                                  .reduce((sum, a) => sum + a.netValue, 0)
                                  .toFixed(0)})<br>
                              • <span style="color: var(--red-700); font-weight: 600;">${
                                badActivities.length
                              } negative ROI activities</span> 
                                (total loss: -$${Math.abs(
                                  badActivities.reduce(
                                    (sum, a) => sum + a.netValue,
                                    0
                                  )
                                ).toFixed(0)})<br>
                              • Your time is worth <strong>$${hourlyRate.toFixed(
                                2
                              )}/hr</strong> - any activity below this rate is a net loss<br>
                              • Best use of time: <strong>${
                                bestActivity.name
                              }</strong> at $${bestActivity.hourlyRate.toFixed(
            0
          )}/hr
                            </div>
                          </div>
                        `;

          return insights;
        }

        function renderROIChart(results) {
          const maxROI = Math.max(...results.map((a) => Math.abs(a.roi)));

          return `
                          <div style="position: relative;">
                            ${results
                              .map((activity, idx) => {
                                const isPositive = activity.roi >= 0;
                                const barWidth =
                                  (Math.abs(activity.roi) / maxROI) * 100;

                                return `
                                <div style="margin-bottom: 1rem;">
                                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700);">
                                      ${medals[idx]} ${activity.name}
                                    </div>
                                    <div style="font-size: 0.875rem; font-weight: 700; color: ${
                                      isPositive
                                        ? "var(--green-600)"
                                        : "var(--red-600)"
                                    };">
                                      ${
                                        activity.roi >= 0 ? "+" : ""
                                      }${activity.roi.toFixed(0)}%
                                    </div>
                                  </div>
                                  <div style="background: var(--slate-200); height: 30px; border-radius: 0.375rem; overflow: hidden; position: relative;">
                                    <div style="background: ${
                                      isPositive
                                        ? "linear-gradient(to right, var(--green-400), var(--green-600))"
                                        : "linear-gradient(to right, var(--red-400), var(--red-600))"
                                    }; 
                                                height: 100%; width: ${barWidth}%; 
                                                display: flex; align-items: center; padding-left: ${
                                                  barWidth > 20 ? "1rem" : "0"
                                                }; 
                                                color: white; font-weight: 700; font-size: 0.875rem; transition: width 0.5s;">
                                      ${
                                        barWidth > 20
                                          ? `$${activity.hourlyRate.toFixed(
                                              0
                                            )}/hr`
                                          : ""
                                      }
                                    </div>
                                    ${
                                      barWidth <= 20
                                        ? `
                                      <div style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); 
                                                  font-weight: 700; font-size: 0.875rem; color: var(--slate-600);">
                                        $${activity.hourlyRate.toFixed(0)}/hr
                                      </div>
                                    `
                                        : ""
                                    }
                                  </div>
                                </div>
                              `;
                              })
                              .join("")}
                          </div>
                          
                          <div style="margin-top: 1.5rem; text-align: center; font-size: 0.875rem; color: var(--slate-600);">
                            📏 Baseline: Your time is worth <strong>$${hourlyRate.toFixed(
                              2
                            )}/hour</strong>
                          </div>
                        `;
        }
      }

      // --- Initialize the app when the page loads ---
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>

